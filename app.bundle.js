var AudioGen=function(q){"use strict";class N{constructor(e,t){this.audioContext=e,this.poolManager=t,this.nodes={oscillators:[],gains:[],lfos:[],filter:null,mixer:null},this.isPlaying=!1,this.voiceId="drone"}start(e){if(this.isPlaying)return;const{frequency:t,detune:s,voices:i,filterFreq:a}=e;this.stop(),this.nodes.filter=this.audioContext.createBiquadFilter(),this.nodes.filter.type="lowpass",this.nodes.filter.frequency.value=a,this.nodes.filter.Q.value=5,this.nodes.mixer=this.audioContext.createGain(),this.nodes.mixer.gain.value=.3;for(let n=0;n<i;n++){let o,r,c,h;this.poolManager?(o=this.poolManager.pools.oscillator.acquireOscillator(`${this.voiceId}_osc_${n}`,{type:"sawtooth",frequency:t*(1+(Math.random()-.5)*s/100)}),r=this.poolManager.pools.gain.acquireGain(`${this.voiceId}_gain_${n}`,1/i),c=this.poolManager.pools.oscillator.acquireOscillator(`${this.voiceId}_lfo_${n}`,{type:"sine",frequency:.1+Math.random()*.2}),h=this.poolManager.pools.gain.acquireGain(`${this.voiceId}_lfoGain_${n}`,5)):(o=this.audioContext.createOscillator(),r=this.audioContext.createGain(),c=this.audioContext.createOscillator(),h=this.audioContext.createGain(),o.type="sawtooth",o.frequency.value=t*(1+(Math.random()-.5)*s/100),r.gain.value=1/i,c.frequency.value=.1+Math.random()*.2,h.gain.value=5),c.connect(h),h.connect(o.frequency),o.connect(r),r.connect(this.nodes.filter),this.poolManager||(c.start(),o.start()),this.nodes.oscillators.push(o),this.nodes.gains.push(r),this.nodes.lfos.push({lfo:c,lfoGain:h})}this.nodes.filter.connect(this.nodes.mixer),this.isPlaying=!0}stop(){if(this.poolManager?(this.nodes.oscillators.forEach((e,t)=>{this.poolManager.pools.oscillator.release(e)}),this.nodes.gains.forEach((e,t)=>{this.poolManager.pools.gain.release(e)}),this.nodes.lfos.forEach(({lfo:e,lfoGain:t},s)=>{this.poolManager.pools.oscillator.release(e),this.poolManager.pools.gain.release(t)})):(this.nodes.oscillators.forEach(e=>{try{e.stop(),e.disconnect()}catch{}}),this.nodes.lfos.forEach(({lfo:e})=>{try{e.stop(),e.disconnect()}catch{}}),this.nodes.gains.forEach(e=>{if(e)try{e.disconnect()}catch{}})),this.nodes.filter)try{this.nodes.filter.disconnect()}catch{}if(this.nodes.mixer)try{this.nodes.mixer.disconnect()}catch{}this.nodes.oscillators=[],this.nodes.gains=[],this.nodes.lfos=[],this.nodes.filter=null,this.nodes.mixer=null,this.isPlaying=!1}updateParameter(e,t){switch(e){case"frequency":this.nodes.oscillators.forEach((s,i)=>{const a=parseFloat(document.getElementById("droneDetune").value);s.frequency.value=t*(1+(Math.random()-.5)*a/100)});break;case"filterFreq":this.nodes.filter&&(this.nodes.filter.frequency.value=t);break;case"volume":this.nodes.mixer&&(this.nodes.mixer.gain.value=t);break}}getOutputNode(){return this.nodes.mixer}updateTempo(e){this.nodes.lfos&&this.nodes.lfos.length>0&&this.nodes.lfos.forEach(t=>{t&&t.frequency&&(t.frequency.value=e.beatsPerSecond*.25)})}}class L{constructor(e,t){this.audioContext=e,this.scheduler=null,this.drumVoices=0,this.maxDrumVoices=20,this.activeVoices=0,this.maxVoices=100,this.performanceThrottle=1,this.isPlaying=!1}start(e,t){if(this.isPlaying)return;const{pattern:s,tempo:i,density:a,variation:n,swing:o,snareRush:r,ghostNotes:c,hihatSpeed:h}=e;this.masterNodes=t,this.currentParams=e;const l=6e4/(i*8);let d=0;const u=this.getDrumPatterns()[s];this.scheduler=setInterval(()=>{const g=d%u.length,m=d%2*o*l*.2,f=(Math.random()-.5)*n*10+m;if(u.kick[g]&&Math.random()<a){const x=u.kick[g]*1.2;setTimeout(()=>this.playKick(this.audioContext.currentTime,n,x),f)}if(u.snare[g]&&Math.random()<a*.9){const x=u.snare[g]*1.1;setTimeout(()=>{this.playSnare(this.audioContext.currentTime,n,x),Math.random()<r&&g%4===0&&this.triggerSnareRush(n)},f)}if(d%(16/h)===0&&u.hihat[g%16]&&Math.random()<a*.8){const x=u.hihat[g%16]*.8,M=g%4===2&&Math.random()<.3;setTimeout(()=>this.playHiHat(this.audioContext.currentTime,n,x,M),f)}if(u.perc&&u.perc[g]&&Math.random()<a*.7&&(Math.random()<.5?setTimeout(()=>this.playRimshot(this.audioContext.currentTime,n),f):setTimeout(()=>this.playClap(this.audioContext.currentTime,n),f)),Math.random()<c){const x=f+Math.random()*l;setTimeout(()=>{const M=Math.random();M<.4?this.playKick(this.audioContext.currentTime,n*2,.5):M<.7?this.playSnare(this.audioContext.currentTime,n*2,.4):this.playHiHat(this.audioContext.currentTime,n*2,.35)},x)}d++},l),this.isPlaying=!0}stop(){this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),this.isPlaying=!1}connectToMaster(e){this.masterNodes&&(e.connect(this.masterNodes.dryGain),e.connect(this.masterNodes.convolver),e.connect(this.masterNodes.delay))}getDrumPatterns(){return{techno:{length:16,kick:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hihat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],perc:[0,0,0,.5,0,0,0,0,0,.3,0,0,0,0,.4,0]},breakbeat:{length:32,kick:[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0],hihat:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],perc:[0,0,.3,0,0,0,0,.5,0,0,0,0,.4,0,0,0,0,.3,0,0,0,0,0,0,.6,0,0,0,0,0,0,0]},jungle:{length:32,kick:[1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0],snare:[0,0,0,0,0,0,1,0,0,1,0,0,1,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0],hihat:[1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,0],perc:[0,.5,0,0,.3,0,0,0,0,0,.4,0,0,.6,0,0,.3,0,0,0,0,.5,0,0,0,0,0,.4,0,0,0,0]},idm:{length:32,kick:[1,0,0,.5,0,0,1,0,0,.3,0,0,.7,0,0,0,.8,0,0,0,.4,0,0,0,1,0,.2,0,0,0,.6,0],snare:[0,0,0,0,.8,0,0,.3,0,0,.5,0,1,0,0,.2,0,0,.6,0,.9,0,0,0,.4,0,0,.7,0,0,1,0],hihat:[.5,.3,.8,.2,.6,.4,.9,.1,.7,.3,.5,.8,.4,.6,.2,.9],perc:[.7,0,0,.4,0,.6,0,0,.5,0,0,.3,0,0,.8,0,0,.4,0,0,.7,0,.3,0,0,.5,0,0,.6,0,0,.4]},gabber:{length:16,kick:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],snare:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],hihat:[0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],perc:[0,0,0,.8,0,0,0,.6,0,0,0,.7,0,0,0,.5]},trap:{length:32,kick:[1,0,0,0,0,0,0,0,0,0,0,0,.8,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,.6,0],snare:[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],hihat:[1,.3,.5,.3,1,.3,.5,.3,1,.3,.5,.3,1,.3,.5,.3],perc:[0,0,0,0,0,.6,0,0,0,0,0,0,0,0,.7,0,0,0,0,0,.5,0,0,0,0,0,0,0,0,0,0,.8]}}}triggerSnareRush(e){const t=4+Math.floor(Math.random()*12),s=20+Math.random()*40,i=Math.min(t,8);for(let a=0;a<i;a++)setTimeout(()=>{const n=.3*(1-a/i);this.playSnare(this.audioContext.currentTime,e*2,n)},a*s)}playKick(e,t,s=1){if(this.drumVoices>=this.maxDrumVoices||this.activeVoices>this.maxVoices)return;this.drumVoices++,this.activeVoices++,this.performanceThrottle<.5&&(s*=.7);const i=this.audioContext.createGain();i.gain.value=s;const a=this.audioContext.createOscillator();a.type="sine",a.frequency.setValueAtTime(55,e),a.frequency.exponentialRampToValueAtTime(25,e+.3);const n=this.audioContext.createGain();n.gain.setValueAtTime(1,e),n.gain.exponentialRampToValueAtTime(.01,e+.25);const o=this.audioContext.createOscillator();o.type="triangle",o.frequency.setValueAtTime(85,e),o.frequency.exponentialRampToValueAtTime(45,e+.08);const r=this.audioContext.createGain();r.gain.setValueAtTime(.8,e),r.gain.exponentialRampToValueAtTime(.01,e+.1);const c=this.audioContext.createOscillator();c.type="square",c.frequency.value=1500+Math.random()*500;const h=this.audioContext.createGain();h.gain.setValueAtTime(.5,e),h.gain.exponentialRampToValueAtTime(.01,e+.005);const l=this.audioContext.createBiquadFilter();l.type="highpass",l.frequency.value=1e3;const d=this.audioContext.createBuffer(1,512,this.audioContext.sampleRate),p=d.getChannelData(0);for(let f=0;f<512;f++)p[f]=(Math.random()*2-1)*Math.pow(1-f/512,2);const u=this.audioContext.createBufferSource();u.buffer=d;const g=this.audioContext.createGain();g.gain.value=.3;const m=this.audioContext.createBiquadFilter();m.type="peaking",m.frequency.value=80,m.Q.value=.7,m.gain.value=6,a.connect(n),n.connect(m),o.connect(r),r.connect(m),c.connect(l),l.connect(h),h.connect(m),u.connect(g),g.connect(m),m.connect(i),this.connectToMaster(i),a.start(e),o.start(e),c.start(e),u.start(e),a.stop(e+.3),o.stop(e+.15),c.stop(e+.01),setTimeout(()=>{this.activeVoices--,this.drumVoices--},300)}playSnare(e,t,s=.8){if(this.drumVoices>=this.maxDrumVoices||this.activeVoices>this.maxVoices)return;this.drumVoices++,this.activeVoices++,this.performanceThrottle<.7&&(s*=.8);const i=this.audioContext.createGain();i.gain.value=s;const a=.15,n=this.audioContext.createBuffer(2,this.audioContext.sampleRate*a,this.audioContext.sampleRate);for(let u=0;u<2;u++){const g=n.getChannelData(u);for(let m=0;m<g.length;m++){const f=Math.random()*2-1,x=Math.pow(1-m/g.length,.5);g[m]=f*x}}const o=this.audioContext.createBufferSource();o.buffer=n;const r=this.audioContext.createBiquadFilter();r.type="highpass",r.frequency.value=200+t*100;const c=this.audioContext.createBiquadFilter();c.type="bandpass",c.frequency.value=5e3+Math.random()*2e3,c.Q.value=2;const h=this.audioContext.createGain();h.gain.setValueAtTime(1,e),h.gain.exponentialRampToValueAtTime(.01,e+a);const l=[200,250,300];l.forEach((u,g)=>{const m=this.audioContext.createOscillator();m.type="sine",m.frequency.value=u*(1+t*.1);const f=this.audioContext.createGain();f.gain.setValueAtTime(.5/l.length,e),f.gain.exponentialRampToValueAtTime(.01,e+.03+g*.01),m.connect(f),f.connect(i),m.start(e),m.stop(e+.1)});const d=this.audioContext.createOscillator();d.type="triangle",d.frequency.value=1e3;const p=this.audioContext.createGain();p.gain.setValueAtTime(.7,e),p.gain.exponentialRampToValueAtTime(.01,e+.002),o.connect(r),r.connect(c),c.connect(h),h.connect(i),d.connect(p),p.connect(i),this.connectToMaster(i),o.start(e),d.start(e),d.stop(e+.005),setTimeout(()=>{this.activeVoices--,this.drumVoices--},150)}playHiHat(e,t,s=.5,i=!1){if(this.drumVoices>=this.maxDrumVoices||this.activeVoices>this.maxVoices)return;this.drumVoices++,this.activeVoices++,this.performanceThrottle<.5&&(s*=.7);const a=i?.3:.05,n=this.audioContext.createGain();n.gain.value=s;const o=this.performanceThrottle<.5?[8e3,12e3]:[6e3,8e3,1e4,12e3,14e3];o.forEach(h=>{const l=this.audioContext.createBufferSource(),d=Math.min(a+.05,.1),p=this.audioContext.createBuffer(1,this.audioContext.sampleRate*d,this.audioContext.sampleRate),u=p.getChannelData(0);for(let x=0;x<u.length;x++){const M=Math.sin(x*h/this.audioContext.sampleRate*2*Math.PI);u[x]=(Math.random()*2-1)*M}l.buffer=p,l.loop=!0;const g=this.audioContext.createBiquadFilter();g.type="bandpass",g.frequency.value=h*(1+(Math.random()-.5)*t*.1),g.Q.value=30;const m=this.audioContext.createGain(),f=i?[.8/o.length,a*.8,.01,a]:[1/o.length,.001,.01,a];m.gain.setValueAtTime(0,e),m.gain.linearRampToValueAtTime(f[0],e+f[1]),m.gain.exponentialRampToValueAtTime(f[2],e+f[3]),l.connect(g),g.connect(m),m.connect(n),l.start(e),l.stop(e+a+.05)});const r=this.audioContext.createOscillator();r.type="square",r.frequency.value=15e3+Math.random()*2e3;const c=this.audioContext.createGain();c.gain.setValueAtTime(.1,e),c.gain.exponentialRampToValueAtTime(.01,e+a*.3),r.connect(c),c.connect(n),this.connectToMaster(n),r.start(e),r.stop(e+a),setTimeout(()=>{this.activeVoices--,this.drumVoices--},a*1e3+50)}playRimshot(e,t){if(this.drumVoices>=this.maxDrumVoices||this.activeVoices>this.maxVoices)return;this.drumVoices++,this.activeVoices++;const s=.6,i=this.audioContext.createOscillator();i.frequency.value=800+Math.random()*200,i.type="square";const a=this.audioContext.createGain();a.gain.setValueAtTime(.4*s,e),a.gain.exponentialRampToValueAtTime(.01,e+.01);const n=this.audioContext.createOscillator();n.frequency.value=400,n.type="sine";const o=this.audioContext.createGain();o.gain.setValueAtTime(.3*s,e),o.gain.exponentialRampToValueAtTime(.01,e+.04);const r=this.audioContext.createBiquadFilter();r.type="bandpass",r.frequency.value=1200,r.Q.value=10;const c=this.audioContext.createBuffer(1,1024,this.audioContext.sampleRate),h=c.getChannelData(0);for(let u=0;u<1024;u++)h[u]=(Math.random()*2-1)*Math.pow(1-u/1024,2);const l=this.audioContext.createBufferSource();l.buffer=c;const d=this.audioContext.createGain();d.gain.value=.3*s;const p=this.audioContext.createGain();i.connect(a),a.connect(p),n.connect(r),r.connect(o),o.connect(p),l.connect(d),d.connect(p),this.connectToMaster(p),i.start(e),n.start(e),l.start(e),i.stop(e+.01),n.stop(e+.05),setTimeout(()=>{this.activeVoices--,this.drumVoices--},50)}playClap(e,t){if(this.drumVoices>=this.maxDrumVoices||this.activeVoices>this.maxVoices)return;this.drumVoices++,this.activeVoices++;const s=.5,i=this.audioContext.createGain(),a=this.performanceThrottle<.7?2:3+Math.floor(Math.random()*2),n=.01;for(let c=0;c<a;c++){const h=e+c*n,l=this.audioContext.createBuffer(1,512,this.audioContext.sampleRate),d=l.getChannelData(0);for(let f=0;f<512;f++)d[f]=Math.random()*2-1;const p=this.audioContext.createBufferSource();p.buffer=l;const u=this.audioContext.createBiquadFilter();u.type="bandpass",u.frequency.value=1500+Math.random()*1e3,u.Q.value=5;const g=this.audioContext.createGain(),m=s*(c===a-1?1:.3+Math.random()*.3);g.gain.setValueAtTime(m,h),g.gain.exponentialRampToValueAtTime(.01,h+.02),p.connect(u),u.connect(g),g.connect(i),p.start(h)}const o=this.audioContext.createOscillator();o.frequency.value=200;const r=this.audioContext.createGain();r.gain.setValueAtTime(.2*s,e),r.gain.exponentialRampToValueAtTime(.01,e+.03),o.connect(r),r.connect(i),this.connectToMaster(i),o.start(e),o.stop(e+.05),setTimeout(()=>{this.activeVoices--,this.drumVoices--},100)}updateParameter(e,t){}setPerformanceThrottle(e){this.performanceThrottle=e}updateTempo(e){if(this.masterTempo=e,this.isPlaying&&this.scheduler){const t=this.currentParams;t&&(t.tempo=e.bpm,this.stop(),this.start(t,this.masterNodes))}}}class G{constructor(){this.history=[],this.maxHistory=16}shouldTrigger(e,t=.5){let s=e;const i=this.history.slice(-4).filter(n=>n).length;s*=Math.pow(1-t,i);const a=Math.random()<s;return this.history.push(a),this.history.length>this.maxHistory&&this.history.shift(),a}shouldTriggerAntiPattern(e,t=4){if(this.history.length<t*2)return Math.random()<e;const s=this.history.slice(-t),i=this.history.slice(-t*2,-t),n=s.every((r,c)=>r===i[c])?e*.3:e,o=Math.random()<n;return this.history.push(o),this.history.length>this.maxHistory&&this.history.shift(),o}reset(){this.history=[]}}class V{constructor(e=1){this.order=e,this.transitions=new Map,this.currentState=[]}train(e){for(let t=0;t<e.length-this.order;t++){const s=e.slice(t,t+this.order).join(","),i=e[t+this.order];this.transitions.has(s)||this.transitions.set(s,new Map);const a=this.transitions.get(s);a.set(i,(a.get(i)||0)+1)}this.currentState.length===0&&e.length>=this.order&&(this.currentState=e.slice(0,this.order))}next(){const e=this.currentState.join(","),t=this.transitions.get(e);if(!t||t.size===0){const n=Math.random()>.5?1:0;return this.updateState(n),n}const s=Array.from(t.values()).reduce((n,o)=>n+o,0);let i=Math.random()*s;for(const[n,o]of t)if(i-=o,i<=0)return this.updateState(n),n;const a=Array.from(t.keys())[0];return this.updateState(a),a}updateState(e){this.currentState.push(e),this.currentState.length>this.order&&this.currentState.shift()}reset(){this.currentState=[]}}class A{static generate(e,t,s=0){if(t>e&&(t=e),t===0)return new Array(e).fill(0);if(t===e)return new Array(e).fill(1);let i=[],a=[],n=[],o=e-t;n.push(t);let r=0;for(;n[r]>1;)a.push(Math.floor(o/n[r])),n.push(o%n[r]),o=n[r],r++;a.push(o);const c=function(h){if(h===-1)i.push(0);else if(h===-2)i.push(1);else{for(let l=0;l<a[h];l++)c(h-1);n[h]!==0&&c(h-2)}};return c(r),s!==0&&(s=s%e,i=i.slice(s).concat(i.slice(0,s))),i}static generateComplement(e,t,s=0){return this.generate(e,t,s).map(a=>1-a)}static generateVariations(e,t,s=4){const i=[];for(let a=0;a<s;a++)i.push(this.generate(e,t,a));return i}}class H{constructor(){this.tracks=new Map,this.globalStep=0}addTrack(e,t,s=1){this.tracks.set(e,{pattern:t,speed:s,position:0,accumulator:0})}removeTrack(e){this.tracks.delete(e)}step(){const e={};for(const[t,s]of this.tracks){for(s.accumulator+=s.speed;s.accumulator>=1;)s.accumulator-=1,s.position=(s.position+1)%s.pattern.length;const i=Math.floor(s.position);e[t]=s.pattern[i]}return this.globalStep++,e}reset(){this.globalStep=0;for(const e of this.tracks.values())e.position=0,e.accumulator=0}static generatePolyrhythm(e,t){const s=[],i=this.lcm(e);for(const a of e){const n=[];for(let o=0;o<t;o++)n.push(o%a===0?1:0);s.push(n)}return{patterns:s,lcm:i}}static gcd(e,t){return t?this.gcd(t,e%t):e}static lcm(e){return e.reduce((t,s)=>t*s/this.gcd(t,s))}}class D{constructor(e,t){this.audioContext=e,this.poolManager=t,this.scheduler=null,this.isPlaying=!1,this.performanceThrottle=1,this.drumSamples=new Map,this.sampleMapping={kick:null,snare:null,hihat:null,openhat:null,clap:null,ride:null,crash:null,perc1:null,perc2:null,perc3:null},this.useSamples=!1,this.probabilityTriggers={kick:new G,snare:new G,hihat:new G,perc:new G},this.markovChains={kick:new V(2),snare:new V(2),hihat:new V(1)},this.polyrhythm=new H,this.trainMarkovChains(),this.patternMode="euclidean",this.euclideanPatterns={},this.traditionalPatterns=this.getTraditionalPatterns()}setupFileInput(){const e=document.getElementById("drumKitFileInput");console.log("setupFileInput called, fileInput element:",e),e&&!e.hasAttribute("data-listener-attached")?(e.setAttribute("data-listener-attached","true"),console.log("Adding change event listener to file input"),e.addEventListener("change",async t=>{console.log("File input change event triggered");const s=Array.from(t.target.files);console.log("Files selected:",s),await this.loadDrumKit(s)})):e?console.log("File input already has listener attached"):console.error("drumKitFileInput element not found!")}async loadDrumKit(e){console.log("loadDrumKit called with",e.length,"files"),this.drumSamples.clear(),Object.keys(this.sampleMapping).forEach(t=>{this.sampleMapping[t]=null});for(const t of e)if(console.log("Processing file:",t.name,"Type:",t.type,"Size:",t.size),t.type.startsWith("audio/")||t.name.match(/\.(wav|mp3|ogg|m4a|flac)$/i))try{const s=await t.arrayBuffer();console.log("ArrayBuffer loaded, size:",s.byteLength);const i=await this.audioContext.decodeAudioData(s);console.log("Audio decoded successfully, duration:",i.duration,"seconds");const a=t.name.toLowerCase().replace(/\.[^/.]+$/,"");this.drumSamples.set(a,i),this.autoMapSample(a),console.log(`Loaded drum sample: ${a}, total samples:`,this.drumSamples.size)}catch(s){console.error(`Failed to load drum sample ${t.name}:`,s)}else console.warn("Skipping non-audio file:",t.name);console.log("Final sample mapping:",this.sampleMapping),console.log("Total loaded samples:",this.drumSamples.size),this.updateSampleMappingUI()}autoMapSample(e){const t=e.toLowerCase();t.includes("kick")||t.includes("bd")||t.includes("bass")?this.sampleMapping.kick||(this.sampleMapping.kick=e):t.includes("snare")||t.includes("sd")?this.sampleMapping.snare||(this.sampleMapping.snare=e):t.includes("hihat")||t.includes("hh")||t.includes("hat")?t.includes("open")||t.includes("oh")?this.sampleMapping.openhat||(this.sampleMapping.openhat=e):this.sampleMapping.hihat||(this.sampleMapping.hihat=e):t.includes("clap")||t.includes("cp")?this.sampleMapping.clap||(this.sampleMapping.clap=e):t.includes("ride")||t.includes("rd")?this.sampleMapping.ride||(this.sampleMapping.ride=e):t.includes("crash")||t.includes("cr")?this.sampleMapping.crash||(this.sampleMapping.crash=e):(t.includes("perc")||t.includes("pc"))&&(this.sampleMapping.perc1?this.sampleMapping.perc2?this.sampleMapping.perc3||(this.sampleMapping.perc3=e):this.sampleMapping.perc2=e:this.sampleMapping.perc1=e)}updateSampleMappingUI(){const e=document.getElementById("drumKitStatus"),t=document.getElementById("sampleMappingDisplay"),s=document.getElementById("mappingList");if(e){const i=this.drumSamples.size,a=Object.values(this.sampleMapping).filter(n=>n!==null).length;e.textContent=i>0?`${i} samples loaded, ${a} mapped`:"No samples loaded"}if(t&&s)if(this.drumSamples.size>0){t.style.display="block",s.innerHTML="";for(const[a,n]of Object.entries(this.sampleMapping))if(n){const o=document.createElement("div");o.className="mapping-item",o.innerHTML=`
                            <span>${a}:</span>
                            <span class="mapping-name">${n}</span>
                        `,s.appendChild(o)}const i=[];for(const[a]of this.drumSamples)Object.values(this.sampleMapping).includes(a)||i.push(a);if(i.length>0){const a=document.createElement("div");a.style.marginTop="0.5rem",a.style.paddingTop="0.5rem",a.style.borderTop="1px solid #333",a.innerHTML='<span style="color: #666;">Unmapped samples:</span>',s.appendChild(a),i.forEach(n=>{const o=document.createElement("div");o.className="mapping-item",o.innerHTML=`<span style="color: #666;">${n}</span>`,s.appendChild(o)})}}else t.style.display="none"}trainMarkovChains(){this.markovChains.kick.train([1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]),this.markovChains.kick.train([1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0]),this.markovChains.kick.train([1,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0]),this.markovChains.snare.train([0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0]),this.markovChains.snare.train([0,0,1,0,1,0,0,1,0,0,1,0,1,0,0,0]),this.markovChains.snare.train([0,1,0,0,1,0,1,0,0,1,0,0,1,0,1,0]),this.markovChains.hihat.train([1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0]),this.markovChains.hihat.train([1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1]),this.markovChains.hihat.train([1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1])}start(e,t){if(this.isPlaying)return;this.masterNodes=t,this.params=e,this.useSamples=e.useSamples||!1,this.generatePatterns();const s=6e4/(e.tempo*4);let i=0;this.scheduler=setInterval(()=>{this.processStep(i),i++},s),this.isPlaying=!0}generatePatterns(){const{patternMode:e="euclidean",euclideanSteps:t=16,kickPulses:s=4,snarePulses:i=2,hihatPulses:a=8,polyLengths:n=[3,4,5]}=this.params;switch(this.patternMode=e,e){case"euclidean":this.euclideanPatterns={kick:A.generate(t,s),snare:A.generate(t,i,4),hihat:A.generate(t,a),perc:A.generateComplement(t,Math.floor(t/3))};break;case"polyrhythm":this.polyrhythm.reset(),this.polyrhythm.addTrack("kick",new Array(n[0]).fill(0).map((o,r)=>r===0?1:0),1),this.polyrhythm.addTrack("snare",new Array(n[1]).fill(0).map((o,r)=>r===0?1:0),1),this.polyrhythm.addTrack("hihat",new Array(n[2]).fill(0).map((o,r)=>r%2===0?1:0),1);break}}processStep(e){const{density:t,variation:s,swing:i,probability:a,humanize:n=.5,patternLength:o=16}=this.params,r=e%o;let c={};switch(this.patternMode){case"traditional":const d=this.traditionalPatterns[this.params.pattern||"techno"];c={kick:d.kick[r%d.kick.length],snare:d.snare[r%d.snare.length],hihat:d.hihat[r%d.hihat.length],perc:d.perc?d.perc[r%d.perc.length]:0};break;case"euclidean":c={kick:this.euclideanPatterns.kick[r],snare:this.euclideanPatterns.snare[r],hihat:this.euclideanPatterns.hihat[r],perc:this.euclideanPatterns.perc[r]};break;case"markov":c={kick:this.markovChains.kick.next(),snare:this.markovChains.snare.next(),hihat:this.markovChains.hihat.next(),perc:Math.random()<.1?1:0};break;case"polyrhythm":c=this.polyrhythm.step();break}if(a){const d=c.kick&&this.probabilityTriggers.kick.shouldTriggerAntiPattern(t*.9),p=c.snare&&this.probabilityTriggers.snare.shouldTriggerAntiPattern(t*.8),u=c.hihat&&this.probabilityTriggers.hihat.shouldTrigger(t*.7);c.kick=d?c.kick:0,c.snare=p?c.snare:0,c.hihat=u?c.hihat:0}const h=r%2*i*.2,l=(Math.random()-.5)*s*10+h;if(c.kick){const d=c.kick*(1-n*.3+Math.random()*n*.3);setTimeout(()=>this.playKick(d),l)}if(c.snare){const d=c.snare*(1-n*.3+Math.random()*n*.3);setTimeout(()=>this.playSnare(d),l)}if(c.hihat){const d=c.hihat*(1-n*.2+Math.random()*n*.2),p=r%4===2&&Math.random()<.3;setTimeout(()=>this.playHihat(d,p),l)}c.perc&&c.perc>0&&setTimeout(()=>this.playPerc(c.perc),l)}playKick(e){if(this.useSamples&&this.sampleMapping.kick)this.playSample(this.sampleMapping.kick,e);else{const t=this.audioContext.currentTime,s=this.audioContext.createOscillator(),i=this.audioContext.createGain();s.frequency.setValueAtTime(60,t),s.frequency.exponentialRampToValueAtTime(30,t+.1),i.gain.setValueAtTime(e,t),i.gain.exponentialRampToValueAtTime(.01,t+.5),s.connect(i),this.connectToMaster(i),s.start(t),s.stop(t+.5)}}playSample(e,t){const s=this.drumSamples.get(e);if(!s)return;const i=this.audioContext.createBufferSource();i.buffer=s;const a=this.params.samplePitch||1,n=(this.params.pitchVariation||0)/100,o=a+(Math.random()-.5)*n*.5;i.playbackRate.value=o;const r=this.audioContext.createGain();r.gain.value=t,i.connect(r),this.connectToMaster(r),i.start()}playSnare(e){if(this.useSamples&&this.sampleMapping.snare){this.playSample(this.sampleMapping.snare,e);return}const t=this.audioContext.currentTime,s=this.audioContext.createBuffer(1,4096,this.audioContext.sampleRate),i=s.getChannelData(0);for(let h=0;h<4096;h++)i[h]=Math.random()*2-1;const a=this.audioContext.createBufferSource();a.buffer=s;const n=this.audioContext.createBiquadFilter();n.type="highpass",n.frequency.value=1e3;const o=this.audioContext.createGain();o.gain.setValueAtTime(e*.8,t),o.gain.exponentialRampToValueAtTime(.01,t+.2);const r=this.audioContext.createOscillator();r.frequency.value=200;const c=this.audioContext.createGain();c.gain.setValueAtTime(e*.5,t),c.gain.exponentialRampToValueAtTime(.01,t+.1),a.connect(n),n.connect(o),r.connect(c),this.connectToMaster(o),this.connectToMaster(c),a.start(t),r.start(t),r.stop(t+.1)}playHihat(e,t){if(this.useSamples){if(t&&this.sampleMapping.openhat){this.playSample(this.sampleMapping.openhat,e);return}else if(!t&&this.sampleMapping.hihat){this.playSample(this.sampleMapping.hihat,e);return}}const s=this.audioContext.currentTime,i=t?.3:.05,a=this.audioContext.createBuffer(1,2048,this.audioContext.sampleRate),n=a.getChannelData(0);for(let h=0;h<2048;h++)n[h]=(Math.random()*2-1)*Math.sin(h*.1);const o=this.audioContext.createBufferSource();o.buffer=a;const r=this.audioContext.createBiquadFilter();r.type="highpass",r.frequency.value=8e3;const c=this.audioContext.createGain();c.gain.setValueAtTime(e*.3,s),c.gain.exponentialRampToValueAtTime(.01,s+i),o.connect(r),r.connect(c),this.connectToMaster(c),o.start(s)}playPerc(e){const t=this.audioContext.currentTime,s=400+Math.random()*800,i=this.audioContext.createOscillator();i.frequency.value=s,i.type="triangle";const a=this.audioContext.createGain();a.gain.setValueAtTime(e*.3,t),a.gain.exponentialRampToValueAtTime(.01,t+.05),i.connect(a),this.connectToMaster(a),i.start(t),i.stop(t+.05)}connectToMaster(e){this.masterNodes&&(e.connect(this.masterNodes.dryGain),e.connect(this.masterNodes.convolver))}stop(){this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),Object.values(this.probabilityTriggers).forEach(e=>e.reset()),Object.values(this.markovChains).forEach(e=>e.reset()),this.polyrhythm.reset(),this.isPlaying=!1}updateParameter(e,t){this.params[e]=t,["patternMode","euclideanSteps","kickPulses","snarePulses","hihatPulses","polyLengths"].includes(e)&&this.generatePatterns()}getTraditionalPatterns(){return{techno:{kick:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hihat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],perc:[0,0,0,.3,0,0,0,0,0,.5,0,0,0,0,0,.4]},breakbeat:{kick:[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],snare:[0,0,0,0,1,0,0,0,0,1,0,0,1,0,0,0],hihat:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],perc:[0,0,.4,0,0,0,.3,0,0,0,0,.5,0,0,0,0]}}}setPerformanceThrottle(e){this.performanceThrottle=e}}function $(y,e,t,s=!1){const i=y.sampleRate*e,a=y.createBuffer(2,i,y.sampleRate);for(let n=0;n<2;n++){const o=a.getChannelData(n);for(let r=0;r<i;r++){const c=s?i-r:r;o[r]=(Math.random()*2-1)*Math.pow(1-c/i,t)}}return a}class j{constructor(e,t){this.audioContext=e,this.nodes={source:null,gain:null,waveshaper:null},this.scheduler=null,this.isPlaying=!1}start(e){if(this.isPlaying)return;const{intensity:t,rate:s,bitCrush:i}=e;if(t===0)return;this.nodes.source=this.audioContext.createBufferSource(),this.nodes.gain=this.audioContext.createGain(),this.nodes.gain.gain.value=t*.5;const a=this.audioContext.sampleRate*.1,n=this.audioContext.createBuffer(1,a,this.audioContext.sampleRate),o=n.getChannelData(0);for(let r=0;r<a;r++)o[r]=Math.random()*2-1;this.nodes.source.buffer=n,this.nodes.source.loop=!0,this.nodes.waveshaper=this.audioContext.createWaveShaper(),this.updateBitCrusher(i),this.nodes.source.connect(this.nodes.waveshaper),this.nodes.waveshaper.connect(this.nodes.gain),this.nodes.source.start(),this.scheduler=setInterval(()=>{Math.random()<t&&this.triggerGlitch()},1e3/s),this.isPlaying=!0}stop(){if(this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),this.nodes.source)try{this.nodes.source.stop(),this.nodes.source.disconnect()}catch{}if(this.nodes.waveshaper)try{this.nodes.waveshaper.disconnect()}catch{}if(this.nodes.gain)try{this.nodes.gain.disconnect()}catch{}this.nodes.source=null,this.nodes.waveshaper=null,this.nodes.gain=null,this.isPlaying=!1}triggerGlitch(){if(!this.nodes.gain)return;const e=this.nodes.gain.gain,t=this.audioContext.currentTime;e.cancelScheduledValues(t),e.setValueAtTime(e.value,t),e.linearRampToValueAtTime(Math.random()*.8,t+.01),e.linearRampToValueAtTime(0,t+.05),e.linearRampToValueAtTime(e.value,t+.1)}updateBitCrusher(e){if(!this.nodes.waveshaper)return;const t=new Float32Array(256),s=Math.pow(2,16-e);for(let i=0;i<256;i++){const a=(i-128)/128;t[i]=Math.round(a*s)/s}this.nodes.waveshaper.curve=t}updateParameter(e,t){switch(e){case"bitcrush":this.updateBitCrusher(t);break;case"intensity":this.nodes.gain&&(this.nodes.gain.gain.value=t/100*.5);break}}getOutputNode(){return this.nodes.gain}}class _{constructor(e,t){this.audioContext=e,this.poolManager=t,this.scheduler=null,this.isPlaying=!1,this.masterConnection=null,this.activeNodes=new Set}start(e,t,s=null){if(this.isPlaying)return;const{density:i,range:a,duration:n}=e;this.masterConnection=t,this.envelope=s,i!==0&&(this.scheduler=setInterval(()=>{Math.random()<i&&this.triggerBleep(a,n)},100),this.isPlaying=!0)}stop(){this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),this.poolManager&&this.activeNodes.forEach(({osc:e,gain:t,nodeId:s})=>{this.poolManager.pools.oscillator.release(e),this.poolManager.pools.gain.release(t)}),this.activeNodes.clear(),this.isPlaying=!1}triggerBleep(e,t){const s=this.audioContext.currentTime,i=100+Math.random()*e;let a,n;const o=`bleep_${Date.now()}_${Math.random()}`;this.poolManager?(a=this.poolManager.pools.oscillator.acquireOscillator(o,{type:"sine",frequency:i}),n=this.poolManager.pools.gain.acquireGain(o,0)):(a=this.audioContext.createOscillator(),n=this.audioContext.createGain(),a.type="sine",a.frequency.value=i,n.gain.value=0),this.envelope?this.envelope.applyTo(n.gain,s,s+t):(n.gain.setValueAtTime(0,s),n.gain.linearRampToValueAtTime(.5,s+.001),n.gain.setValueAtTime(.5,s+t-.001),n.gain.linearRampToValueAtTime(0,s+t)),a.connect(n),this.masterConnection&&this.masterConnection(n),this.activeNodes.add({osc:a,gain:n,nodeId:o}),this.poolManager?setTimeout(()=>{this.poolManager.pools.oscillator.release(a),this.poolManager.pools.gain.release(n),this.activeNodes.forEach(r=>{r.nodeId===o&&this.activeNodes.delete(r)})},(t+.1)*1e3):(a.start(s),a.stop(s+t+.001))}updateParameter(e,t){}}class W{constructor(e,t){this.audioContext=e,this.scheduler=null,this.isPlaying=!1,this.masterConnection=null}start(e,t){if(this.isPlaying)return;const{activity:s,complexity:i,speed:a}=e;this.masterConnection=t,s!==0&&(this.scheduler=setInterval(()=>{Math.random()<s&&this.triggerDataBurst(i,a)},200/a),this.isPlaying=!0)}stop(){this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),this.isPlaying=!1}triggerDataBurst(e,t){const s=this.audioContext.currentTime,i=.05+Math.random()*.2;for(let a=0;a<e;a++){const n=200+Math.random()*8e3,o=s+a*i/e,r=this.audioContext.createOscillator(),c=this.audioContext.createGain(),h=this.audioContext.createBiquadFilter();r.type=Math.random()<.5?"square":"sawtooth",r.frequency.value=n,h.type="bandpass",h.frequency.value=n,h.Q.value=10+Math.random()*20,c.gain.setValueAtTime(0,o),c.gain.linearRampToValueAtTime(.3/e,o+.001),c.gain.linearRampToValueAtTime(0,o+i/e),r.connect(h),h.connect(c),this.masterConnection&&this.masterConnection(c),r.start(o),r.stop(o+i/e+.001)}}updateParameter(e,t){}}class U{constructor(e,t){this.audioContext=e,this.nodes={carrier:null,modulator:null,modGain:null,gain:null,lfo:null,lfoGain:null},this.isPlaying=!1}start(e){if(this.isPlaying)return;const{carrierFreq:t,modIndex:s,ratio:i,lfoSpeed:a}=e;s!==0&&(this.nodes.carrier=this.audioContext.createOscillator(),this.nodes.carrier.type="sine",this.nodes.carrier.frequency.value=t,this.nodes.modulator=this.audioContext.createOscillator(),this.nodes.modulator.type="sine",this.nodes.modulator.frequency.value=t*i,this.nodes.modGain=this.audioContext.createGain(),this.nodes.modGain.gain.value=s*1e3,this.nodes.gain=this.audioContext.createGain(),this.nodes.gain.gain.value=.2,this.nodes.modulator.connect(this.nodes.modGain),this.nodes.modGain.connect(this.nodes.carrier.frequency),this.nodes.carrier.connect(this.nodes.gain),a>0&&(this.nodes.lfo=this.audioContext.createOscillator(),this.nodes.lfoGain=this.audioContext.createGain(),this.nodes.lfo.frequency.value=a,this.nodes.lfoGain.gain.value=s*500,this.nodes.lfo.connect(this.nodes.lfoGain),this.nodes.lfoGain.connect(this.nodes.modGain.gain),this.nodes.lfo.start()),this.nodes.carrier.start(),this.nodes.modulator.start(),this.isPlaying=!0)}stop(){["carrier","modulator","lfo"].forEach(e=>{if(this.nodes[e])try{this.nodes[e].stop(),this.nodes[e].disconnect()}catch{}}),["modGain","gain","lfoGain"].forEach(e=>{if(this.nodes[e])try{this.nodes[e].disconnect()}catch{}}),Object.keys(this.nodes).forEach(e=>{this.nodes[e]=null}),this.isPlaying=!1}updateParameter(e,t){switch(e){case"carrier":if(this.nodes.carrier&&(this.nodes.carrier.frequency.value=t,this.nodes.modulator)){const s=parseFloat(document.getElementById("fmRatio").value);this.nodes.modulator.frequency.value=t*s}break;case"index":this.nodes.modGain&&(this.nodes.modGain.gain.value=t/100*1e3),this.nodes.lfoGain&&(this.nodes.lfoGain.gain.value=t/100*500);break;case"ratio":this.nodes.modulator&&this.nodes.carrier&&(this.nodes.modulator.frequency.value=this.nodes.carrier.frequency.value*t);break;case"lfo":this.nodes.lfo&&(this.nodes.lfo.frequency.value=t);break}}getOutputNode(){return this.nodes.gain}}class Q{constructor(e,t){this.audioContext=e,this.nodes={source:null,gain:null,filter:null},this.isPlaying=!1}start(e){if(this.isPlaying)return;const{type:t,level:s,filterFreq:i}=e;if(s===0)return;this.nodes.source=this.audioContext.createBufferSource(),this.nodes.gain=this.audioContext.createGain(),this.nodes.filter=this.audioContext.createBiquadFilter();const a=this.audioContext.sampleRate*2,n=this.audioContext.createBuffer(1,a,this.audioContext.sampleRate),o=n.getChannelData(0);this.generateNoiseData(o,t),this.nodes.source.buffer=n,this.nodes.source.loop=!0,this.nodes.filter.type="lowpass",this.nodes.filter.frequency.value=i,this.nodes.gain.gain.value=s*.1,this.nodes.source.connect(this.nodes.filter),this.nodes.filter.connect(this.nodes.gain),this.nodes.source.start(),this.isPlaying=!0}stop(){if(this.nodes.source)try{this.nodes.source.stop(),this.nodes.source.disconnect()}catch{}if(this.nodes.filter)try{this.nodes.filter.disconnect()}catch{}if(this.nodes.gain)try{this.nodes.gain.disconnect()}catch{}this.nodes.source=null,this.nodes.filter=null,this.nodes.gain=null,this.isPlaying=!1}generateNoiseData(e,t){switch(t){case"white":for(let l=0;l<e.length;l++)e[l]=Math.random()*2-1;break;case"pink":let s=0,i=0,a=0,n=0,o=0,r=0,c=0;for(let l=0;l<e.length;l++){const d=Math.random()*2-1;s=.99886*s+d*.0555179,i=.99332*i+d*.0750759,a=.969*a+d*.153852,n=.8665*n+d*.3104856,o=.55*o+d*.5329522,r=-.7616*r-d*.016898,e[l]=(s+i+a+n+o+r+c+d*.5362)*.11,c=d*.115926}break;case"brown":let h=0;for(let l=0;l<e.length;l++){const d=Math.random()*2-1;e[l]=(h+.02*d)/1.02,h=e[l],e[l]*=2}break;case"crackle":for(let l=0;l<e.length;l++)e[l]=Math.random()<.01?(Math.random()*2-1)*.5:0;break}}updateParameter(e,t){switch(e){case"level":this.nodes.gain&&(this.nodes.gain.gain.value=t*.1);break;case"filter":this.nodes.filter&&(this.nodes.filter.frequency.value=t);break}}getOutputNode(){return this.nodes.gain}}class K{constructor(e,t){this.audioContext=e,this.scheduler=null,this.isPlaying=!1,this.masterConnection=null,this.step=0}start(e,t){if(this.isPlaying)return;const{level:s,baseFreq:i,resonance:a,decay:n,speed:o,tempo:r}=e;if(this.masterConnection=t,s===0)return;const c=[1,0,.5,0,1,0,.3,.8,0,.6,0,1,0,.4,0,.7],h=[0,0,12,0,0,7,3,5,0,10,0,0,15,3,0,7],l=6e4/(r*4*o);this.scheduler=setInterval(()=>{const d=this.step%c.length;if(c[d]>0){const p=c[d]*s,u=h[d],g=i*Math.pow(2,u/12);this.triggerAcidNote(g,p,n,a)}this.step++},l),this.isPlaying=!0}stop(){this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),this.step=0,this.isPlaying=!1}triggerAcidNote(e,t,s,i){const a=this.audioContext.currentTime,n=this.audioContext.createOscillator();n.type="sawtooth",n.frequency.value=e;const o=this.audioContext.createBiquadFilter();o.type="lowpass",o.Q.value=i*30;const r=Math.min(e*8,15e3);o.frequency.setValueAtTime(r,a),o.frequency.exponentialRampToValueAtTime(e,a+s);const c=this.audioContext.createGain();c.gain.setValueAtTime(0,a),c.gain.linearRampToValueAtTime(t*.5,a+.01),c.gain.exponentialRampToValueAtTime(.01,a+s);const h=this.audioContext.createWaveShaper(),l=new Float32Array(256);for(let d=0;d<256;d++){const p=(d-128)/128;l[d]=Math.tanh(p*(1+i*4))}h.curve=l,h.oversample="2x",n.connect(o),o.connect(h),h.connect(c),this.masterConnection&&this.masterConnection(c),n.start(a),n.stop(a+s+.1)}updateParameter(e,t){}}class X{constructor(e,t){this.audioContext=e,this.poolManager=t,this.scheduler=null,this.sourceBuffer=null,this.isPlaying=!1,this.performanceThrottle=1,this.activeGrains=new Set,this.voiceId="granular"}start(e,t){if(this.isPlaying)return;const{density:s,grainSize:i,pitchSpread:a,panSpread:n}=e;if(this.masterNodes=t,s===0)return;const o=this.audioContext.sampleRate*2;this.sourceBuffer=this.audioContext.createBuffer(1,o,this.audioContext.sampleRate);const r=this.sourceBuffer.getChannelData(0);for(let h=0;h<o;h++){const l=h/this.audioContext.sampleRate;r[h]=Math.sin(2*Math.PI*100*l)*.3+Math.sin(2*Math.PI*237*l)*.2+Math.sin(2*Math.PI*523*l)*.1+(Math.random()*2-1)*.1}const c=this.performanceThrottle<.7?100:50;this.scheduler=setInterval(()=>{Math.random()<s*this.performanceThrottle&&this.triggerGrain(i,a,n)},c),this.isPlaying=!0}stop(){this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),this.poolManager&&this.activeGrains.forEach(({source:e,gain:t,panner:s})=>{this.poolManager.pools.bufferSource.release(e),this.poolManager.pools.gain.release(t),s.disconnect()}),this.activeGrains.clear(),this.sourceBuffer=null,this.isPlaying=!1}triggerGrain(e,t,s){const i=this.audioContext.currentTime,a=`${this.voiceId}_grain_${Date.now()}_${Math.random()}`;let n,o,r;const c=Math.random()*(this.sourceBuffer.duration-e/1e3),h=Math.pow(2,(Math.random()-.5)*t*2),l=e/1e3;this.poolManager?(n=this.poolManager.pools.bufferSource.acquireBufferSource(a,this.sourceBuffer,{playbackRate:h}),o=this.poolManager.pools.gain.acquireGain(a,0),r=this.audioContext.createStereoPanner()):(n=this.audioContext.createBufferSource(),n.buffer=this.sourceBuffer,n.playbackRate.value=h,o=this.audioContext.createGain(),r=this.audioContext.createStereoPanner()),o.gain.setValueAtTime(0,i),o.gain.linearRampToValueAtTime(.3,i+l*.1),o.gain.setValueAtTime(.3,i+l*.9),o.gain.linearRampToValueAtTime(0,i+l),r.pan.value=(Math.random()-.5)*2*s,n.connect(o),o.connect(r),this.masterNodes&&(r.connect(this.masterNodes.dryGain),r.connect(this.masterNodes.convolver),r.connect(this.masterNodes.delay)),this.activeGrains.add({source:n,gain:o,panner:r,grainId:a}),n.start(i,c,l),setTimeout(()=>{this.poolManager&&(this.poolManager.pools.bufferSource.release(n),this.poolManager.pools.gain.release(o)),r.disconnect(),this.activeGrains.forEach(d=>{d.grainId===a&&this.activeGrains.delete(d)})},l*1e3+100)}updateParameter(e,t){}setPerformanceThrottle(e){this.performanceThrottle=e}}class Y{constructor(e,t){this.audioContext=e,this.scheduler=null,this.nodes={delay:null,delayGain:null,filter:null,lastFreq:null},this.isPlaying=!1,this.masterNodes=null}start(e,t){if(this.isPlaying)return;const{density:s,range:i,speed:a,echo:n,portamento:o}=e;if(this.masterNodes=t,s===0)return;this.nodes.delay=this.audioContext.createDelay(2),this.nodes.delay.delayTime.value=.375,this.nodes.delayGain=this.audioContext.createGain(),this.nodes.delayGain.gain.value=n*.7,this.nodes.filter=this.audioContext.createBiquadFilter(),this.nodes.filter.type="highpass",this.nodes.filter.frequency.value=200,this.nodes.delay.connect(this.nodes.delayGain),this.nodes.delayGain.connect(this.nodes.delay);const r=[0,2,4,7,9,12,14,16,19,21],c=220,h=6e4/(120*a*2);this.scheduler=setInterval(()=>{if(Math.random()<s){const l=Math.floor(Math.random()*r.length),d=Math.floor(Math.random()*i),p=c*Math.pow(2,(r[l]+d*12)/12);this.triggerNote(p,o)}},h),this.isPlaying=!0}stop(){this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),["delay","delayGain","filter"].forEach(e=>{if(this.nodes[e]){try{this.nodes[e].disconnect()}catch{}this.nodes[e]=null}}),this.nodes.lastFreq=null,this.isPlaying=!1}triggerNote(e,t){const s=this.audioContext.currentTime,i=this.audioContext.createOscillator();i.type="sine";const a=this.audioContext.createGain();a.gain.setValueAtTime(0,s),a.gain.linearRampToValueAtTime(.3,s+.05),a.gain.exponentialRampToValueAtTime(.001,s+1.5),this.nodes.lastFreq?(i.frequency.setValueAtTime(this.nodes.lastFreq,s),i.frequency.exponentialRampToValueAtTime(e,s+t/1e3)):i.frequency.value=e,this.nodes.lastFreq=e;const n=this.audioContext.createOscillator(),o=this.audioContext.createGain();n.frequency.value=5,o.gain.value=3,n.connect(o),o.connect(i.frequency),i.connect(a),a.connect(this.nodes.filter),this.masterNodes&&(this.nodes.filter.connect(this.nodes.delay),this.nodes.filter.connect(this.masterNodes.dryGain),this.nodes.delay.connect(this.masterNodes.dryGain)),i.start(s),n.start(s),i.stop(s+2),n.stop(s+2)}updateParameter(e,t){switch(e){case"echo":this.nodes.delayGain&&(this.nodes.delayGain.gain.value=t*.7);break}}}class J{constructor(e,t){this.audioContext=e,this.poolManager=t,this.scheduler=null,this.isPlaying=!1,this.masterNodes=null,this.chordIndex=0,this.voiceId="ambientPad",this.activeVoices=new Set}start(e,t){if(this.isPlaying)return;const{density:s,attack:i,release:a,filterSweep:n,shimmer:o}=e;if(this.masterNodes=t,s===0)return;const r=[[0,4,7,11],[2,5,9,12],[4,7,11,14],[5,9,12,16],[7,11,14,17],[9,12,16,19]],c=8e3/s;this.scheduler=setInterval(()=>{const h=r[this.chordIndex%r.length];this.triggerPadChord(h,i,a,n,o),this.chordIndex++},c),this.isPlaying=!0}stop(){this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),this.poolManager?this.activeVoices.forEach(({oscillators:e,gains:t,filters:s,shimmerOscs:i,shimmerGains:a})=>{e.forEach(n=>{this.poolManager.pools.oscillator.release(n)}),t.forEach(n=>{this.poolManager.pools.gain.release(n)}),s.forEach(n=>{n.disconnect()}),i.forEach(n=>{this.poolManager.pools.oscillator.release(n)}),a.forEach(n=>{this.poolManager.pools.gain.release(n)})}):this.activeVoices.forEach(({oscillators:e,gains:t,filters:s,shimmerOscs:i,shimmerGains:a})=>{e.forEach(n=>{try{n.stop(),n.disconnect()}catch{}}),t.forEach(n=>{try{n.disconnect()}catch{}}),s.forEach(n=>{try{n.disconnect()}catch{}}),i.forEach(n=>{try{n.stop(),n.disconnect()}catch{}}),a.forEach(n=>{try{n.disconnect()}catch{}})}),this.activeVoices.clear(),this.chordIndex=0,this.isPlaying=!1}triggerPadChord(e,t,s,i,a){const n=this.audioContext.currentTime,o=110,r=`${this.voiceId}_chord_${Date.now()}`,c=[],h=[],l=[],d=[],p=[];e.forEach((m,f)=>{const x=o*Math.pow(2,m/12);for(let M=0;M<3;M++){const k=`${r}_n${f}_v${M}`;let T,b;this.poolManager?(T=this.poolManager.pools.oscillator.acquireOscillator(k,{type:"sawtooth",frequency:x*(1+(M-1)*.01)}),b=this.poolManager.pools.gain.acquireGain(k,0)):(T=this.audioContext.createOscillator(),T.type="sawtooth",T.frequency.value=x*(1+(M-1)*.01),b=this.audioContext.createGain(),b.gain.value=0),b.gain.setValueAtTime(0,n),b.gain.linearRampToValueAtTime(.1/e.length,n+t),b.gain.setValueAtTime(.1/e.length,n+t+2),b.gain.exponentialRampToValueAtTime(.001,n+t+2+s);const C=this.audioContext.createBiquadFilter();if(C.type="lowpass",C.frequency.setValueAtTime(200,n),C.frequency.exponentialRampToValueAtTime(2e3*(1+i),n+t),C.frequency.exponentialRampToValueAtTime(200,n+t+2+s),C.Q.value=3,T.connect(b),b.connect(C),this.masterNodes&&(C.connect(this.masterNodes.dryGain),C.connect(this.masterNodes.convolver)),a>0&&Math.random()<a){const F=`${k}_shimmer`;let E,P;this.poolManager?(E=this.poolManager.pools.oscillator.acquireOscillator(F,{type:"sine",frequency:x*4}),P=this.poolManager.pools.gain.acquireGain(F,.02*a)):(E=this.audioContext.createOscillator(),E.frequency.value=x*4,E.type="sine",P=this.audioContext.createGain(),P.gain.value=.02*a),E.connect(P),this.masterNodes&&P.connect(this.masterNodes.convolver),this.poolManager||(E.start(n+t*.5),E.stop(n+t+2+s)),d.push(E),p.push(P)}this.poolManager||(T.start(n),T.stop(n+t+2+s)),c.push(T),h.push(b),l.push(C)}});const u={voiceGroupId:r,oscillators:c,gains:h,filters:l,shimmerOscs:d,shimmerGains:p};this.activeVoices.add(u);const g=t+2+s;setTimeout(()=>{this.poolManager&&(c.forEach(m=>{this.poolManager.pools.oscillator.release(m)}),h.forEach(m=>{this.poolManager.pools.gain.release(m)}),d.forEach(m=>{this.poolManager.pools.oscillator.release(m)}),p.forEach(m=>{this.poolManager.pools.gain.release(m)})),l.forEach(m=>{m.disconnect()}),this.activeVoices.delete(u)},g*1e3+100)}updateParameter(e,t){}}class Z{constructor(e,t){this.audioContext=e,this.scheduler=null,this.isPlaying=!1,this.masterNodes=null,this.noteIndex=0,this.direction=1}start(e,t){if(this.isPlaying)return;const{enable:s,pattern:i,speed:a,octaves:n,gate:o,tempo:r}=e;if(this.masterNodes=t,this.currentParams=e,s===0)return;const c=[0,3,5,7,10],h=6e4/(r*a/4);this.scheduler=setInterval(()=>{if(Math.random()<s){let l=[];for(let u=0;u<n;u++)c.forEach(g=>l.push(g+u*12));let d;switch(i){case"up":d=l[this.noteIndex%l.length],this.noteIndex++;break;case"down":d=l[l.length-1-this.noteIndex%l.length],this.noteIndex++;break;case"updown":this.noteIndex>=l.length-1&&(this.direction=-1),this.noteIndex<=0&&(this.direction=1),d=l[this.noteIndex],this.noteIndex+=this.direction;break;case"random":d=l[Math.floor(Math.random()*l.length)];break}const p=220*Math.pow(2,d/12);this.triggerNote(p,h*o)}},h),this.isPlaying=!0}stop(){this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),this.noteIndex=0,this.direction=1,this.isPlaying=!1}triggerNote(e,t){const s=this.audioContext.currentTime,i=this.audioContext.createOscillator();i.type="square",i.frequency.value=e;const a=this.audioContext.createGain();a.gain.setValueAtTime(0,s),a.gain.linearRampToValueAtTime(.2,s+.01),a.gain.setValueAtTime(.2,s+t/1e3-.01),a.gain.linearRampToValueAtTime(0,s+t/1e3);const n=this.audioContext.createBiquadFilter();n.type="lowpass",n.frequency.value=e*4,n.Q.value=5,i.connect(a),a.connect(n),this.masterNodes&&(n.connect(this.masterNodes.dryGain),n.connect(this.masterNodes.delay)),i.start(s),i.stop(s+t/1e3)}updateParameter(e,t){}updateTempo(e){if(this.masterTempo=e,this.isPlaying&&this.scheduler){const t=this.currentParams;t&&(t.tempo=e.bpm,this.stop(),this.start(t,this.masterNodes))}}}class ee{constructor(e,t){this.audioContext=e,this.poolManager=t,this.nodes={oscillators:[],gains:[],filter:null,mixer:null},this.scheduler=null,this.isPlaying=!1,this.voiceId="chord",this.currentChordIndex=0,this.progressions={major:[[0,4,7,12],[5,9,12,17],[7,11,14,19],[0,4,7,12]],minor:[[0,3,7,12],[5,8,12,17],[7,10,14,19],[0,3,7,12]],jazz:[[0,4,7,11],[2,5,9,12],[7,11,14,17],[0,4,7,10]],suspended:[[0,5,7,12],[2,7,9,14],[7,12,14,19],[0,5,7,12]]}}start(e,t){var c;if(this.isPlaying)return;const{density:s,progression:i,voicing:a,brightness:n,spread:o}=e;if(this.masterConnection=t,this.currentParams=e,s===0)return;this.nodes.filter=this.audioContext.createBiquadFilter(),this.nodes.filter.type="lowpass",this.nodes.filter.frequency.value=n,this.nodes.filter.Q.value=2,this.nodes.mixer=this.audioContext.createGain(),this.nodes.mixer.gain.value=.3,this.nodes.filter.connect(this.nodes.mixer),this.masterConnection&&this.masterConnection(this.nodes.mixer);const r=60/parseFloat(((c=document.getElementById("chordTempo"))==null?void 0:c.value)||60)*1e3;this.playChord(e),this.scheduler=setInterval(()=>{this.playChord(e)},r),this.isPlaying=!0}playChord(e){var l;const{progression:t,voicing:s,brightness:i,spread:a}=e,n=parseFloat(((l=document.getElementById("chordRoot"))==null?void 0:l.value)||220);this.stopCurrentChord();const o=this.progressions[t]||this.progressions.major,r=o[this.currentChordIndex%o.length],c={close:[1,1,1,1],open:[.5,1,1,2],drop2:[.5,1,2,1],spread:[.25,.5,1,2]},h=c[s]||c.close;r.forEach((d,p)=>{const u=n*Math.pow(2,d/12)*h[p],g=`${this.voiceId}_osc_${p}`;let m,f;this.poolManager?(m=this.poolManager.pools.oscillator.acquireOscillator(g,{type:"triangle",frequency:u}),f=this.poolManager.pools.gain.acquireGain(g,0)):(m=this.audioContext.createOscillator(),f=this.audioContext.createGain(),m.type="triangle",m.frequency.value=u,f.gain.value=0),m.detune.value=(Math.random()-.5)*a;const x=this.audioContext.currentTime;f.gain.setValueAtTime(0,x),f.gain.linearRampToValueAtTime(.2/r.length,x+.05),f.gain.exponentialRampToValueAtTime(.15/r.length,x+.5),m.connect(f),f.connect(this.nodes.filter),this.poolManager||m.start(),this.nodes.oscillators.push(m),this.nodes.gains.push(f)}),this.currentChordIndex++}stopCurrentChord(){this.poolManager?(this.nodes.oscillators.forEach((e,t)=>{this.poolManager.pools.oscillator.release(e)}),this.nodes.gains.forEach((e,t)=>{this.poolManager.pools.gain.release(e)})):(this.nodes.oscillators.forEach(e=>{try{e.stop(),e.disconnect()}catch{}}),this.nodes.gains.forEach(e=>{try{e.disconnect()}catch{}})),this.nodes.oscillators=[],this.nodes.gains=[]}stop(){this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),this.stopCurrentChord(),this.nodes.filter&&(this.nodes.filter.disconnect(),this.nodes.filter=null),this.nodes.mixer&&(this.nodes.mixer.disconnect(),this.nodes.mixer=null),this.currentChordIndex=0,this.isPlaying=!1}updateParameter(e,t){switch(e){case"brightness":this.nodes.filter&&(this.nodes.filter.frequency.value=t);break;case"volume":this.nodes.mixer&&(this.nodes.mixer.gain.value=t);break}}updateTempo(e){if(this.masterTempo=e,this.isPlaying&&this.scheduler){const t=this.currentParams;t&&(t.tempo=e.bpm,this.stop(),this.start(t,this.masterNodes))}}getOutputNode(){return this.nodes.mixer}}class te{constructor(e,t){this.audioContext=e,this.poolManager=t,this.nodes={oscillators:[],formantFilters:[],gains:[],mixer:null},this.scheduler=null,this.isPlaying=!1,this.voiceId="vocal",this.formants={a:{f1:700,f2:1220,f3:2600},e:{f1:400,f2:2200,f3:2900},i:{f1:300,f2:2700,f3:3300},o:{f1:450,f2:800,f3:2830},u:{f1:325,f2:700,f3:2530},ah:{f1:640,f2:1190,f3:2390},oo:{f1:300,f2:870,f3:2240}},this.consonants={s:{type:"highpass",freq:4e3,Q:5},sh:{type:"bandpass",freq:2500,Q:3},f:{type:"highpass",freq:1200,Q:10},k:{type:"bandpass",freq:1500,Q:20},t:{type:"highpass",freq:3e3,Q:15}}}start(e,t){if(this.isPlaying)return;const{density:s,vowel:i,pitch:a,vibrato:n,whisper:o}=e;this.masterConnection=t,s!==0&&(this.nodes.mixer=this.audioContext.createGain(),this.nodes.mixer.gain.value=.5,this.masterConnection&&this.masterConnection(this.nodes.mixer),this.scheduler=setInterval(()=>{Math.random()<s&&(Math.random()>o?this.triggerVowel(i,a,n):this.triggerConsonant())},200),this.isPlaying=!0)}triggerVowel(e,t,s){const i=this.audioContext.currentTime,a=.2+Math.random()*.8,n=`${this.voiceId}_vowel_${Date.now()}`,o=this.formants[e]||this.formants.a;let r,c;if(this.poolManager?(r=this.poolManager.pools.oscillator.acquireOscillator(`${n}_fund`,{type:"sawtooth",frequency:t}),c=this.poolManager.pools.gain.acquireGain(`${n}_fund_gain`,0)):(r=this.audioContext.createOscillator(),c=this.audioContext.createGain(),r.type="sawtooth",r.frequency.value=t,c.gain.value=0),s>0){const l=this.audioContext.createOscillator(),d=this.audioContext.createGain();l.frequency.value=4+Math.random()*3,d.gain.value=t*s*.02,l.connect(d),d.connect(r.frequency),l.start(),setTimeout(()=>{l.stop(),l.disconnect(),d.disconnect()},a*1e3)}const h=[];Object.values(o).forEach((l,d)=>{const p=this.audioContext.createBiquadFilter();p.type="bandpass",p.frequency.value=l,p.Q.value=10;const u=this.audioContext.createGain();u.gain.value=d===0?.5:.3/(d+1),r.connect(p),p.connect(u),u.connect(this.nodes.mixer),this.nodes.formantFilters.push(p),h.push(u)}),c.gain.setValueAtTime(0,i),c.gain.linearRampToValueAtTime(.3,i+.01),c.gain.exponentialRampToValueAtTime(.2,i+a*.7),c.gain.exponentialRampToValueAtTime(.001,i+a),r.connect(c),this.poolManager||r.start(),setTimeout(()=>{if(this.poolManager)this.poolManager.pools.oscillator.release(r),this.poolManager.pools.gain.release(c);else try{r.stop(),r.disconnect(),c.disconnect()}catch{}this.nodes.formantFilters.forEach(l=>{l.disconnect()}),h.forEach(l=>{l.disconnect()}),this.nodes.formantFilters=this.nodes.formantFilters.filter(l=>!this.nodes.formantFilters.includes(l))},a*1e3+100)}triggerConsonant(){const e=this.audioContext.currentTime,t=.05+Math.random()*.1,s=this.audioContext.sampleRate*t,i=this.audioContext.createBuffer(1,s,this.audioContext.sampleRate),a=i.getChannelData(0);for(let l=0;l<s;l++)a[l]=Math.random()*2-1;const n=this.audioContext.createBufferSource();n.buffer=i;const o=Object.keys(this.consonants),r=this.consonants[o[Math.floor(Math.random()*o.length)]],c=this.audioContext.createBiquadFilter();c.type=r.type,c.frequency.value=r.freq,c.Q.value=r.Q;const h=this.audioContext.createGain();h.gain.setValueAtTime(0,e),h.gain.linearRampToValueAtTime(.3,e+.005),h.gain.exponentialRampToValueAtTime(.001,e+t),n.connect(c),c.connect(h),h.connect(this.nodes.mixer),n.start(),n.stop(e+t)}stop(){this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),this.nodes.oscillators.forEach(e=>{try{e.stop(),e.disconnect()}catch{}}),this.nodes.formantFilters.forEach(e=>{try{e.disconnect()}catch{}}),this.nodes.gains.forEach(e=>{try{e.disconnect()}catch{}}),this.nodes.mixer&&(this.nodes.mixer.disconnect(),this.nodes.mixer=null),this.nodes.oscillators=[],this.nodes.formantFilters=[],this.nodes.gains=[],this.isPlaying=!1}updateParameter(e,t){switch(e){case"volume":this.nodes.mixer&&(this.nodes.mixer.gain.value=t);break}}}class se{constructor(e,t){this.audioContext=e,this.poolManager=t,this.scheduler=null,this.isPlaying=!1,this.voiceId="karplus",this.activeStrings=new Set}start(e,t){if(this.isPlaying)return;const{density:s,pitch:i,damping:a,brightness:n,pluckHardness:o}=e;this.masterConnection=t,s!==0&&(this.scheduler=setInterval(()=>{if(Math.random()<s){const r=this.getRandomNote(i);this.pluckString(r,a,n,o)}},200),this.isPlaying=!0)}getRandomNote(e){const t=[0,2,4,5,7,9,11],s=2,i=t[Math.floor(Math.random()*t.length)],a=Math.floor(Math.random()*s);return e*Math.pow(2,(i+a*12)/12)}pluckString(e,t,s,i){this.audioContext.currentTime;const a=`${this.voiceId}_string_${Date.now()}_${Math.random()}`,n=1/e,o=this.audioContext.sampleRate,r=Math.round(n*o),c=this.audioContext.createBuffer(1,r,o),h=c.getChannelData(0);for(let f=0;f<r;f++)f<r*i?h[f]=Math.random()*2-1:h[f]=(Math.random()*2-1)*(1-f/r);const l=this.audioContext.createBufferSource();l.buffer=c;const d=this.audioContext.createDelay(1);d.delayTime.value=n;const p=this.audioContext.createBiquadFilter();p.type="lowpass",p.frequency.value=s;const u=this.audioContext.createGain();u.gain.value=t;const g=this.audioContext.createGain();g.gain.value=.3,l.connect(d),d.connect(p),p.connect(u),u.connect(d),d.connect(g),this.masterConnection&&this.masterConnection(g),this.activeStrings.add({stringId:a,nodes:{noise:l,delay:d,lowpass:p,feedback:u,output:g}}),l.start();const m=Math.log(.001)/Math.log(t)*n;setTimeout(()=>{try{l.stop(),l.disconnect(),d.disconnect(),p.disconnect(),u.disconnect(),g.disconnect()}catch{}this.activeStrings.forEach(f=>{f.stringId===a&&this.activeStrings.delete(f)})},m*1e3+1e3)}stop(){this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),this.activeStrings.forEach(({nodes:e})=>{try{e.noise.stop(),Object.values(e).forEach(t=>{t.disconnect()})}catch{}}),this.activeStrings.clear(),this.isPlaying=!1}updateParameter(e,t){}}class ie{constructor(e,t){this.audioContext=e,this.poolManager=t,this.nodes={oscillators:[],gains:[],filter:null,mixer:null},this.scheduler=null,this.isPlaying=!1,this.voiceId="additive",this.activeVoices=new Set}start(e,t){if(this.isPlaying)return;const{density:s,fundamental:i,harmonics:a,harmonicDecay:n,inharmonicity:o,brightness:r}=e;this.masterConnection=t,s!==0&&(this.nodes.filter=this.audioContext.createBiquadFilter(),this.nodes.filter.type="lowpass",this.nodes.filter.frequency.value=r,this.nodes.filter.Q.value=1,this.nodes.mixer=this.audioContext.createGain(),this.nodes.mixer.gain.value=.3,this.nodes.filter.connect(this.nodes.mixer),this.masterConnection&&this.masterConnection(this.nodes.mixer),this.scheduler=setInterval(()=>{Math.random()<s&&this.triggerAdditiveVoice(i,a,n,o)},300),this.isPlaying=!0)}triggerAdditiveVoice(e,t,s,i){const a=this.audioContext.currentTime,n=.5+Math.random()*2,o=`${this.voiceId}_voice_${Date.now()}_${Math.random()}`,r=e*(.5+Math.random()),c=[],h=[];for(let l=0;l<t;l++){const d=l+1,p=Math.pow(1+i*.01,d),u=r*d*p;if(u>1e4)continue;let g,m;const f=`${o}_h${d}`;this.poolManager?(g=this.poolManager.pools.oscillator.acquireOscillator(f,{type:"sine",frequency:u}),m=this.poolManager.pools.gain.acquireGain(f,0)):(g=this.audioContext.createOscillator(),m=this.audioContext.createGain(),g.type="sine",g.frequency.value=u,m.gain.value=0);const x=.25/Math.pow(d,s);m.gain.setValueAtTime(0,a),m.gain.linearRampToValueAtTime(x,a+.01),m.gain.setValueAtTime(x,a+n*.8),m.gain.exponentialRampToValueAtTime(.001,a+n),g.detune.value=(Math.random()-.5)*10*d,g.connect(m),m.connect(this.nodes.filter),this.poolManager||g.start(),c.push(g),h.push(m)}this.activeVoices.add({voiceId:o,oscillators:c,gains:h}),setTimeout(()=>{this.poolManager?(c.forEach((l,d)=>{this.poolManager.pools.oscillator.release(l)}),h.forEach((l,d)=>{this.poolManager.pools.gain.release(l)})):(c.forEach(l=>{try{l.stop(),l.disconnect()}catch{}}),h.forEach(l=>{try{l.disconnect()}catch{}})),this.activeVoices.forEach(l=>{l.voiceId===o&&this.activeVoices.delete(l)})},n*1e3+100)}stop(){this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),this.poolManager?this.activeVoices.forEach(({oscillators:e,gains:t})=>{e.forEach(s=>{this.poolManager.pools.oscillator.release(s)}),t.forEach(s=>{this.poolManager.pools.gain.release(s)})}):this.activeVoices.forEach(({oscillators:e,gains:t})=>{e.forEach(s=>{try{s.stop(),s.disconnect()}catch{}}),t.forEach(s=>{try{s.disconnect()}catch{}})}),this.activeVoices.clear(),this.nodes.filter&&(this.nodes.filter.disconnect(),this.nodes.filter=null),this.nodes.mixer&&(this.nodes.mixer.disconnect(),this.nodes.mixer=null),this.isPlaying=!1}updateParameter(e,t){switch(e){case"brightness":this.nodes.filter&&(this.nodes.filter.frequency.value=t);break}}}class ae{constructor(){this.dnaSequence=this.generateDNASequence(64),this.dnaPointer=0,this.heartbeat={baseRate:70,variability:.1,phase:0,coherence:.5},this.brainwaves={delta:{freq:2,amplitude:.3,phase:0},theta:{freq:6,amplitude:.4,phase:0},alpha:{freq:10,amplitude:.5,phase:0},beta:{freq:20,amplitude:.6,phase:0},gamma:{freq:40,amplitude:.2,phase:0}},this.fibonacci=[1,1,2,3,5,8,13,21,34,55,89],this.goldenRatio=1.618033988749,this.spiralAngle=0,this.cellularAutomaton=new Array(32).fill(0),this.cellularAutomaton[16]=1,this.caRule=30,this.ecosystem={predator:50,prey:100,vegetation:200,time:0},this.population=this.initializePopulation(16),this.generation=0}generateDNASequence(e){const t=["A","T","G","C"];return Array.from({length:e},()=>t[Math.floor(Math.random()*4)])}getDNAMusic(){const e=this.dnaSequence[this.dnaPointer];this.dnaPointer=(this.dnaPointer+1)%this.dnaSequence.length;const t={A:{frequency:110,scale:[0,2,4,5,7,9,11],density:.8},T:{frequency:146.83,scale:[0,2,3,5,7,8,10],density:.6},G:{frequency:196,scale:[0,2,4,6,7,9,11],density:.9},C:{frequency:261.63,scale:[0,1,3,5,6,8,10],density:.4}};return{baseFrequency:t[e].frequency,scale:t[e].scale,density:t[e].density,sequence:this.dnaSequence.slice(this.dnaPointer,this.dnaPointer+8),geneExpression:this.calculateGeneExpression()}}calculateGeneExpression(){const e=this.dnaSequence.slice(Math.max(0,this.dnaPointer-8),this.dnaPointer);return e.filter(s=>s==="G"||s==="C").length/e.length}getHeartbeatMusic(e){this.heartbeat.phase+=e;const t=Math.sin(this.heartbeat.phase*.1)*this.heartbeat.variability,s=this.heartbeat.baseRate*(1+t),i=.5+.5*Math.sin(this.heartbeat.phase*.05);return this.heartbeat.coherence=i,{tempo:s,kick:Math.sin(this.heartbeat.phase*s/60*2*Math.PI)>.8?1:0,harmonicCoherence:i,variability:Math.abs(t),systolic:Math.sin(this.heartbeat.phase*s/60*2*Math.PI),diastolic:Math.cos(this.heartbeat.phase*s/60*2*Math.PI*.6)}}getBrainwaveMusic(e){const t={};return Object.keys(this.brainwaves).forEach(s=>{const i=this.brainwaves[s];i.phase+=e*i.freq*2*Math.PI,t[s]={amplitude:i.amplitude*Math.sin(i.phase),frequency:i.freq,power:i.amplitude}}),{bassFreq:50+t.delta.amplitude*100,midFreq:200+t.theta.amplitude*300,highFreq:1e3+t.alpha.amplitude*2e3,energyLevel:t.beta.power,creativityLevel:t.gamma.power,relaxationLevel:t.alpha.power,focusLevel:t.beta.power-t.theta.power,meditation:t.theta.power>.5?1:0}}getFibonacciMusic(){this.spiralAngle+=this.goldenRatio*.1;const e=Math.floor(this.spiralAngle)%this.fibonacci.length,t=this.fibonacci[e],s=this.fibonacci[(e+1)%this.fibonacci.length],i=220;return{frequencies:[i,i*this.goldenRatio,i*Math.pow(this.goldenRatio,2),i*Math.pow(this.goldenRatio,3)],pattern:this.fibonacci.slice(0,8),phiRatio:this.goldenRatio,spiralPosition:this.spiralAngle,growthRate:t/s,harmony:this.generatePhiHarmony(i),timing:this.fibonacci.map(n=>n/89)}}generatePhiHarmony(e){return[e,e*this.goldenRatio,e*Math.pow(this.goldenRatio,2),e*(2-1/this.goldenRatio),e*Math.pow(this.goldenRatio,-1)]}getCellularAutomatonMusic(){const e=new Array(this.cellularAutomaton.length);for(let s=0;s<this.cellularAutomaton.length;s++){const i=this.cellularAutomaton[(s-1+this.cellularAutomaton.length)%this.cellularAutomaton.length],a=this.cellularAutomaton[s],n=this.cellularAutomaton[(s+1)%this.cellularAutomaton.length],o=i*4+a*2+n;e[s]=this.caRule>>o&1}this.cellularAutomaton=e;const t=this.cellularAutomaton.reduce((s,i)=>s+i,0)/this.cellularAutomaton.length;return{pattern:[...this.cellularAutomaton],density:t,complexity:this.calculateComplexity(this.cellularAutomaton),triggers:this.cellularAutomaton.map(s=>s?1:0),evolution:this.cellularAutomaton,clusters:this.findClusters(this.cellularAutomaton)}}calculateComplexity(e){let t=0;for(let s=1;s<e.length;s++)e[s]!==e[s-1]&&t++;return t/(e.length-1)}findClusters(e){const t=[];let s=[];for(let i=0;i<e.length;i++)e[i]===1?s.push(i):s.length>0&&(t.push([...s]),s=[]);return s.length>0&&t.push(s),t}getEcosystemMusic(e){const{predator:t,prey:s,vegetation:i}=this.ecosystem,a=.1,n=.075,o=.05,r=.125,c=a*s-n*s*t,h=o*s*t-r*t,l=.2*i*(1-i/300)-.1*s;return this.ecosystem.prey+=c*e,this.ecosystem.predator+=h*e,this.ecosystem.vegetation+=l*e,this.ecosystem.time+=e,this.ecosystem.prey=Math.max(1,this.ecosystem.prey),this.ecosystem.predator=Math.max(1,this.ecosystem.predator),this.ecosystem.vegetation=Math.max(1,this.ecosystem.vegetation),{preyFreq:100+this.ecosystem.prey*2,predatorFreq:200+this.ecosystem.predator*4,vegetationDensity:this.ecosystem.vegetation/300,balance:this.ecosystem.prey/(this.ecosystem.predator+1),tension:Math.abs(c)+Math.abs(h),stability:1/(1+Math.abs(c)+Math.abs(h)),cycle:Math.sin(this.ecosystem.time*.1)}}initializePopulation(e){return Array.from({length:e},()=>({genes:Array.from({length:16},()=>Math.random()),fitness:0}))}evolvePopulation(){this.population.forEach(t=>{t.fitness=this.calculateMusicalFitness(t.genes)});const e=[];for(let t=0;t<this.population.length;t++){const s=this.selectParent(),i=this.selectParent(),a=this.crossover(s,i);this.mutate(a),e.push(a)}return this.population=e,this.generation++,this.getBestIndividual()}calculateMusicalFitness(e){let t=0;for(let i=0;i<e.length-1;i++)Math.abs(e[i]-e[i+1])<.5&&(t+=1);const s=this.calculateVariance(e);return t+=Math.max(0,1-s),t}calculateVariance(e){const t=e.reduce((s,i)=>s+i,0)/e.length;return e.reduce((s,i)=>s+Math.pow(i-t,2),0)/e.length}selectParent(){let t=this.population[Math.floor(Math.random()*this.population.length)];for(let s=1;s<3;s++){const i=this.population[Math.floor(Math.random()*this.population.length)];i.fitness>t.fitness&&(t=i)}return t}crossover(e,t){const s=Math.floor(Math.random()*e.genes.length);return{genes:[...e.genes.slice(0,s),...t.genes.slice(s)],fitness:0}}mutate(e){e.genes=e.genes.map(s=>Math.random()<.1?Math.random():s)}getBestIndividual(){return this.population.reduce((e,t)=>t.fitness>e.fitness?t:e)}getGeneticMusic(){const e=this.getBestIndividual();return{pattern:e.genes,fitness:e.fitness,generation:this.generation,diversity:this.calculatePopulationDiversity(),evolution:this.population.map(t=>t.fitness),musicalGenes:this.genesToMusic(e.genes)}}calculatePopulationDiversity(){let e=0,t=0;for(let s=0;s<this.population.length;s++)for(let i=s+1;i<this.population.length;i++)e+=this.calculateGeneticDistance(this.population[s].genes,this.population[i].genes),t++;return e/t}calculateGeneticDistance(e,t){return e.reduce((s,i,a)=>s+Math.abs(i-t[a]),0)}genesToMusic(e){return{frequencies:e.slice(0,4).map(t=>220+t*880),rhythms:e.slice(4,8).map(t=>t>.5?1:0),amplitudes:e.slice(8,12),effects:e.slice(12,16)}}reset(){this.dnaPointer=0,this.heartbeat.phase=0,Object.values(this.brainwaves).forEach(e=>e.phase=0),this.spiralAngle=0,this.cellularAutomaton=new Array(32).fill(0),this.cellularAutomaton[16]=1,this.ecosystem={predator:50,prey:100,vegetation:200,time:0},this.population=this.initializePopulation(16),this.generation=0}}class ne{constructor(e,t){this.audioContext=e,this.poolManager=t,this.bioPatterns=new ae,this.isPlaying=!1,this.scheduler=null,this.lastTime=0,this.connectCallback=null,this.activeVoices=new Set,this.params={density:.8,bioType:"dna",evolutionSpeed:1,naturalHarmony:.7,organicVariation:.5,lifeComplexity:.8,adaptiveGrowth:!0},this.ecosystemState={phase:"growth"}}start(e,t){this.isPlaying||(this.params={...this.params,...e},this.connectCallback=t,this.isPlaying=!0,this.lastTime=this.audioContext.currentTime,this.startBiologicalEvolution())}startBiologicalEvolution(){this.scheduler=setInterval(()=>{const t=this.audioContext.currentTime,s=(t-this.lastTime)*this.params.evolutionSpeed;this.lastTime=t,this.updateBiologicalState(s)},100)}updateBiologicalState(e){switch(this.params.bioType){case"dna":const t=this.bioPatterns.getDNAMusic();this.applyDNAMusic(t);break;case"heartbeat":const s=this.bioPatterns.getHeartbeatMusic(e);this.applyHeartbeatMusic(s);break;case"brainwave":const i=this.bioPatterns.getBrainwaveMusic(e);this.applyBrainwaveMusic(i);break;case"fibonacci":const a=this.bioPatterns.getFibonacciMusic();this.applyFibonacciMusic(a);break;case"cellular":const n=this.bioPatterns.getCellularAutomatonMusic();this.applyCellularMusic(n);break;case"ecosystem":const o=this.bioPatterns.getEcosystemMusic(e);this.applyEcosystemMusic(o);break;case"genetic":const r=this.bioPatterns.getGeneticMusic();Math.random()<.1&&this.bioPatterns.evolvePopulation(),this.applyGeneticMusic(r);break}}applyDNAMusic(e){if(Math.random()<this.params.density*.8){const t=Math.floor(Math.random()*e.scale.length),s=e.scale[t],i=e.baseFrequency*Math.pow(2,s/12);this.createSimpleVoice(i,1.5,"sine",this.params.lifeComplexity*.6)}e.geneExpression>.4&&this.createGeneExpressionEffect(e)}applyHeartbeatMusic(e){e.kick&&this.createHeartbeatVoice(e),e.harmonicCoherence>.5&&Math.random()<this.params.density*.8&&this.createSimpleVoice(100+e.harmonicCoherence*150,.8,"triangle",this.params.lifeComplexity*.5)}applyBrainwaveMusic(e){Object.keys(e).forEach(t=>{if(t.endsWith("Level"))return;const s=e[t];if(Math.abs(s.amplitude)>.2&&Math.random()<this.params.density*.6){const i=200+s.frequency*10;this.createSimpleVoice(i,3,"sine",this.params.lifeComplexity*.5)}})}applyFibonacciMusic(e){if(Math.random()<this.params.density*this.params.naturalHarmony){const t=Math.floor(Math.random()*e.frequencies.length),s=e.frequencies[t];this.createSimpleVoice(s,2,"triangle",this.params.naturalHarmony*this.params.lifeComplexity*.3)}}applyCellularMusic(e){e.triggers.forEach((t,s)=>{if(t&&Math.random()<this.params.density*.8){const i=220*Math.pow(2,s/12);this.createSimpleVoice(i,.1,e.complexity>.5?"square":"triangle",this.params.lifeComplexity*.6)}})}applyEcosystemMusic(e){const t=this.determineEcosystemPhase(e);t!==this.ecosystemState.phase&&(this.ecosystemState.phase=t),Math.random()<this.params.density*.8&&this.createEcosystemVoice(e)}applyGeneticMusic(e){const t=e.musicalGenes;t.rhythms.forEach((s,i)=>{if(s&&Math.random()<this.params.density*.7){const a=t.frequencies[i%t.frequencies.length],n=t.amplitudes[i%t.amplitudes.length];this.createSimpleVoice(a,.5+n,e.fitness>5?"sine":"sawtooth",this.params.lifeComplexity*.5)}})}createSimpleVoice(e,t,s,i){const a=this.audioContext.currentTime,n=`bio_${s}_${Date.now()}_${Math.random()}`,o=this.poolManager.pools.oscillator.acquireOscillator(n,{type:s,frequency:e}),r=this.poolManager.pools.gain.acquireGain(n,0);!o||!r||(r.gain.setValueAtTime(0,a),r.gain.linearRampToValueAtTime(i*.6,a+.1),r.gain.exponentialRampToValueAtTime(.01,a+t),o.connect(r),this.connectCallback&&this.connectCallback(r),this.activeVoices.add({osc:o,gain:r,nodeId:n}),o.stop(a+t),setTimeout(()=>{this.poolManager.pools.oscillator.release(o),this.poolManager.pools.gain.release(r),this.activeVoices.delete({osc:o,gain:r,nodeId:n})},t*1e3+100))}createGeneExpressionEffect(e){const t=this.audioContext.currentTime,s=3,i=`bio_gene_${Date.now()}_${Math.random()}`,a=this.poolManager.pools.oscillator.acquireOscillator(i,{type:"triangle",frequency:80+e.geneExpression*200}),n=this.poolManager.pools.gain.acquireGain(i,0);if(!a||!n)return;const o=e.geneExpression*this.params.lifeComplexity*.4;n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(o,t+1),n.gain.exponentialRampToValueAtTime(.01,t+s),a.connect(n),this.connectCallback&&this.connectCallback(n),this.activeVoices.add({osc:a,gain:n,nodeId:i}),a.stop(t+s),setTimeout(()=>{this.poolManager.pools.oscillator.release(a),this.poolManager.pools.gain.release(n),this.activeVoices.delete({osc:a,gain:n,nodeId:i})},s*1e3+100)}createHeartbeatVoice(e){const t=this.audioContext.currentTime,s=.4,i=`bio_heart_${Date.now()}_${Math.random()}`,a=this.poolManager.pools.oscillator.acquireOscillator(i,{type:"sine",frequency:40}),n=this.poolManager.pools.gain.acquireGain(i,0);if(!a||!n)return;const o=.9*this.params.lifeComplexity;n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(o,t+.05),n.gain.exponentialRampToValueAtTime(.01,t+s),a.connect(n),this.connectCallback&&this.connectCallback(n),this.activeVoices.add({osc:a,gain:n,nodeId:i}),a.stop(t+s),setTimeout(()=>{this.poolManager.pools.oscillator.release(a),this.poolManager.pools.gain.release(n),this.activeVoices.delete({osc:a,gain:n,nodeId:i})},s*1e3+100)}createEcosystemVoice(e){const t=this.audioContext.currentTime,s=2,i=`bio_prey_${Date.now()}_${Math.random()}`,a=this.poolManager.pools.oscillator.acquireOscillator(i,{type:"triangle",frequency:e.preyFreq}),n=this.poolManager.pools.gain.acquireGain(i,0);if(a&&n){const h=e.balance*.3*this.params.lifeComplexity;n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(h,t+.2),n.gain.exponentialRampToValueAtTime(.01,t+s),a.connect(n),this.connectCallback&&this.connectCallback(n),this.activeVoices.add({osc:a,gain:n,nodeId:i}),a.stop(t+s),setTimeout(()=>{this.poolManager.pools.oscillator.release(a),this.poolManager.pools.gain.release(n),this.activeVoices.delete({osc:a,gain:n,nodeId:i})},s*1e3+100)}const o=`bio_predator_${Date.now()}_${Math.random()}`,r=this.poolManager.pools.oscillator.acquireOscillator(o,{type:"sawtooth",frequency:e.predatorFreq}),c=this.poolManager.pools.gain.acquireGain(o,0);if(r&&c){const h=(1-e.balance)*.2*this.params.lifeComplexity;c.gain.setValueAtTime(0,t),c.gain.linearRampToValueAtTime(h,t+.2),c.gain.exponentialRampToValueAtTime(.01,t+s),r.connect(c),this.connectCallback&&this.connectCallback(c),this.activeVoices.add({osc:r,gain:c,nodeId:o}),r.stop(t+s),setTimeout(()=>{this.poolManager.pools.oscillator.release(r),this.poolManager.pools.gain.release(c),this.activeVoices.delete({osc:r,gain:c,nodeId:o})},s*1e3+100)}}determineEcosystemPhase(e){return e.tension>.8?"crisis":e.stability>.7?"stable":e.balance<.3?"decline":"growth"}updateParameter(e,t){this.params[e]=t,e==="bioType"&&this.bioPatterns.reset()}stop(){this.isPlaying=!1,this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),this.activeVoices.forEach(({osc:e,gain:t})=>{e&&this.poolManager.pools.oscillator.release(e),t&&this.poolManager.pools.gain.release(t)}),this.activeVoices.clear()}getOutputNode(){return null}}class oe{constructor(){this.lorenz={x:1,y:1,z:1},this.lorenzParams={sigma:10,rho:28,beta:2.6666666666666665,dt:.01},this.rossler={x:1,y:1,z:1},this.rosslerParams={a:.2,b:.2,c:5.7,dt:.01},this.chua={x:1,y:1,z:1},this.chuaParams={alpha:15.6,beta:28,m0:-1.143,m1:-.714,dt:.01},this.henon={x:0,y:0},this.henonParams={a:1.4,b:.3},this.logistic={x:.5},this.logisticParams={r:3.8},this.scalers={frequency:{min:50,max:2e3},amplitude:{min:0,max:1},filter:{min:100,max:8e3},time:{min:.01,max:2}}}stepLorenz(){const{x:e,y:t,z:s}=this.lorenz,{sigma:i,rho:a,beta:n,dt:o}=this.lorenzParams,r=i*(t-e),c=e*(a-s)-t,h=e*t-n*s;return this.lorenz.x+=r*o,this.lorenz.y+=c*o,this.lorenz.z+=h*o,{x:this.lorenz.x,y:this.lorenz.y,z:this.lorenz.z}}stepRossler(){const{x:e,y:t,z:s}=this.rossler,{a:i,b:a,c:n,dt:o}=this.rosslerParams,r=-t-s,c=e+i*t,h=a+s*(e-n);return this.rossler.x+=r*o,this.rossler.y+=c*o,this.rossler.z+=h*o,{x:this.rossler.x,y:this.rossler.y,z:this.rossler.z}}stepChua(){const{x:e,y:t,z:s}=this.chua,{alpha:i,beta:a,m0:n,m1:o,dt:r}=this.chuaParams,c=o*e+.5*(n-o)*(Math.abs(e+1)-Math.abs(e-1)),h=i*(t-e-c),l=e-t+s,d=-a*t;return this.chua.x+=h*r,this.chua.y+=l*r,this.chua.z+=d*r,{x:this.chua.x,y:this.chua.y,z:this.chua.z}}stepHenon(){const{x:e,y:t}=this.henon,{a:s,b:i}=this.henonParams;return this.henon.x=1-s*e*e+t,this.henon.y=i*e,{x:this.henon.x,y:this.henon.y}}stepLogistic(){const{x:e}=this.logistic,{r:t}=this.logisticParams;return this.logistic.x=t*e*(1-e),{x:this.logistic.x}}scaleToRange(e,t,s){const i=Math.max(0,Math.min(1,(e+20)/40));return t+i*(s-t)}getLorenzMusic(){const e=this.stepLorenz();return{frequency:this.scaleToRange(e.x,this.scalers.frequency.min,this.scalers.frequency.max),amplitude:this.scaleToRange(e.y,0,1),filter:this.scaleToRange(e.z,this.scalers.filter.min,this.scalers.filter.max),pan:Math.tanh(e.x/10),detune:e.y*10,resonance:this.scaleToRange(e.z,0,30)}}getRosslerMusic(){const e=this.stepRossler();return{rhythmTrigger:Math.abs(e.x)>5?1:0,tempo:this.scaleToRange(e.y,60,180),swing:this.scaleToRange(e.z,0,100),accent:this.scaleToRange(Math.abs(e.x),0,1),subdivision:Math.floor(this.scaleToRange(e.y,1,8))}}getChuaMusic(){const e=this.stepChua();return{glitchTrigger:Math.abs(e.x)>2?1:0,bitcrush:this.scaleToRange(Math.abs(e.y),1,16),distortion:this.scaleToRange(Math.abs(e.z),0,100),stutter:Math.abs(e.x)>3?1:0,reverse:Math.abs(e.y)>2?1:0}}getHenonMusic(){const e=this.stepHenon();return{pitch:this.scaleToRange(e.x,50,800),velocity:this.scaleToRange(Math.abs(e.y),0,1),gate:Math.abs(e.x)>.5?1:0,chord:Math.floor(this.scaleToRange(e.y,0,7))}}getLogisticMusic(){const e=this.stepLogistic();return{density:e.x,variation:1-e.x,probability:e.x,complexity:e.x>.5?e.x*2-1:0}}setLorenzParams(e,t,s){this.lorenzParams.sigma=e,this.lorenzParams.rho=t,this.lorenzParams.beta=s}setRosslerParams(e,t,s){this.rosslerParams.a=e,this.rosslerParams.b=t,this.rosslerParams.c=s}setChuaParams(e,t,s,i){this.chuaParams.alpha=e,this.chuaParams.beta=t,this.chuaParams.m0=s,this.chuaParams.m1=i}setHenonParams(e,t){this.henonParams.a=e,this.henonParams.b=t}setLogisticParams(e){this.logisticParams.r=e}reset(){this.lorenz={x:1,y:1,z:1},this.rossler={x:1,y:1,z:1},this.chua={x:1,y:1,z:1},this.henon={x:0,y:0},this.logistic={x:.5}}perturb(e=.01){this.lorenz.x+=(Math.random()-.5)*e,this.lorenz.y+=(Math.random()-.5)*e,this.lorenz.z+=(Math.random()-.5)*e,this.rossler.x+=(Math.random()-.5)*e,this.rossler.y+=(Math.random()-.5)*e,this.rossler.z+=(Math.random()-.5)*e}}class re{constructor(e,t){this.audioContext=e,this.poolManager=t,this.chaosEngine=new oe,this.isPlaying=!1,this.scheduler=null,this.masterConnection=null,this.activeNodes=new Set,this.params={density:.7,chaosType:"lorenz",chaosIntensity:.8,musicalScale:"pentatonic",harmonicResonance:.6,chaosSpeed:1,filterChaos:!0,morphingEnabled:!0},this.scales={pentatonic:[0,2,4,7,9],major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],dorian:[0,2,3,5,7,9,10],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11]},this.baseFrequency=220}start(e,t){this.isPlaying||(this.params={...this.params,...e},this.masterConnection=t,this.isPlaying=!0,this.startChaosEvolution())}startChaosEvolution(){const e=Math.max(50,1e3/(60*this.params.chaosSpeed));this.scheduler=setInterval(()=>{this.updateChaosState()},e)}updateChaosState(){switch(this.params.chaosType){case"lorenz":const e=this.chaosEngine.getLorenzMusic();this.applyLorenzChaos(e);break;case"rossler":const t=this.chaosEngine.getRosslerMusic();this.applyRosslerChaos(t);break;case"chua":const s=this.chaosEngine.getChuaMusic();this.applyChuaChaos(s);break;case"henon":const i=this.chaosEngine.getHenonMusic();this.applyHenonChaos(i);break;case"logistic":const a=this.chaosEngine.getLogisticMusic();this.applyLogisticChaos(a);break}}applyLorenzChaos(e){if(Math.random()<this.params.density*.8){const t=this.quantizeToScale(e.frequency);this.createChaosVoice(t,e,"lorenz")}}applyRosslerChaos(e){if(e.rhythmTrigger&&Math.random()<this.params.density){const t=this.quantizeToScale(this.baseFrequency*(1+e.accent));this.createChaosVoice(t,e,"rossler")}}applyChuaChaos(e){if(e.glitchTrigger&&Math.random()<this.params.density){const t=this.quantizeToScale(this.baseFrequency);this.createChaosVoice(t,e,"chua")}}applyHenonChaos(e){if(e.gate&&Math.random()<this.params.density){const t=this.scales[this.params.musicalScale],s=e.chord%t.length,i=this.baseFrequency*Math.pow(2,t[s]/12);this.createChaosVoice(i,e,"henon")}}applyLogisticChaos(e){if(Math.random()<e.density*this.params.density){const t=this.quantizeToScale(this.baseFrequency*(1+e.complexity*2));this.createChaosVoice(t,e,"logistic")}}createChaosVoice(e,t,s){const i=this.audioContext.currentTime,a=`chaos_${s}_${Date.now()}_${Math.random()}`;let n,o,r;switch(s){case"lorenz":n=2,o=this.params.chaosIntensity*.6,r="sawtooth";break;case"rossler":n=.3,o=this.params.chaosIntensity*.8,r="square";break;case"chua":n=.2,o=this.params.chaosIntensity*.7,r="sawtooth";break;case"henon":n=1,o=this.params.chaosIntensity*.6,r="sine";break;case"logistic":n=.5+(t.complexity||.5),o=this.params.chaosIntensity*.6,r="triangle";break;default:n=1,o=.6,r="sine"}const c=this.poolManager.pools.oscillator.acquireOscillator(a,{type:r,frequency:e}),h=this.poolManager.pools.gain.acquireGain(a,0);!c||!h||(s==="rossler"&&c.frequency.exponentialRampToValueAtTime(e*.5,i+.1),h.gain.setValueAtTime(0,i),h.gain.linearRampToValueAtTime(o,i+.1),h.gain.exponentialRampToValueAtTime(.01,i+n),c.connect(h),this.masterConnection&&this.masterConnection(h),this.activeNodes.add({osc:c,gain:h,nodeId:a}),c.stop(i+n),setTimeout(()=>{this.poolManager.pools.oscillator.release(c),this.poolManager.pools.gain.release(h),this.activeNodes.delete({osc:c,gain:h,nodeId:a})},n*1e3+100))}quantizeToScale(e){if(!this.params.filterChaos)return e;const t=this.scales[this.params.musicalScale],s=Math.floor(Math.log2(e/this.baseFrequency)),i=(Math.log2(e/this.baseFrequency)-s)*12;let a=t[0],n=Math.abs(i-t[0]);for(const o of t){const r=Math.abs(i-o);r<n&&(n=r,a=o)}return this.baseFrequency*Math.pow(2,s+a/12)}updateParameter(e,t){this.params[e]=t,e==="chaosIntensity"&&this.chaosEngine.perturb(t*.1)}stop(){this.isPlaying=!1,this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),this.activeNodes.forEach(({osc:e,gain:t})=>{e&&this.poolManager.pools.oscillator.release(e),t&&this.poolManager.pools.gain.release(t)}),this.activeNodes.clear()}getOutputNode(){return null}}class le{constructor(e,t){this.audioContext=e,this.poolManager=t,this.isPlaying=!1,this.samples=new Map,this.scheduler=null,this.masterNodes=null,this.currentParams=null,this.voiceId="sample",this.playbackNodes=[],this.processingChain={filter:null,reverb:null,delay:null,distortion:null,mixer:null},this.grainSchedulers=[],this.grainSize=.1,this.grainOverlap=.5,this.setupFileInput()}setupFileInput(){const e=document.createElement("input");e.type="file",e.multiple=!0,e.accept="audio/*",e.style.display="none",e.id="sampleFileInput",document.body.appendChild(e),e.addEventListener("change",t=>{this.loadSampleFiles(t.target.files)}),this.setupDragDrop()}setupDragDrop(){let e=document.getElementById("sampleSection");if(!e){console.warn("Sample section not found in DOM");return}e.addEventListener("dragover",t=>{t.preventDefault(),t.stopPropagation(),e.style.borderColor="#0f0"}),e.addEventListener("dragleave",t=>{t.preventDefault(),t.stopPropagation(),e.style.borderColor="#333"}),e.addEventListener("drop",t=>{t.preventDefault(),t.stopPropagation(),e.style.borderColor="#333";const s=Array.from(t.dataTransfer.files).filter(i=>i.type.startsWith("audio/"));s.length>0&&this.loadSampleFiles(s)})}async loadSampleFiles(e){const t=Array.from(e).map(s=>this.loadSampleFile(s));try{const s=await Promise.all(t),i=s.filter(n=>n.success),a=s.filter(n=>!n.success);console.log(`Loaded ${i.length} samples successfully`),a.length>0&&console.warn(`Failed to load ${a.length} samples`),this.updateSampleUI()}catch(s){console.error("Error loading samples:",s)}}async loadSampleFile(e){return new Promise(t=>{const s=new FileReader;s.onload=async i=>{try{const a=await this.audioContext.decodeAudioData(i.target.result),n=e.name.replace(/\.[^/.]+$/,"");this.samples.set(n,{buffer:a,name:n,duration:a.duration,sampleRate:a.sampleRate,channels:a.numberOfChannels,filename:e.name}),t({success:!0,name:n})}catch(a){console.error(`Failed to decode ${e.name}:`,a),t({success:!1,name:e.name,error:a})}},s.onerror=()=>{t({success:!1,name:e.name,error:"File read error"})},s.readAsArrayBuffer(e)})}updateSampleUI(){const e=document.getElementById("sampleMappingDisplay");if(!e)return;if(this.samples.size===0){e.style.display="none";return}e.style.display="block";let t='<h3>Loaded Samples</h3><div class="mapping-list">';this.samples.forEach((s,i)=>{t+=`
                <div class="mapping-item">
                    <span class="mapping-name">${i}</span>
                    <span>${s.duration.toFixed(2)}s • ${s.channels}ch</span>
                </div>
            `}),t+="</div>",e.innerHTML=t}start(e,t){if(this.isPlaying)return;this.masterNodes=t,this.currentParams=e;const{density:s,pitch:i,reverse:a,chop:n,scatter:o,granular:r,filterFreq:c,filterRes:h,reverbMix:l,delayMix:d}=e;s===0||this.samples.size===0||(this.createProcessingChain(e),this.isPlaying=!0,this.startScheduler(e),console.log("Sample player started"))}createProcessingChain(e){const{filterFreq:t,filterRes:s,reverbMix:i,delayMix:a}=e;this.processingChain.filter=this.audioContext.createBiquadFilter(),this.processingChain.filter.type="lowpass",this.processingChain.filter.frequency.value=t||5e3,this.processingChain.filter.Q.value=s||1,this.processingChain.mixer=this.audioContext.createGain(),this.processingChain.mixer.gain.value=.7,this.processingChain.filter.connect(this.processingChain.mixer),this.masterNodes&&(this.processingChain.mixer.connect(this.masterNodes.dryGain),this.processingChain.mixer.connect(this.masterNodes.convolver),this.processingChain.mixer.connect(this.masterNodes.delay))}startScheduler(e){const{density:t,scatter:s}=e,i=1e3/(t*2),a=s||0;this.scheduler=setInterval(()=>{if(Math.random()<t&&this.samples.size>0){const n=(Math.random()-.5)*a*100;setTimeout(()=>{this.playSample(e)},Math.max(0,n))}},i)}playSample(e){const{pitch:t,reverse:s,chop:i,granular:a}=e,n=Array.from(this.samples.keys()),o=n[Math.floor(Math.random()*n.length)],r=this.samples.get(o);r&&(a&&a>0?this.playGranularSample(r,e):this.playDirectSample(r,e))}playDirectSample(e,t){const{pitch:s,reverse:i,chop:a}=t,n=this.audioContext.createBufferSource();if(n.buffer=e.buffer,s!==void 0&&s!==1&&(n.playbackRate.value=s),i&&i>0&&Math.random()<i){const l=this.reverseBuffer(e.buffer);n.buffer=l}const o=this.audioContext.createGain();o.gain.value=.5+Math.random()*.5,n.connect(o),o.connect(this.processingChain.filter);let r=0,c=e.duration;if(a&&a>0){const l=a,d=e.duration*.5,p=Math.random()*d*l;r=Math.random()*(e.duration-p),c=p}const h=this.audioContext.currentTime;n.start(h,r,c),this.playbackNodes.push(n),n.addEventListener("ended",()=>{const l=this.playbackNodes.indexOf(n);l>-1&&this.playbackNodes.splice(l,1)})}playGranularSample(e,t){const{granular:s,pitch:i}=t,a=Math.floor(s*10)+1;for(let n=0;n<a;n++)setTimeout(()=>{const o=this.audioContext.createBufferSource();o.buffer=e.buffer;const r=Math.random()*(e.duration-this.grainSize),c=i*(.8+Math.random()*.4);o.playbackRate.value=c;const h=this.audioContext.createGain();h.gain.value=0;const l=this.audioContext.currentTime,d=this.grainSize*.1;h.gain.setValueAtTime(0,l),h.gain.linearRampToValueAtTime(.3,l+d),h.gain.linearRampToValueAtTime(.3,l+this.grainSize-d),h.gain.linearRampToValueAtTime(0,l+this.grainSize),o.connect(h),h.connect(this.processingChain.filter),o.start(l,r,this.grainSize),this.playbackNodes.push(o)},n*this.grainSize*this.grainOverlap*1e3)}reverseBuffer(e){const t=this.audioContext.createBuffer(e.numberOfChannels,e.length,e.sampleRate);for(let s=0;s<e.numberOfChannels;s++){const i=e.getChannelData(s),a=t.getChannelData(s);for(let n=0;n<i.length;n++)a[n]=i[i.length-1-n]}return t}stop(){this.isPlaying&&(this.isPlaying=!1,this.scheduler&&(clearInterval(this.scheduler),this.scheduler=null),this.playbackNodes.forEach(e=>{try{e.stop()}catch{}}),this.playbackNodes=[],this.grainSchedulers.forEach(e=>clearTimeout(e)),this.grainSchedulers=[],this.processingChain.mixer&&this.processingChain.mixer.disconnect(),console.log("Sample player stopped"))}updateTempo(e){if(this.masterTempo=e,this.isPlaying&&this.scheduler){const t=this.currentParams;t&&(t.tempoSync=e,this.stop(),this.start(t,this.masterNodes))}}updateParameter(e,t){switch(e){case"filterFreq":this.processingChain.filter&&(this.processingChain.filter.frequency.value=t);break;case"filterRes":this.processingChain.filter&&(this.processingChain.filter.Q.value=t);break;case"volume":this.processingChain.mixer&&(this.processingChain.mixer.gain.value=t);break}}getOutputNode(){return this.processingChain.mixer}getSampleCount(){return this.samples.size}getSampleNames(){return Array.from(this.samples.keys())}clearSamples(){this.samples.clear(),this.updateSampleUI()}}class ce{constructor(e){this.audioContext=e,this.nodes={convolver:null,wetGain:null,dryGain:null,input:null,output:null},this.isInitialized=!1}initialize(e=1){this.isInitialized||(this.nodes.convolver=this.audioContext.createConvolver(),this.nodes.wetGain=this.audioContext.createGain(),this.nodes.dryGain=this.audioContext.createGain(),this.nodes.input=this.audioContext.createGain(),this.nodes.output=this.audioContext.createGain(),this.updateImpulse(e),this.setMix(.3),this.nodes.input.connect(this.nodes.dryGain),this.nodes.input.connect(this.nodes.convolver),this.nodes.convolver.connect(this.nodes.wetGain),this.nodes.dryGain.connect(this.nodes.output),this.nodes.wetGain.connect(this.nodes.output),this.isInitialized=!0)}updateImpulse(e=1){const t=e<.7?1:2,s=$(this.audioContext,t,2);this.nodes.convolver&&(this.nodes.convolver.buffer=s)}setMix(e){const t=Math.max(0,Math.min(1,e));this.nodes.wetGain&&(this.nodes.wetGain.gain.value=t),this.nodes.dryGain&&(this.nodes.dryGain.gain.value=1-t*.5)}connect(e){this.nodes.output&&e&&this.nodes.output.connect(e)}disconnect(){Object.values(this.nodes).forEach(e=>{if(e&&e.disconnect)try{e.disconnect()}catch{}})}getInputNode(){return this.nodes.input}getOutputNode(){return this.nodes.output}getConvolverNode(){return this.nodes.convolver}}class he{constructor(e){this.audioContext=e,this.nodes={delay:null,feedback:null,wetGain:null,dryGain:null,filter:null,input:null,output:null},this.isInitialized=!1}initialize(){this.isInitialized||(this.nodes.delay=this.audioContext.createDelay(2),this.nodes.feedback=this.audioContext.createGain(),this.nodes.wetGain=this.audioContext.createGain(),this.nodes.dryGain=this.audioContext.createGain(),this.nodes.filter=this.audioContext.createBiquadFilter(),this.nodes.filter.type="lowpass",this.nodes.filter.frequency.value=5e3,this.nodes.input=this.audioContext.createGain(),this.nodes.output=this.audioContext.createGain(),this.setDelayTime(.375),this.setFeedback(.4),this.setMix(.3),this.nodes.input.connect(this.nodes.dryGain),this.nodes.input.connect(this.nodes.delay),this.nodes.delay.connect(this.nodes.filter),this.nodes.filter.connect(this.nodes.feedback),this.nodes.feedback.connect(this.nodes.delay),this.nodes.filter.connect(this.nodes.wetGain),this.nodes.dryGain.connect(this.nodes.output),this.nodes.wetGain.connect(this.nodes.output),this.isInitialized=!0)}setDelayTime(e){if(this.nodes.delay){const t=Math.max(0,Math.min(2,e));this.nodes.delay.delayTime.value=t}}setFeedback(e){if(this.nodes.feedback){const t=Math.max(0,Math.min(.6,e));this.nodes.feedback.gain.value=t*.5}}setMix(e){const t=Math.max(0,Math.min(1,e));this.nodes.wetGain&&(this.nodes.wetGain.gain.value=t),this.nodes.dryGain&&(this.nodes.dryGain.gain.value=1)}setFilterFrequency(e){this.nodes.filter&&(this.nodes.filter.frequency.value=e)}syncToTempo(e,t="8d"){const s=60/e;let i;switch(t){case"4":i=s;break;case"8":i=s/2;break;case"8d":i=s*.75;break;case"16":i=s/4;break;case"8t":i=s/3;break;default:i=s*.75}this.setDelayTime(i)}connect(e){this.nodes.output&&e&&this.nodes.output.connect(e)}disconnect(){Object.values(this.nodes).forEach(e=>{if(e&&e.disconnect)try{e.disconnect()}catch{}})}getInputNode(){return this.nodes.input}getOutputNode(){return this.nodes.output}getDelayNode(){return this.nodes.delay}}class de{constructor(e){this.audioContext=e,this.input=this.audioContext.createGain(),this.output=this.audioContext.createGain(),this.compressor=this.audioContext.createDynamicsCompressor(),this.compressor.threshold.value=-24,this.compressor.knee.value=30,this.compressor.ratio.value=12,this.compressor.attack.value=.003,this.compressor.release.value=.25,this.limiter=this.audioContext.createDynamicsCompressor(),this.limiter.threshold.value=-3,this.limiter.knee.value=0,this.limiter.ratio.value=20,this.limiter.attack.value=.001,this.limiter.release.value=.1,this.makeupGain=this.audioContext.createGain(),this.makeupGain.gain.value=1,this.dryGain=this.audioContext.createGain(),this.wetGain=this.audioContext.createGain(),this.dryGain.gain.value=0,this.wetGain.gain.value=1,this.input.connect(this.dryGain),this.input.connect(this.compressor),this.compressor.connect(this.limiter),this.limiter.connect(this.makeupGain),this.makeupGain.connect(this.wetGain),this.dryGain.connect(this.output),this.wetGain.connect(this.output),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=256,this.makeupGain.connect(this.analyser)}setThreshold(e){const t=-60+e/100*60;this.compressor.threshold.setValueAtTime(t,this.audioContext.currentTime)}setRatio(e){const t=1+e/100*19;this.compressor.ratio.setValueAtTime(t,this.audioContext.currentTime)}setAttack(e){const t=.001+e/100*.999;this.compressor.attack.setValueAtTime(t,this.audioContext.currentTime)}setRelease(e){const t=.01+e/100*1.99;this.compressor.release.setValueAtTime(t,this.audioContext.currentTime)}setKnee(e){const t=e/100*40;this.compressor.knee.setValueAtTime(t,this.audioContext.currentTime)}setMakeupGain(e){const t=e/100*2;this.makeupGain.gain.setValueAtTime(t,this.audioContext.currentTime)}setLimiterThreshold(e){const t=-12+e/100*12;this.limiter.threshold.setValueAtTime(t,this.audioContext.currentTime)}setMix(e){const t=e/100,s=1-t;this.dryGain.gain.setValueAtTime(s,this.audioContext.currentTime),this.wetGain.gain.setValueAtTime(t,this.audioContext.currentTime)}getInputNode(){return this.input}getOutputNode(){return this.output}getReductionAmount(){return this.compressor.reduction}disconnect(){this.input.disconnect(),this.output.disconnect(),this.compressor.disconnect(),this.limiter.disconnect(),this.makeupGain.disconnect(),this.dryGain.disconnect(),this.wetGain.disconnect(),this.analyser.disconnect()}}class ue{constructor(e){this.audioContext=e,this.input=this.audioContext.createGain(),this.output=this.audioContext.createGain(),this.bands={highpass:this.createBand("highpass",80,.7),lowShelf:this.createBand("lowshelf",320,.7),lowMid:this.createBand("peaking",650,.7),mid:this.createBand("peaking",1e3,.7),highMid:this.createBand("peaking",3200,.7),highShelf:this.createBand("highshelf",4800,.7),lowpass:this.createBand("lowpass",12e3,.7)};let t=this.input;Object.values(this.bands).forEach(s=>{t.connect(s.filter),t=s.filter}),t.connect(this.output),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.output.connect(this.analyser)}createBand(e,t,s){const i=this.audioContext.createBiquadFilter();return i.type=e,i.frequency.value=t,i.Q.value=s,i.gain.value=0,{filter:i,type:e,defaultFreq:t,defaultQ:s}}setHighpass(e){this.bands.highpass.filter.frequency.setValueAtTime(e,this.audioContext.currentTime)}setLowShelfGain(e){this.bands.lowShelf.filter.gain.setValueAtTime(e,this.audioContext.currentTime)}setLowShelfFreq(e){this.bands.lowShelf.filter.frequency.setValueAtTime(e,this.audioContext.currentTime)}setLowMidGain(e){this.bands.lowMid.filter.gain.setValueAtTime(e,this.audioContext.currentTime)}setLowMidFreq(e){this.bands.lowMid.filter.frequency.setValueAtTime(e,this.audioContext.currentTime)}setLowMidQ(e){this.bands.lowMid.filter.Q.setValueAtTime(e,this.audioContext.currentTime)}setMidGain(e){this.bands.mid.filter.gain.setValueAtTime(e,this.audioContext.currentTime)}setMidFreq(e){this.bands.mid.filter.frequency.setValueAtTime(e,this.audioContext.currentTime)}setMidQ(e){this.bands.mid.filter.Q.setValueAtTime(e,this.audioContext.currentTime)}setHighMidGain(e){this.bands.highMid.filter.gain.setValueAtTime(e,this.audioContext.currentTime)}setHighMidFreq(e){this.bands.highMid.filter.frequency.setValueAtTime(e,this.audioContext.currentTime)}setHighMidQ(e){this.bands.highMid.filter.Q.setValueAtTime(e,this.audioContext.currentTime)}setHighShelfGain(e){this.bands.highShelf.filter.gain.setValueAtTime(e,this.audioContext.currentTime)}setHighShelfFreq(e){this.bands.highShelf.filter.frequency.setValueAtTime(e,this.audioContext.currentTime)}setLowpass(e){this.bands.lowpass.filter.frequency.setValueAtTime(e,this.audioContext.currentTime)}applyPreset(e){switch(e){case"flat":this.resetAllBands();break;case"brighteness":this.setLowShelfGain(-2),this.setMidGain(1),this.setHighMidGain(3),this.setHighShelfGain(4);break;case"warmth":this.setLowShelfGain(3),this.setLowMidGain(2),this.setMidGain(-1),this.setHighShelfGain(-3);break;case"presence":this.setLowMidGain(-2),this.setMidGain(3),this.setHighMidGain(4);break;case"telephone":this.setHighpass(300),this.setLowpass(3400),this.setMidGain(6);break;case"radio":this.setHighpass(100),this.setLowpass(1e4),this.setLowShelfGain(-3),this.setHighShelfGain(-3),this.setMidGain(2);break}}resetAllBands(){Object.values(this.bands).forEach(e=>{(e.type==="peaking"||e.type==="lowshelf"||e.type==="highshelf")&&(e.filter.gain.value=0),e.filter.frequency.value=e.defaultFreq,e.filter.Q.value=e.defaultQ})}getFrequencyResponse(e){const t=new Float32Array(e.length),s=new Float32Array(e.length),i=new Float32Array(e.length),a=new Float32Array(e.length);for(let n=0;n<e.length;n++)t[n]=1,s[n]=0;return Object.values(this.bands).forEach(n=>{n.filter.getFrequencyResponse(e,i,a);for(let o=0;o<e.length;o++)t[o]*=i[o],s[o]+=a[o]}),{magnitude:t,phase:s}}getInputNode(){return this.input}getOutputNode(){return this.output}disconnect(){this.input.disconnect(),this.output.disconnect(),Object.values(this.bands).forEach(e=>{e.filter.disconnect()}),this.analyser.disconnect()}}class me{constructor(e){this.audioContext=e,this.input=this.audioContext.createGain(),this.output=this.audioContext.createGain(),this.preGain=this.audioContext.createGain(),this.preGain.gain.value=1,this.waveshaper=this.audioContext.createWaveShaper(),this.waveshaper.oversample="4x",this.postGain=this.audioContext.createGain(),this.postGain.gain.value=.5,this.toneFilter=this.audioContext.createBiquadFilter(),this.toneFilter.type="lowpass",this.toneFilter.frequency.value=3e3,this.toneFilter.Q.value=.7,this.preFilter=this.audioContext.createBiquadFilter(),this.preFilter.type="highpass",this.preFilter.frequency.value=20,this.dryGain=this.audioContext.createGain(),this.wetGain=this.audioContext.createGain(),this.dryGain.gain.value=0,this.wetGain.gain.value=1,this.input.connect(this.dryGain),this.input.connect(this.preFilter),this.preFilter.connect(this.preGain),this.preGain.connect(this.waveshaper),this.waveshaper.connect(this.toneFilter),this.toneFilter.connect(this.postGain),this.postGain.connect(this.wetGain),this.dryGain.connect(this.output),this.wetGain.connect(this.output),this.setDistortionType("soft")}createDistortionCurve(e,t="soft"){const i=new Float32Array(44100);for(let a=0;a<44100;a++){const n=a*2/44100-1;switch(t){case"soft":i[a]=Math.tanh(n*e);break;case"hard":const o=1/e;n>o?i[a]=1:n<-o?i[a]=-1:i[a]=n*e;break;case"fuzz":const r=e*10;i[a]=Math.sign(n)*Math.min(Math.abs(n*r),1),i[a]=Math.sin(i[a]*Math.PI*.5);break;case"bitcrush":const c=Math.max(1,16-e*2),h=2/Math.pow(2,c);i[a]=Math.round(n/h)*h;break;case"fold":let l=n*e;for(;Math.abs(l)>1;)l=Math.sign(l)*(2-Math.abs(l));i[a]=l;break;case"asymmetric":n>0?i[a]=Math.tanh(n*e*.7):i[a]=Math.tanh(n*e*1.3);break;case"warm":const d=e*.7;i[a]=n*(1-Math.abs(n)*d*.25),i[a]=Math.tanh(i[a]*1.5);break}}return i}setDistortionType(e){this.distortionType=e,this.updateCurve()}setDrive(e){this.driveAmount=1+e/100*99,this.updateCurve();const t=1+e/100*4;this.preGain.gain.setValueAtTime(t,this.audioContext.currentTime)}updateCurve(){this.driveAmount&&this.distortionType&&(this.waveshaper.curve=this.createDistortionCurve(this.driveAmount,this.distortionType))}setTone(e){const t=200+e/100*9800;this.toneFilter.frequency.setValueAtTime(t,this.audioContext.currentTime)}setOutput(e){const t=e/100;this.postGain.gain.setValueAtTime(t,this.audioContext.currentTime)}setMix(e){const t=e/100,s=1-t;this.dryGain.gain.setValueAtTime(s,this.audioContext.currentTime),this.wetGain.gain.setValueAtTime(t,this.audioContext.currentTime)}setPreFilterFreq(e){this.preFilter.frequency.setValueAtTime(e,this.audioContext.currentTime)}applyPreset(e){switch(e){case"clean":this.setDistortionType("warm"),this.setDrive(5),this.setTone(80),this.setOutput(90),this.setMix(50);break;case"crunch":this.setDistortionType("soft"),this.setDrive(40),this.setTone(60),this.setOutput(70),this.setMix(80);break;case"lead":this.setDistortionType("asymmetric"),this.setDrive(70),this.setTone(70),this.setOutput(60),this.setMix(90);break;case"fuzz":this.setDistortionType("fuzz"),this.setDrive(80),this.setTone(40),this.setOutput(50),this.setMix(100);break;case"destroyed":this.setDistortionType("hard"),this.setDrive(95),this.setTone(30),this.setOutput(40),this.setMix(100);break}}getInputNode(){return this.input}getOutputNode(){return this.output}disconnect(){this.input.disconnect(),this.output.disconnect(),this.preGain.disconnect(),this.waveshaper.disconnect(),this.postGain.disconnect(),this.toneFilter.disconnect(),this.preFilter.disconnect(),this.dryGain.disconnect(),this.wetGain.disconnect()}}class pe{constructor(e){this.audioContext=e,this.input=this.audioContext.createGain(),this.output=this.audioContext.createGain(),this.delays=[],this.lfos=[],this.delayGains=[],this.numVoices=3,this.feedbackGain=this.audioContext.createGain(),this.feedbackGain.gain.value=0,this.highpass=this.audioContext.createBiquadFilter(),this.highpass.type="highpass",this.highpass.frequency.value=20,this.dryGain=this.audioContext.createGain(),this.wetGain=this.audioContext.createGain(),this.dryGain.gain.value=.5,this.wetGain.gain.value=.5;for(let t=0;t<this.numVoices;t++){const s=this.audioContext.createDelay(.1);s.delayTime.value=.01+t*.003;const i=this.audioContext.createOscillator();i.type="sine",i.frequency.value=.5+t*.1;const a=this.audioContext.createGain();a.gain.value=.002;const n=this.audioContext.createGain();n.gain.value=1/this.numVoices,i.connect(a),a.connect(s.delayTime),this.delays.push(s),this.lfos.push({osc:i,gain:a}),this.delayGains.push(n),i.start()}this.connectNodes(),this.mode="chorus"}connectNodes(){this.input.connect(this.dryGain),this.input.connect(this.highpass);for(let e=0;e<this.numVoices;e++)this.highpass.connect(this.delays[e]),this.delays[e].connect(this.delayGains[e]),this.delayGains[e].connect(this.wetGain),this.delays[e].connect(this.feedbackGain);this.feedbackGain.connect(this.highpass),this.dryGain.connect(this.output),this.wetGain.connect(this.output)}setMode(e){switch(this.mode=e,e){case"chorus":this.setDelayRange(15,30),this.setModDepth(30),this.setRate(30),this.setFeedback(0),this.setMix(50);break;case"flanger":this.setDelayRange(1,10),this.setModDepth(50),this.setRate(20),this.setFeedback(50),this.setMix(50);break;case"doubler":this.setDelayRange(20,40),this.setModDepth(10),this.setRate(10),this.setFeedback(0),this.setMix(50);break;case"vibrato":this.setDelayRange(5,10),this.setModDepth(80),this.setRate(60),this.setFeedback(0),this.setMix(100);break}}setDelayRange(e,t){const s=e/1e3,i=(t-e)/1e3;for(let a=0;a<this.numVoices;a++){const n=a/this.numVoices*i;this.delays[a].delayTime.setValueAtTime(s+n,this.audioContext.currentTime)}}setRate(e){const t=.1+e/100*9.9;for(let s=0;s<this.numVoices;s++){const i=t*(1+s*.1);this.lfos[s].osc.frequency.setValueAtTime(i,this.audioContext.currentTime)}}setModDepth(e){const t=e/100*.005;for(let s=0;s<this.numVoices;s++)this.lfos[s].gain.gain.setValueAtTime(t,this.audioContext.currentTime)}setFeedback(e){const t=e/100*.9;this.feedbackGain.gain.setValueAtTime(t,this.audioContext.currentTime)}setMix(e){const t=e/100,s=1-t;this.dryGain.gain.setValueAtTime(s,this.audioContext.currentTime),this.wetGain.gain.setValueAtTime(t,this.audioContext.currentTime)}setVoices(e){e=Math.max(1,Math.min(3,e));for(let t=0;t<this.numVoices;t++){const s=t<e?1/e:0;this.delayGains[t].gain.setValueAtTime(s,this.audioContext.currentTime)}}setSpread(e){}getInputNode(){return this.input}getOutputNode(){return this.output}disconnect(){this.input.disconnect(),this.output.disconnect(),this.dryGain.disconnect(),this.wetGain.disconnect(),this.highpass.disconnect(),this.feedbackGain.disconnect();for(let e=0;e<this.numVoices;e++)this.delays[e].disconnect(),this.lfos[e].osc.stop(),this.lfos[e].osc.disconnect(),this.lfos[e].gain.disconnect(),this.delayGains[e].disconnect()}}class ge{constructor(e){this.audioContext=e,this.input=this.audioContext.createGain(),this.sidechain=this.audioContext.createGain(),this.output=this.audioContext.createGain(),this.duckGain=this.audioContext.createGain(),this.duckGain.gain.value=1,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=256,this.analyser.smoothingTimeConstant=.3,this.threshold=.5,this.ratio=4,this.attack=.005,this.release=.1,this.knee=.1,this.sidechainFilter=this.audioContext.createBiquadFilter(),this.sidechainFilter.type="lowpass",this.sidechainFilter.frequency.value=200,this.sidechainFilter.Q.value=1,this.input.connect(this.duckGain),this.duckGain.connect(this.output),this.sidechain.connect(this.sidechainFilter),this.sidechainFilter.connect(this.analyser),this.startDucking(),this.lfoMode=!1,this.lfo=null,this.lfoGain=null}startDucking(){const e=this.analyser.frequencyBinCount,t=new Float32Array(e),s=()=>{if(!this.lfoMode){this.analyser.getFloatTimeDomainData(t);let i=0;for(let c=0;c<e;c++)i+=t[c]*t[c];const a=Math.sqrt(i/e),n=this.calculateGain(a),o=this.duckGain.gain.value,r=this.audioContext.currentTime;n<o?(this.duckGain.gain.cancelScheduledValues(r),this.duckGain.gain.setValueAtTime(o,r),this.duckGain.gain.linearRampToValueAtTime(n,r+this.attack)):(this.duckGain.gain.cancelScheduledValues(r),this.duckGain.gain.setValueAtTime(o,r),this.duckGain.gain.linearRampToValueAtTime(n,r+this.release))}this.animationFrame=requestAnimationFrame(s)};s()}calculateGain(e){const t=20*Math.log10(Math.max(1e-5,e)),s=20*Math.log10(this.threshold);let i=0;if(t>s){const a=t-s;if(this.knee>0&&a<this.knee){const n=a/this.knee,o=1+(this.ratio-1)*n*n;i=a*(1-1/o)}else i=a*(1-1/this.ratio)}return Math.pow(10,-i/20)}setThreshold(e){this.threshold=.01+e/100*.99}setRatio(e){this.ratio=1+e/100*19}setAttack(e){this.attack=.001+e/100*.049}setRelease(e){this.release=.01+e/100*.49}setKnee(e){this.knee=e/100}setSidechainFilter(e){this.sidechainFilter.frequency.setValueAtTime(e,this.audioContext.currentTime)}setLFOMode(e,t=2){if(this.lfoMode=e,e){if(!this.lfo){this.lfo=this.audioContext.createOscillator(),this.lfo.type="sine",this.lfo.frequency.value=t,this.lfoGain=this.audioContext.createGain(),this.lfoGain.gain.value=.5;const s=this.audioContext.createConstantSource();s.offset.value=.5,this.lfo.connect(this.lfoGain),s.connect(this.duckGain.gain),this.lfoGain.connect(this.duckGain.gain),this.lfo.start(),s.start(),this.lfoOffset=s}}else this.lfo&&(this.lfo.stop(),this.lfo.disconnect(),this.lfoGain.disconnect(),this.lfoOffset.stop(),this.lfoOffset.disconnect(),this.lfo=null,this.lfoGain=null,this.lfoOffset=null,this.duckGain.gain.cancelScheduledValues(this.audioContext.currentTime),this.duckGain.gain.setValueAtTime(1,this.audioContext.currentTime))}setLFORate(e){this.lfo&&this.lfo.frequency.setValueAtTime(e,this.audioContext.currentTime)}setLFODepth(e){if(this.lfoGain){const t=e/100*.5;this.lfoGain.gain.setValueAtTime(t,this.audioContext.currentTime)}}setPumpPattern(e){const s={quarter:2,eighth:4,sixteenth:8,triplet:6};s[e]&&this.setLFORate(s[e])}getInputNode(){return this.input}getSidechainNode(){return this.sidechain}getOutputNode(){return this.output}getCurrentReduction(){const e=this.duckGain.gain.value;return-20*Math.log10(Math.max(1e-5,e))}disconnect(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.input.disconnect(),this.output.disconnect(),this.sidechain.disconnect(),this.duckGain.disconnect(),this.analyser.disconnect(),this.sidechainFilter.disconnect(),this.lfo&&(this.lfo.stop(),this.lfo.disconnect(),this.lfoGain.disconnect(),this.lfoOffset.stop(),this.lfoOffset.disconnect())}}class fe{constructor(e){this.audioContext=e,this.nodes={input:null,output:null,masterGain:null},this.reverb=new ce(e),this.delay=new he(e),this.compressor=new de(e),this.eq=new ue(e),this.distortion=new me(e),this.chorus=new pe(e),this.sidechain=new ge(e),this.effectBypassed={compressor:!1,eq:!1,distortion:!1,chorus:!1,sidechain:!1},this.isInitialized=!1}initialize(e=1){this.isInitialized||(this.nodes.input=this.audioContext.createGain(),this.nodes.masterGain=this.audioContext.createGain(),this.nodes.output=this.nodes.masterGain,this.reverb.initialize(e),this.delay.initialize(),this.nodes.input.connect(this.distortion.getInputNode()),this.distortion.getOutputNode().connect(this.eq.getInputNode()),this.eq.getOutputNode().connect(this.compressor.getInputNode()),this.compressor.getOutputNode().connect(this.chorus.getInputNode()),this.chorus.getOutputNode().connect(this.sidechain.getInputNode()),this.sidechain.getOutputNode().connect(this.reverb.getInputNode()),this.sidechain.getOutputNode().connect(this.delay.getInputNode()),this.reverb.connect(this.nodes.masterGain),this.delay.connect(this.nodes.masterGain),this.distortion.setMix(0),this.eq.applyPreset("flat"),this.compressor.setMix(100),this.chorus.setMix(0),this.sidechain.setLFOMode(!1),this.nodes.masterGain.connect(this.audioContext.destination),this.setMasterVolume(.7),this.isInitialized=!0)}setMasterVolume(e){this.nodes.masterGain&&(this.nodes.masterGain.gain.value=Math.max(0,Math.min(1,e)))}setReverbMix(e){this.reverb.setMix(e)}setDelayTime(e){this.delay.setDelayTime(e)}setDelayFeedback(e){this.delay.setFeedback(e)}setDelayMix(e){this.delay.setMix(e)}updatePerformance(e){this.reverb.updateImpulse(e)}getConnectionNodes(){return{dryGain:this.nodes.input,convolver:this.reverb.getConvolverNode(),delay:this.delay.getDelayNode(),sidechain:this.sidechain.getSidechainNode()}}getInputNode(){return this.nodes.input}setCompressorThreshold(e){this.compressor.setThreshold(e)}setCompressorRatio(e){this.compressor.setRatio(e)}setCompressorAttack(e){this.compressor.setAttack(e)}setCompressorRelease(e){this.compressor.setRelease(e)}setCompressorMakeup(e){this.compressor.setMakeupGain(e)}setEQHighpass(e){this.eq.setHighpass(e)}setEQLowShelf(e){this.eq.setLowShelfGain(e)}setEQMidGain(e){this.eq.setMidGain(e)}setEQHighShelf(e){this.eq.setHighShelfGain(e)}setEQPreset(e){this.eq.applyPreset(e)}setDistortionType(e){this.distortion.setDistortionType(e)}setDistortionDrive(e){this.distortion.setDrive(e)}setDistortionTone(e){this.distortion.setTone(e)}setDistortionMix(e){this.distortion.setMix(e)}setChorusMode(e){this.chorus.setMode(e)}setChorusRate(e){this.chorus.setRate(e)}setChorusDepth(e){this.chorus.setModDepth(e)}setChorusMix(e){this.chorus.setMix(e)}setSidechainThreshold(e){this.sidechain.setThreshold(e)}setSidechainRatio(e){this.sidechain.setRatio(e)}setSidechainPumpMode(e,t){this.sidechain.setLFOMode(e),e&&t&&this.sidechain.setPumpPattern(t)}disconnect(){this.reverb.disconnect(),this.delay.disconnect(),this.compressor.disconnect(),this.eq.disconnect(),this.distortion.disconnect(),this.chorus.disconnect(),this.sidechain.disconnect(),Object.values(this.nodes).forEach(e=>{if(e&&e.disconnect)try{e.disconnect()}catch{}})}}class O{constructor(e,t,s=100){this.audioContext=e,this.createNodeFn=t,this.maxSize=s,this.available=[],this.active=new Map,this.totalCreated=0}acquire(e){let t=this.available.pop();return t||(t=this.createNodeFn(this.audioContext),this.totalCreated++),this.active.set(t,{id:e,acquiredAt:Date.now()}),t}release(e){if(!this.active.has(e)){console.warn("Attempting to release untracked node");return}try{if(e.disconnect(),e.frequency&&e.frequency.cancelScheduledValues(0),e.gain&&e.gain.cancelScheduledValues(0),e.detune&&e.detune.cancelScheduledValues(0),e.stop&&typeof e.stop=="function")try{e.stop()}catch{}}catch(t){console.warn("Error cleaning up node:",t)}this.active.delete(e),this.available.length<this.maxSize&&this.available.push(e)}releaseById(e){const t=[];this.active.forEach((s,i)=>{s.id===e&&t.push(i)}),t.forEach(s=>this.release(s))}cleanupOld(e=3e4){const t=Date.now(),s=[];this.active.forEach((i,a)=>{t-i.acquiredAt>e&&s.push(a)}),s.forEach(i=>this.release(i))}getStats(){return{available:this.available.length,active:this.active.size,totalCreated:this.totalCreated,poolEfficiency:this.totalCreated>0?((this.totalCreated-this.active.size)/this.totalCreated*100).toFixed(1)+"%":"0%"}}clear(){Array.from(this.active.keys()).forEach(t=>this.release(t)),this.available=[]}}class ye extends O{constructor(e,t=50){super(e,s=>s.createOscillator(),t)}acquireOscillator(e,t={}){const s=this.acquire(e);t.type&&(s.type=t.type),t.frequency!==void 0&&(s.frequency.value=t.frequency),t.detune!==void 0&&(s.detune.value=t.detune);try{s.start()}catch{}return s}}class ve extends O{constructor(e,t=100){super(e,s=>s.createGain(),t)}acquireGain(e,t=1){const s=this.acquire(e);return s.gain.value=t,s}}class xe{constructor(e,t=30){this.audioContext=e,this.maxSize=t,this.totalCreated=0,this.active=new Map}acquireBufferSource(e,t,s={}){const i=this.audioContext.createBufferSource();return this.active.set(i,{id:e,acquiredAt:Date.now()}),this.totalCreated++,t&&!i.buffer&&(i.buffer=t),s.loop!==void 0&&(i.loop=s.loop),s.playbackRate!==void 0&&(i.playbackRate.value=s.playbackRate),s.loopStart!==void 0&&(i.loopStart=s.loopStart),s.loopEnd!==void 0&&(i.loopEnd=s.loopEnd),i}release(e){this.active.has(e)&&this.active.delete(e)}getStats(){return{available:0,active:this.active.size,totalCreated:this.totalCreated,poolEfficiency:"0%"}}cleanupOld(e=3e4){const t=Date.now(),s=[];this.active.forEach((i,a)=>{t-i.acquiredAt>e&&s.push(a)}),s.forEach(i=>this.release(i))}clear(){this.active.clear()}}class Me{constructor(e){this.audioContext=e,this.pools={oscillator:new ye(e),gain:new ve(e),bufferSource:new xe(e)},this.cleanupInterval=setInterval(()=>{Object.values(this.pools).forEach(t=>{t.cleanupOld(3e4)})},1e4)}getAllStats(){const e={};return Object.entries(this.pools).forEach(([t,s])=>{e[t]=s.getStats()}),e}destroy(){this.cleanupInterval&&clearInterval(this.cleanupInterval),Object.values(this.pools).forEach(e=>{e.clear()})}}class R{constructor(e){this.audioContext=e,this.attack=.01,this.decay=.1,this.sustain=.7,this.release=.3,this.peakLevel=1}setADSR(e,t,s,i){this.attack=Math.max(.001,e),this.decay=Math.max(.001,t),this.sustain=Math.max(0,Math.min(1,s)),this.release=Math.max(.001,i)}setPeakLevel(e){this.peakLevel=Math.max(0,Math.min(1,e))}applyTo(e,t,s,i=0){const a=t||this.audioContext.currentTime,n=i+this.peakLevel,o=i+this.peakLevel*this.sustain;return e.cancelScheduledValues(a),e.setValueAtTime(i,a),e.linearRampToValueAtTime(n,a+this.attack),e.exponentialRampToValueAtTime(Math.max(.001,o),a+this.attack+this.decay),s!=null&&(e.setValueAtTime(o,s),e.exponentialRampToValueAtTime(Math.max(.001,i),s+this.release)),a+this.attack+this.decay}getTotalDuration(){return this.attack+this.decay+this.release}applyWithCurve(e,t,s,i=0,a="linear",n="exponential"){const o=t||this.audioContext.currentTime,r=i+this.peakLevel,c=i+this.peakLevel*this.sustain;e.cancelScheduledValues(o),e.setValueAtTime(i,o),a==="exponential"&&i>0?e.exponentialRampToValueAtTime(r,o+this.attack):e.linearRampToValueAtTime(r,o+this.attack),e.exponentialRampToValueAtTime(Math.max(.001,c),o+this.attack+this.decay),s!=null&&(e.setValueAtTime(c,s),n==="linear"?e.linearRampToValueAtTime(i,s+this.release):e.exponentialRampToValueAtTime(Math.max(.001,i),s+this.release))}applyOneShot(e,t,s=0){const i=t||this.audioContext.currentTime,a=s+this.peakLevel;return e.cancelScheduledValues(i),e.setValueAtTime(s,i),e.linearRampToValueAtTime(a,i+this.attack),e.exponentialRampToValueAtTime(Math.max(.001,s),i+this.attack+this.release),i+this.attack+this.release}clone(){const e=new R(this.audioContext);return e.attack=this.attack,e.decay=this.decay,e.sustain=this.sustain,e.release=this.release,e.peakLevel=this.peakLevel,e}getParameters(){return{attack:this.attack,decay:this.decay,sustain:this.sustain,release:this.release,peakLevel:this.peakLevel}}setParameters(e){e.attack!==void 0&&(this.attack=Math.max(.001,e.attack)),e.decay!==void 0&&(this.decay=Math.max(.001,e.decay)),e.sustain!==void 0&&(this.sustain=Math.max(0,Math.min(1,e.sustain))),e.release!==void 0&&(this.release=Math.max(.001,e.release)),e.peakLevel!==void 0&&(this.peakLevel=Math.max(0,Math.min(1,e.peakLevel)))}}class be{constructor(e){this.audioContext=e,this.isRecording=!1,this.isPlaying=!1,this.recordings=new Map,this.startTime=0,this.playbackStartTime=0,this.playbackScheduler=null,this.loopEnabled=!0,this.recordedDuration=0}startRecording(){this.isRecording=!0,this.recordings.clear(),this.startTime=this.audioContext.currentTime,this.recordedDuration=0}stopRecording(){return this.isRecording=!1,this.recordedDuration=this.audioContext.currentTime-this.startTime,this.recordings}recordValue(e,t){if(!this.isRecording)return;this.recordings.has(e)||this.recordings.set(e,[]);const s=this.audioContext.currentTime-this.startTime;this.recordings.get(e).push({time:s,value:t})}startPlayback(e){this.recordings.size!==0&&(this.isPlaying=!0,this.playbackStartTime=this.audioContext.currentTime,this.schedulePlayback(e))}stopPlayback(){this.isPlaying=!1,this.playbackScheduler&&(clearInterval(this.playbackScheduler),this.playbackScheduler=null)}schedulePlayback(e){let s=0;this.playbackScheduler=setInterval(()=>{if(!this.isPlaying){clearInterval(this.playbackScheduler);return}const i=(this.audioContext.currentTime-this.playbackStartTime)%this.recordedDuration;this.recordings.forEach((a,n)=>{a.forEach(o=>{o.time>s&&o.time<=i&&e(n,o.value)})}),s=i,i<s&&this.loopEnabled&&(s=0,this.playbackStartTime=this.audioContext.currentTime)},10)}setLoop(e){this.loopEnabled=e}clearRecordings(){this.recordings.clear(),this.recordedDuration=0}exportRecordings(){const e={duration:this.recordedDuration,recordings:{}};return this.recordings.forEach((t,s)=>{e.recordings[s]=t}),JSON.stringify(e)}importRecordings(e){try{const t=JSON.parse(e);return this.recordedDuration=t.duration||0,this.recordings.clear(),Object.entries(t.recordings).forEach(([s,i])=>{this.recordings.set(s,i)}),!0}catch(t){return console.error("Failed to import recordings:",t),!1}}createAutomationCurve(e,t,s){const i=[];for(let n=0;n<s*100;n++){const o=n/100,r=o/s;let c={time:0,value:t[0].value},h=t[t.length-1];for(let p=0;p<t.length-1;p++)if(t[p].time<=r&&t[p+1].time>r){c=t[p],h=t[p+1];break}const l=(r-c.time)/(h.time-c.time),d=c.value+(h.value-c.value)*l;i.push({time:o,value:d})}this.recordings.set(e,i),this.recordedDuration=s}createLFOAutomation(e,t,s,i,a){const n=[];for(let r=0;r<a*100;r++){const c=r/100,h=t+(s-t)*(Math.sin(2*Math.PI*i*c)+1)/2;n.push({time:c,value:h})}this.recordings.set(e,n),this.recordedDuration=a}createRandomAutomation(e,t,s,i,a){const n=[];for(let o=0;o<a;o+=1/i){const r=t+Math.random()*(s-t);n.push({time:o,value:r})}this.recordings.set(e,n),this.recordedDuration=a}}class Ce{constructor(e){console.log("DataMatrix constructor called with container:",e),this.container=e,this.canvas=null,this.ctx=null,this.isActive=!1,this.animationFrame=null,this.gridSize=32,this.cellSize=18,this.cellSpacing=1,this.parameters=new Map,this.triggers=[],this.triggerHistory=[],this.time=0,this.fadeSpeed=.995,this.globalEnergy=0,this.ledBlinkStates=new Map,this.dataFlowPaths=[],this.tentacles=[],this.tentacleNodes=new Map,this.organicTimer=0,this.colors={background:"#000000",grid:"#0a0a0a",gridActive:"#1a1a1a",parameters:"#ffffff",triggers:"#ff0000",fade:"#333333",accent:"#00ff00",tentacles:"#004400",tentacleGlow:"#00ff00",connections:"#002200",ledOn:"#00ff00",ledOff:"#001100",dataFlow:"#00ffff"};try{this.initializeCanvas(),this.setupParameterMapping(),console.log("DataMatrix initialization completed successfully")}catch(t){throw console.error("DataMatrix initialization failed:",t),t}}initializeCanvas(){this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.width="100vw",this.canvas.style.height="100vh",this.canvas.style.backgroundColor=this.colors.background,this.canvas.style.zIndex="9999",this.canvas.style.display="none",this.canvas.style.cursor="crosshair";const e=window.devicePixelRatio||1;this.canvas.width=window.innerWidth*e,this.canvas.height=window.innerHeight*e,this.ctx=this.canvas.getContext("2d"),this.ctx.scale(e,e),this.container.appendChild(this.canvas),window.addEventListener("resize",()=>this.handleResize()),this.canvas.addEventListener("click",()=>this.stop()),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.isActive&&this.stop()})}setupParameterMapping(){["masterVolume","reverb","delay","delayTime","droneFreq","droneDetune","droneVoices","droneFilter","glitchIntensity","glitchRate","bitCrush","drumTempo","drumDensity","drumVariation","drumSwing","bleepDensity","bleepRange","bleepDuration","burstActivity","burstComplexity","burstSpeed","fmCarrier","fmIndex","fmRatio","fmLFO","noiseLevel","noiseFilter","acidLevel","acidFreq","acidResonance","acidDecay","grainDensity","grainSize","grainPitch","grainPan","spaceMelodyDensity","spaceMelodyRange","spaceMelodySpeed","padDensity","padAttack","padRelease","padFilterSweep","arpEnable","arpSpeed","arpOctaves","arpGate","chordDensity","chordRoot","chordTempo","chordBrightness","vocalDensity","vocalPitch","vocalVibrato","vocalWhisper","karplusDensity","karplusPitch","karplusDamping","karplusBrightness","additiveDensity","additiveFundamental","additiveHarmonics","chaosDensity","chaosIntensity","chaosResonance","chaosSpeed","bioDensity","bioEvolution","bioHarmony","bioVariation","compressorMix","compThreshold","compRatio","eqLow","eqMid","eqHigh","distortionMix","distDrive","chorusMix","chorusRate","sidechainAmount"].forEach((t,s)=>{const i=s%this.gridSize,a=Math.floor(s/this.gridSize);this.parameters.set(t,{x:i,y:a,value:0,targetValue:0,lastValue:0,activity:0,type:this.getParameterType(t)})})}getParameterType(e){return e.includes("Density")||e.includes("Level")||e.includes("Activity")?"density":e.includes("Freq")||e.includes("Pitch")?"frequency":e.includes("Time")||e.includes("Speed")||e.includes("Rate")?"temporal":e.includes("Attack")||e.includes("Decay")||e.includes("Release")?"envelope":"control"}start(){this.isActive||(this.isActive=!0,this.canvas.style.display="block",this.time=0,this.startParameterMonitoring(),this.animate(),console.log("Data Matrix visualization started - Click or press ESC to close"))}stop(){this.isActive&&(this.isActive=!1,this.canvas.style.display="none",this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null),this.stopParameterMonitoring(),console.log("Data Matrix visualization stopped"))}startParameterMonitoring(){this.parameterInputs=document.querySelectorAll('input[type="range"]'),this.parameterInputs.forEach(t=>{if(this.parameters.has(t.id)){const s=this.parameters.get(t.id);s.value=parseFloat(t.value),s.lastValue=s.value,t.addEventListener("input",i=>{this.updateParameter(t.id,parseFloat(i.target.value))})}}),this.groupToggles=document.querySelectorAll(".group-enable"),this.groupToggles.forEach(t=>{t.addEventListener("change",s=>{this.addTrigger({type:"group",name:s.target.id,state:s.target.checked,x:Math.random()*this.gridSize,y:Math.random()*this.gridSize})})}),document.querySelectorAll(".control-button").forEach(t=>{t.addEventListener("click",()=>{this.addTrigger({type:"button",name:t.id,x:Math.random()*this.gridSize,y:Math.random()*this.gridSize})})})}stopParameterMonitoring(){this.parameterInputs=[],this.groupToggles=[]}updateParameter(e,t){if(!this.parameters.has(e))return;const s=this.parameters.get(e);s.lastValue=s.value,s.value=t,s.activity=1;const i=Math.abs(t-s.lastValue);if(i>.01&&(this.globalEnergy+=i*.1,this.addTrigger({type:"parameter",name:e,change:i,x:s.x,y:s.y,energy:i}),i>.5))for(let a=0;a<3;a++)setTimeout(()=>{this.addTrigger({type:"ripple",name:e+"_ripple",change:i*.5,x:s.x+(Math.random()-.5)*2,y:s.y+(Math.random()-.5)*2})},a*100)}addTrigger(e){e.time=this.time,e.intensity=1,this.triggers.push(e),this.triggerHistory.push({...e,life:1}),this.triggerHistory.length>100&&this.triggerHistory.shift()}animate(){this.isActive&&(this.time+=.016,this.clear(),this.drawEvolvingGrid(),this.drawTentacles(),this.drawParameters(),this.drawTriggers(),this.drawTrails(),this.drawEnergyField(),this.updateState(),this.updateTentacles(),this.evolveGrid(),this.animationFrame=requestAnimationFrame(()=>this.animate()))}clear(){this.ctx.fillStyle="rgba(0, 0, 0, 0.15)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}drawGrid(){const e=window.innerWidth/2,t=window.innerHeight/2,s=this.gridSize*(this.cellSize+this.cellSpacing),i=e-s/2,a=t-s/2;this.ctx.strokeStyle=this.colors.grid,this.ctx.lineWidth=1;for(let n=0;n<=this.gridSize;n++){const o=i+n*(this.cellSize+this.cellSpacing),r=a+n*(this.cellSize+this.cellSpacing);this.ctx.beginPath(),this.ctx.moveTo(o,a),this.ctx.lineTo(o,a+s),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(i,r),this.ctx.lineTo(i+s,r),this.ctx.stroke()}}drawEvolvingGrid(){const e=window.innerWidth/2,t=window.innerHeight/2,s=this.gridSize*(this.cellSize+this.cellSpacing),i=e-s/2,a=t-s/2;for(let n=0;n<this.gridSize;n++)for(let o=0;o<this.gridSize;o++){const r=i+n*(this.cellSize+this.cellSpacing),c=a+o*(this.cellSize+this.cellSpacing),h=`${n},${o}`;this.ledBlinkStates.has(h)||this.ledBlinkStates.set(h,{brightness:0,targetBrightness:0,blinkPhase:Math.random()*Math.PI*2,isData:!1,dataIntensity:0});const l=this.ledBlinkStates.get(h);Math.random()<.002+this.globalEnergy*.01&&(l.targetBrightness=.3+Math.random()*.7,l.isData=!0,l.dataIntensity=1,Math.random()<.3&&this.createDataFlow(n,o)),l.brightness+=(l.targetBrightness-l.brightness)*.3,l.targetBrightness*=.92,l.dataIntensity*=.95;const d=l.brightness+Math.sin(this.time*10+l.blinkPhase)*.05;if(d>.05){const p=Math.min(1,d);this.ctx.fillStyle=l.isData?`rgba(0, 255, 255, ${p})`:`rgba(0, 255, 0, ${p*.3})`,this.ctx.fillRect(r,c,this.cellSize-1,this.cellSize-1),d>.5&&(this.ctx.shadowBlur=10,this.ctx.shadowColor=this.colors.ledOn,this.ctx.fillRect(r,c,this.cellSize-1,this.cellSize-1),this.ctx.shadowBlur=0)}else this.ctx.fillStyle=this.colors.ledOff,this.ctx.fillRect(r,c,this.cellSize-1,this.cellSize-1);l.dataIntensity<.1&&(l.isData=!1)}}createDataFlow(e,t){const s=Math.floor(Math.random()*4),i=3+Math.floor(Math.random()*8),a=[1,0,-1,0][s],n=[0,1,0,-1][s];for(let o=1;o<=i;o++){const r=e+a*o,c=t+n*o;r>=0&&r<this.gridSize&&c>=0&&c<this.gridSize&&setTimeout(()=>{const h=`${r},${c}`;if(this.ledBlinkStates.has(h)){const l=this.ledBlinkStates.get(h);l.targetBrightness=.8,l.isData=!0,l.dataIntensity=1}},o*30)}}drawEnergyField(){if(this.globalEnergy>.1){const e=window.innerWidth/2,t=window.innerHeight/2,s=this.globalEnergy*200,i=Math.min(.3,this.globalEnergy);this.ctx.strokeStyle=this.colors.accent+Math.floor(i*255).toString(16).padStart(2,"0"),this.ctx.lineWidth=1;for(let a=0;a<3;a++){const n=s*(1+a*.3),o=this.time*(1+a*.5);this.ctx.beginPath();for(let r=0;r<Math.PI*2;r+=.1){const c=Math.sin(r*6+o)*10,h=e+Math.cos(r)*(n+c),l=t+Math.sin(r)*(n+c);r===0?this.ctx.moveTo(h,l):this.ctx.lineTo(h,l)}this.ctx.closePath(),this.ctx.stroke()}}}evolveGrid(){this.parameters.forEach((e,t)=>{const s=Math.sin(this.time*.5+e.x+e.y)*.02;if(e.activity=Math.max(e.activity,Math.abs(s)),Math.random()<.001&&e.activity>.5){const i=e.x,a=e.y,n=Math.max(0,Math.min(this.gridSize-1,i+Math.floor((Math.random()-.5)*3))),o=Math.max(0,Math.min(this.gridSize-1,a+Math.floor((Math.random()-.5)*3)));e.x=n,e.y=o,this.addTrigger({type:"reorganize",name:t+"_move",x:i,y:a}),this.addTrigger({type:"reorganize",name:t+"_arrive",x:n,y:o})}}),this.globalEnergy*=.98}drawParameters(){const e=window.innerWidth/2,t=window.innerHeight/2,s=this.gridSize*(this.cellSize+this.cellSpacing),i=e-s/2,a=t-s/2;this.parameters.forEach((n,o)=>{const r=i+n.x*(this.cellSize+this.cellSpacing),c=a+n.y*(this.cellSize+this.cellSpacing),h=n.value/100,l=Math.max(2,h*this.cellSize),d=Math.max(.1,h);let p=this.colors.parameters;switch(n.type){case"density":p="#ffffff";break;case"frequency":p="#ff6666";break;case"temporal":p="#66ff66";break;case"envelope":p="#6666ff";break;default:p="#ffff66";break}const u=n.activity*Math.sin(this.time*10),g=d+u*.3;switch(this.ctx.fillStyle=p+Math.floor(g*255).toString(16).padStart(2,"0"),this.ctx.save(),this.ctx.translate(r+this.cellSize/2,c+this.cellSize/2),n.type){case"density":this.ctx.fillRect(-l/2,-l/2,l,l);break;case"frequency":this.ctx.beginPath(),this.ctx.arc(0,0,l/2,0,Math.PI*2),this.ctx.fill();break;case"temporal":this.ctx.beginPath(),this.ctx.moveTo(-l/2,0),this.ctx.lineTo(l/2,-l/2),this.ctx.lineTo(l/2,l/2),this.ctx.closePath(),this.ctx.fill();break;case"envelope":this.ctx.beginPath(),this.ctx.moveTo(0,-l/2),this.ctx.lineTo(l/2,0),this.ctx.lineTo(0,l/2),this.ctx.lineTo(-l/2,0),this.ctx.closePath(),this.ctx.fill();break;default:this.ctx.fillRect(-l/4,-l/2,l/2,l);break}this.ctx.restore()})}drawTriggers(){const e=window.innerWidth/2,t=window.innerHeight/2,s=this.gridSize*(this.cellSize+this.cellSpacing),i=e-s/2,a=t-s/2;this.triggers.forEach((n,o)=>{const r=i+n.x*(this.cellSize+this.cellSpacing),c=a+n.y*(this.cellSize+this.cellSpacing),h=this.time-n.time,l=Math.max(0,1-h/2);if(l<=0){this.triggers.splice(o,1);return}const d=30*l,p=l;let u=this.colors.triggers;n.type==="group"&&(u=this.colors.accent),n.type==="button"&&(u="#ffff00"),this.ctx.strokeStyle=u+Math.floor(p*255).toString(16).padStart(2,"0"),this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(r+this.cellSize/2,c+this.cellSize/2,d,0,Math.PI*2),this.ctx.stroke()})}drawTrails(){this.triggerHistory.forEach((e,t)=>{if(e.life*=this.fadeSpeed,e.life<.01){this.triggerHistory.splice(t,1);return}const s=window.innerWidth/2,i=window.innerHeight/2,a=this.gridSize*(this.cellSize+this.cellSpacing),n=s-a/2,o=i-a/2,r=n+e.x*(this.cellSize+this.cellSpacing),c=o+e.y*(this.cellSize+this.cellSpacing),h=e.life*.3;this.ctx.fillStyle=this.colors.fade+Math.floor(h*255).toString(16).padStart(2,"0"),this.ctx.fillRect(r+this.cellSize/2-1,c+this.cellSize/2-1,2,2)})}updateState(){this.parameters.forEach(e=>{e.activity*=this.fadeSpeed;const t=Math.sin(this.time*.3+e.x*.5+e.y*.3)*.1+.05;e.activity=Math.max(e.activity,t)})}handleResize(){const e=window.devicePixelRatio||1;this.canvas.width=window.innerWidth*e,this.canvas.height=window.innerHeight*e,this.ctx.scale(e,e)}toggle(){console.log("DataMatrix.toggle() called, isActive:",this.isActive),this.isActive?(console.log("Stopping visualization"),this.stop()):(console.log("Starting visualization"),this.start())}updateTentacles(){this.organicTimer+=.016;const e=Array.from(this.parameters.entries()).filter(([s,i])=>i.activity>.05).sort((s,i)=>i[1].activity-s[1].activity);Math.max(e.length,2);let t=Array.from(this.parameters.entries());if(e.length<2){const s=t.sort(()=>Math.random()-.5);for(let i=0;i<Math.min(2,s.length);i++)s[i][1].activity=Math.max(s[i][1].activity,.2),e.includes(s[i])||e.push(s[i])}if(e.length>=2&&this.organicTimer>.05&&(this.createTentacleConnection(e),this.organicTimer=0),Math.random()<.02&&this.tentacles.length<12){const s=t.sort(()=>Math.random()-.5).slice(0,2);s.forEach(([i,a])=>a.activity=Math.max(a.activity,.3)),this.createTentacleConnection(s)}this.tentacles.forEach((s,i)=>{s.life-=.005,s.phase+=s.speed,s.segments.forEach((a,n)=>{const o=n/s.segments.length,r=Math.sin(s.phase+o*Math.PI*4)*.3,c=Math.cos(s.phase*1.3+o*Math.PI*6)*.2;a.offset.x=r*s.amplitude,a.offset.y=c*s.amplitude}),s.life<=0&&this.tentacles.splice(i,1)}),this.tentacles.length>8&&this.tentacles.splice(0,this.tentacles.length-8)}createTentacleConnection(e){if(e.length<2)return;const t=e[0][1],s=e[Math.floor(Math.random()*Math.min(3,e.length-1))+1][1],i=window.innerWidth/2,a=window.innerHeight/2,n=this.gridSize*(this.cellSize+this.cellSpacing),o=i-n/2,r=a-n/2,c=o+t.x*(this.cellSize+this.cellSpacing)+this.cellSize/2,h=r+t.y*(this.cellSize+this.cellSpacing)+this.cellSize/2,l=o+s.x*(this.cellSize+this.cellSpacing)+this.cellSize/2,d=r+s.y*(this.cellSize+this.cellSpacing)+this.cellSize/2,p=Math.sqrt((l-c)*(l-c)+(d-h)*(d-h)),u=Math.max(6,Math.floor(p/15)),g={start:{x:c,y:h},end:{x:l,y:d},segments:[],life:1,phase:Math.random()*Math.PI*2,speed:.05+Math.random()*.05,amplitude:3+Math.random()*5,activity:(t.activity+s.activity)/2,thickness:1+Math.random()*2};for(let m=0;m<=u;m++){const f=m/u,x=c+(l-c)*f,M=h+(d-h)*f;g.segments.push({base:{x,y:M},offset:{x:0,y:0},thickness:g.thickness*(1-Math.abs(f-.5)*.5)})}this.tentacles.push(g)}drawTentacles(){this.tentacles.forEach(e=>{if(e.segments.length<2)return;const t=e.life*e.activity;if(!(t<.05)){this.ctx.strokeStyle=this.colors.tentacles+Math.floor(t*255).toString(16).padStart(2,"0"),this.ctx.lineWidth=e.thickness,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.beginPath();for(let s=0;s<e.segments.length;s++){const i=e.segments[s],a=i.base.x+i.offset.x,n=i.base.y+i.offset.y;if(s===0)this.ctx.moveTo(a,n);else{const o=e.segments[s-1],r=o.base.x+o.offset.x,c=o.base.y+o.offset.y,h=(r+a)/2,l=(c+n)/2;this.ctx.quadraticCurveTo(r,c,h,l)}}this.ctx.stroke(),e.activity>.5&&(this.ctx.strokeStyle=this.colors.tentacleGlow+Math.floor(t*e.activity*128).toString(16).padStart(2,"0"),this.ctx.lineWidth=e.thickness*3,this.ctx.stroke()),e.segments.forEach((s,i)=>{if(i%2===0){const a=s.base.x+s.offset.x,n=s.base.y+s.offset.y,o=s.thickness*.5;this.ctx.fillStyle=this.colors.connections+Math.floor(t*200).toString(16).padStart(2,"0"),this.ctx.beginPath(),this.ctx.arc(a,n,o,0,Math.PI*2),this.ctx.fill()}})}})}}class z{constructor(){this.audioContext=null,this.isPlaying=!1,this.isRecording=!1,this.mediaRecorder=null,this.recordedChunks=[],this.activeVoices=0,this.maxVoices=100,this.performanceThrottle=1,this.performanceMonitor=null,this.masterBus=null,this.poolManager=null,this.generators={},this.groupEnabled={drone:!0,glitch:!0,drums:!0,bleeps:!0,burst:!0,fm:!0,noise:!0,acid:!0,granular:!0,spaceMelody:!0,ambientPad:!0,arpeggiator:!0,chord:!0,vocal:!0,karplus:!0,additive:!0,biological:!0,chaos:!0,sample:!0},this.animatedParams=new Map,this.morphState=null,this.morphStartParams=null,this.morphTargetParams=null,this.morphStartTime=null,this.morphing=!1,this.morphTargets=new Map,this.morphStartValues=new Map,this.morphDuration=5e3,this.modulationModes=new Map,this.randomIntervals=new Map,this.lfoControllers=new Map,this.autoModeInterval=null,this.liteMode=!1,this.globalEnvelope=null,this.adsrMode="global",this.groupEnvelopes=new Map,this.automationRecorder=null,this.presets={},this.currentPreset=null,this.presetCategories=["saved","default","ambient","techno","experimental"],this.masterBPM=120,this.masterTempo={bpm:120,beatsPerSecond:2,quarterNoteTime:.5,eighthNoteTime:.25,sixteenthNoteTime:.125,barTime:2},this.initializeUI(),this.initializePresetSystem(),this.initializeKeyboardShortcuts();const e=document.getElementById("stopButton");e&&(e.disabled=!0),this.loadSettingsFromURL()}initializeKeyboardShortcuts(){document.addEventListener("keydown",e=>{if(e.target.tagName!=="INPUT")switch(e.key.toLowerCase()){case" ":e.preventDefault(),this.isPlaying?this.stop():this.start();break;case"r":!e.ctrlKey&&!e.metaKey&&(e.preventDefault(),this.randomize());break;case"m":e.preventDefault(),this.startMorph();break;case"a":e.preventDefault(),this.toggleAutoMode();break;case"l":e.preventDefault(),this.toggleLiteMode();break;case"escape":e.preventDefault(),this.isPlaying&&this.stop();break;case"?":case"h":e.preventDefault(),this.showKeyboardHelp();break}})}initializeUI(){const e=(t,s,i)=>{const a=document.getElementById(t);a?a.addEventListener(s,i):console.warn(`Element with id '${t}' not found`)};e("playButton","click",()=>this.start()),e("stopButton","click",()=>this.stop()),e("randomizeButton","click",()=>this.randomize()),e("morphButton","click",()=>this.startMorph()),e("morphTime","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value)}),e("autoChangeTime","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.autoModeInterval&&this.updateAutoModeInterval()}),e("minGroups","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value);const i=document.getElementById("maxGroups");i&&parseInt(i.value)<parseInt(t.target.value)&&(i.value=t.target.value,i.dispatchEvent(new Event("input")))}),e("maxGroups","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value);const i=document.getElementById("minGroups");i&&parseInt(i.value)>parseInt(t.target.value)&&(i.value=t.target.value,i.dispatchEvent(new Event("input")))}),e("recordButton","click",()=>this.toggleRecording()),e("savePreset","click",()=>this.savePreset()),e("loadPreset","click",()=>this.loadPreset()),e("deletePreset","click",()=>this.deletePreset()),e("exportPresets","click",()=>this.exportPresets()),e("importPresets","click",()=>this.importPresets()),e("resetPresets","click",()=>this.resetPresets()),e("loadSampleFiles","click",()=>this.loadSampleFiles()),e("clearSamples","click",()=>this.clearSamples()),e("autoButton","click",()=>this.toggleAutoMode()),e("liteButton","click",()=>this.toggleLiteMode()),e("shareButton","click",()=>this.shareSettings()),e("helpButton","click",()=>this.showKeyboardHelp()),document.querySelectorAll(".lfo-button").forEach(t=>{t.addEventListener("click",s=>{const i=s.target.dataset.param;this.toggleLFO(i,s.target)})}),e("masterVolume","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.masterBus&&this.masterBus.setMasterVolume(parseFloat(t.target.value)/100)}),e("masterBPM","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.updateMasterTempo(parseInt(t.target.value))}),e("reverb","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.masterBus&&this.masterBus.setReverbMix(parseFloat(t.target.value)/100)}),e("delayTime","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=parseFloat(t.target.value).toFixed(1)),this.masterBus&&this.masterBus.setDelayTime(parseFloat(t.target.value))}),e("delay","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.masterBus&&this.masterBus.setDelayMix(parseFloat(t.target.value)/100)}),e("compressorMix","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.masterBus&&this.masterBus.compressor.setMix(parseFloat(t.target.value))}),e("compThreshold","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.masterBus&&this.masterBus.setCompressorThreshold(parseFloat(t.target.value))}),e("compRatio","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.masterBus&&this.masterBus.setCompressorRatio(parseFloat(t.target.value))}),e("eqPreset","change",t=>{this.masterBus&&this.masterBus.setEQPreset(t.target.value)}),e("eqLow","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.masterBus&&this.masterBus.setEQLowShelf(parseFloat(t.target.value))}),e("eqMid","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.masterBus&&this.masterBus.setEQMidGain(parseFloat(t.target.value))}),e("eqHigh","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.masterBus&&this.masterBus.setEQHighShelf(parseFloat(t.target.value))}),e("distortionMix","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.masterBus&&this.masterBus.setDistortionMix(parseFloat(t.target.value))}),e("distType","change",t=>{this.masterBus&&this.masterBus.setDistortionType(t.target.value)}),e("distDrive","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.masterBus&&this.masterBus.setDistortionDrive(parseFloat(t.target.value))}),e("chorusMix","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.masterBus&&this.masterBus.setChorusMix(parseFloat(t.target.value))}),e("chorusMode","change",t=>{this.masterBus&&this.masterBus.setChorusMode(t.target.value)}),e("chorusRate","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.masterBus&&this.masterBus.setChorusRate(parseFloat(t.target.value))}),e("sidechainEnable","change",t=>{var s;if(this.masterBus){const i=((s=document.getElementById("sidechainPattern"))==null?void 0:s.value)||"quarter";this.masterBus.setSidechainPumpMode(t.target.checked,i)}}),e("sidechainPattern","change",t=>{var s;this.masterBus&&((s=document.getElementById("sidechainEnable"))!=null&&s.checked)&&this.masterBus.setSidechainPumpMode(!0,t.target.value)}),e("sidechainAmount","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value),this.masterBus&&this.masterBus.sidechain.setLFODepth(parseFloat(t.target.value))}),e("globalAttack","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=parseFloat(t.target.value).toFixed(3)),this.globalEnvelope&&(this.globalEnvelope.attack=parseFloat(t.target.value))}),e("globalDecay","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=parseFloat(t.target.value).toFixed(3)),this.globalEnvelope&&(this.globalEnvelope.decay=parseFloat(t.target.value))}),e("globalSustain","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=parseFloat(t.target.value).toFixed(2)),this.globalEnvelope&&(this.globalEnvelope.sustain=parseFloat(t.target.value))}),e("globalRelease","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=parseFloat(t.target.value).toFixed(3)),this.globalEnvelope&&(this.globalEnvelope.release=parseFloat(t.target.value))}),e("adsrMode","change",t=>{this.adsrMode=t.target.value,this.isPlaying&&Object.keys(this.groupEnabled).forEach(s=>{this.groupEnabled[s]&&(this.updateGroupState(s,!1),this.updateGroupState(s,!0))})}),e("drumPatternMode","change",t=>{this.isPlaying&&this.groupEnabled.drums&&(this.updateGroupState("drums",!1),this.updateGroupState("drums",!0))}),e("useSampleKit","change",t=>{this.isPlaying&&this.groupEnabled.drums&&(this.updateGroupState("drums",!1),this.updateGroupState("drums",!0))}),e("automationRecord","click",()=>{if(!this.automationRecorder)return;const t=document.getElementById("automationRecord");this.automationRecorder.isRecording?(this.automationRecorder.stopRecording(),t.classList.remove("recording"),t.textContent="REC"):(this.automationRecorder.startRecording(),t.classList.add("recording"),t.textContent="STOP REC")}),e("automationPlay","click",()=>{if(!this.automationRecorder)return;const t=document.getElementById("automationPlay");this.automationRecorder.isPlaying?(this.automationRecorder.stopPlayback(),t.classList.remove("active")):(this.automationRecorder.startPlayback((s,i)=>{const a=document.getElementById(s);a&&(a.value=i,a.dispatchEvent(new Event("input")))}),t.classList.add("active"))}),e("automationStop","click",()=>{this.automationRecorder&&(this.automationRecorder.stopPlayback(),this.automationRecorder.stopRecording(),document.getElementById("automationRecord").classList.remove("recording"),document.getElementById("automationRecord").textContent="REC",document.getElementById("automationPlay").classList.remove("active"))}),e("automationClear","click",()=>{this.automationRecorder&&this.automationRecorder.clearRecordings()}),e("automationLoop","change",t=>{this.automationRecorder&&this.automationRecorder.setLoop(t.target.checked)}),e("automationDuration","input",t=>{const s=t.target.nextElementSibling;s&&s.classList.contains("value")&&(s.textContent=t.target.value)}),document.querySelectorAll(".group-enable").forEach(t=>{t.addEventListener("change",s=>{let i=s.target.id.replace("Enable","");i!=="arp"&&this.groupEnabled.hasOwnProperty(i)&&this.updateGroupState(i,s.target.checked)})}),document.querySelectorAll('input[type="range"], select').forEach(t=>{t.classList.contains("group-enable")||["masterVolume","reverb","delay","delayTime"].includes(t.id)||t.addEventListener("input",s=>{if(t.type==="range"){const i=t.nextElementSibling;if(i&&i.classList.contains("value")){const a=s.target.value;i.textContent=t.step&&parseFloat(t.step)<1?parseFloat(a).toFixed(1):a}}if(this.isPlaying){const i=this.getGroupForParameter(t.id);i&&this.groupEnabled[i]?["bleeps","burst","acid","granular","spaceMelody","ambientPad","arpeggiator","chord","vocal","karplus","additive","sample"].includes(i)?(this.updateGroupState(i,!1),this.updateGroupState(i,!0)):this.updateParameter(t.id,parseFloat(t.value)):this.updateParameter(t.id,parseFloat(t.value))}this.automationRecorder&&this.automationRecorder.isRecording&&t.type==="range"&&this.automationRecorder.recordValue(t.id,parseFloat(t.value))})}),document.querySelectorAll('input[type="range"]').forEach(t=>{const s=t.nextElementSibling;if(s&&s.classList.contains("value")){const i=t.value;s.textContent=t.step&&parseFloat(t.step)<1?parseFloat(i).toFixed(1):i}})}async start(){var s,i,a,n;this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.poolManager=new Me(this.audioContext),this.globalEnvelope=new R(this.audioContext),this.globalEnvelope.setADSR(parseFloat(((s=document.getElementById("globalAttack"))==null?void 0:s.value)||.01),parseFloat(((i=document.getElementById("globalDecay"))==null?void 0:i.value)||.1),parseFloat(((a=document.getElementById("globalSustain"))==null?void 0:a.value)||.7),parseFloat(((n=document.getElementById("globalRelease"))==null?void 0:n.value)||.3)),this.automationRecorder=new be(this.audioContext)),this.isPlaying=!0,window.soundscape&&(window.soundscape.lfoControllers=this.lfoControllers,window.soundscape.app=this);const e=document.getElementById("playButton"),t=document.getElementById("stopButton");e&&(e.disabled=!0),t&&(t.disabled=!1),this.setupAudioGraph(),this.initializeGenerators(),this.startGenerators(),this.startAnimations(),this.startPerformanceMonitoring()}stop(){this.isPlaying=!1;const e=document.getElementById("playButton"),t=document.getElementById("stopButton");if(e&&(e.disabled=!1),t&&(t.disabled=!0),this.autoModeInterval){clearInterval(this.autoModeInterval),this.autoModeInterval=null;const i=document.getElementById("autoButton");i&&(i.classList.remove("active"),i.textContent="AUTO")}this.morphing=!1;const s=document.getElementById("morphButton");s&&(s.textContent="MORPH"),Object.values(this.generators).forEach(i=>{i&&i.stop&&i.stop()}),this.animatedParams.forEach((i,a)=>{i.interval&&clearInterval(i.interval),i.frameId&&cancelAnimationFrame(i.frameId)}),this.animatedParams.clear(),this.randomIntervals.forEach(i=>{clearInterval(i)}),this.randomIntervals.clear(),this.modulationModes.clear(),document.querySelectorAll('input[type="range"]').forEach(i=>{i.classList.remove("animated","random-jump","other-mod")}),document.querySelectorAll(".lfo-button").forEach(i=>{i.textContent="MOD",i.classList.remove("active","random","other")}),this.performanceMonitor&&(clearInterval(this.performanceMonitor),this.performanceMonitor=null),this.activityMonitor&&(clearInterval(this.activityMonitor),this.activityMonitor=null),document.querySelectorAll(".activity-indicator").forEach(i=>{i.classList.remove("active")}),document.querySelectorAll(".section").forEach(i=>{i.classList.remove("active")}),this.disconnectAll(),this.poolManager&&console.log("Voice Pool Stats:",this.poolManager.getAllStats())}setupAudioGraph(){var n,o,r,c;this.masterBus=new fe(this.audioContext),this.masterBus.initialize(this.performanceThrottle);const e=parseFloat(((n=document.getElementById("masterVolume"))==null?void 0:n.value)||70)/100,t=parseFloat(((o=document.getElementById("reverb"))==null?void 0:o.value)||20)/100,s=parseFloat(((r=document.getElementById("delayTime"))==null?void 0:r.value)||.3),i=.4,a=parseFloat(((c=document.getElementById("delay"))==null?void 0:c.value)||0)/100;this.masterBus.setMasterVolume(e),this.masterBus.setReverbMix(t),this.masterBus.setDelayTime(s),this.masterBus.setDelayFeedback(i),this.masterBus.setDelayMix(a)}initializeGenerators(){var t;this.generators.drone=new N(this.audioContext,this.poolManager);const e=((t=document.getElementById("drumPatternMode"))==null?void 0:t.value)!=="traditional";this.generators.drums=e?new D(this.audioContext,this.poolManager):new L(this.audioContext,this.poolManager),this.generators.drums.setupFileInput&&this.generators.drums.setupFileInput(),this.generators.glitch=new j(this.audioContext,this.poolManager),this.generators.bleeps=new _(this.audioContext,this.poolManager),this.generators.burst=new W(this.audioContext,this.poolManager),this.generators.fm=new U(this.audioContext,this.poolManager),this.generators.noise=new Q(this.audioContext,this.poolManager),this.generators.acid=new K(this.audioContext,this.poolManager),this.generators.granular=new X(this.audioContext,this.poolManager),this.generators.spaceMelody=new Y(this.audioContext,this.poolManager),this.generators.ambientPad=new J(this.audioContext,this.poolManager),this.generators.arpeggiator=new Z(this.audioContext,this.poolManager),this.generators.chord=new ee(this.audioContext,this.poolManager),this.generators.vocal=new te(this.audioContext,this.poolManager),this.generators.karplus=new se(this.audioContext,this.poolManager),this.generators.additive=new ie(this.audioContext,this.poolManager),this.generators.biological=new ne(this.audioContext,this.poolManager),this.generators.chaos=new re(this.audioContext,this.poolManager),this.generators.sample=new le(this.audioContext,this.poolManager)}updateMasterTempo(e){this.masterBPM=e,this.masterTempo={bpm:e,beatsPerSecond:e/60,quarterNoteTime:60/e,eighthNoteTime:30/e,sixteenthNoteTime:15/e,barTime:240/e,barsPerMinute:e/4},this.isPlaying&&this.updateGeneratorTempos(),console.log(`Master tempo updated: ${e} BPM`)}updateGeneratorTempos(){Object.entries(this.generators).forEach(([e,t])=>{t&&t.updateTempo&&this.groupEnabled[e]&&t.updateTempo(this.masterTempo)})}getMasterTempo(){return this.masterTempo}getTempoSync(e="quarter"){switch(e){case"whole":return this.masterTempo.barTime;case"half":return this.masterTempo.quarterNoteTime*2;case"quarter":return this.masterTempo.quarterNoteTime;case"eighth":return this.masterTempo.eighthNoteTime;case"sixteenth":return this.masterTempo.sixteenthNoteTime;case"triplet":return this.masterTempo.quarterNoteTime/3;case"dotted":return this.masterTempo.quarterNoteTime*1.5;default:return this.masterTempo.quarterNoteTime}}initializePresetSystem(){this.loadPresetsFromStorage(),Object.keys(this.presets).length===0&&this.createDefaultPresets(),this.updatePresetUI()}loadPresetsFromStorage(){try{const e=localStorage.getItem("audiogen_presets");e&&(this.presets=JSON.parse(e))}catch(e){console.warn("Failed to load presets from storage:",e),this.presets={}}}savePresetsToStorage(){try{localStorage.setItem("audiogen_presets",JSON.stringify(this.presets))}catch(e){console.warn("Failed to save presets to storage:",e)}}createDefaultPresets(){this.presets={"Ambient Drone":{category:"ambient",timestamp:Date.now(),parameters:{masterBPM:90,reverb:60,delay:30,droneFreq:120,droneVoices:6,droneFilter:800,padDensity:40,spaceMelodyDensity:15,drumDensity:0,glitchIntensity:0},groupStates:{drone:!0,ambientPad:!0,spaceMelody:!0,drums:!1,glitch:!1}},"Techno Drive":{category:"techno",timestamp:Date.now(),parameters:{masterBPM:130,reverb:20,delay:15,drumDensity:80,acidLevel:40,bleepDensity:25,fmCarrier:200,noiseLevel:10},groupStates:{drums:!0,acid:!0,bleeps:!0,fm:!0,noise:!0,drone:!1}},"Experimental Chaos":{category:"experimental",timestamp:Date.now(),parameters:{masterBPM:140,reverb:80,delay:50,glitchIntensity:60,chaosDensity:70,biologicalDensity:30,grainDensity:40,burstActivity:50},groupStates:{glitch:!0,chaos:!0,biological:!0,granular:!0,burst:!0}}},this.savePresetsToStorage()}getCurrentConfiguration(){const e={},t={};return document.querySelectorAll('input[type="range"]').forEach(s=>{e[s.id]=parseFloat(s.value)}),document.querySelectorAll("select").forEach(s=>{e[s.id]=s.value}),document.querySelectorAll('input[type="checkbox"]:not(.group-enable)').forEach(s=>{e[s.id]=s.checked}),document.querySelectorAll(".group-enable").forEach(s=>{const i=s.id.replace("Enable","");t[i]=s.checked}),{parameters:e,groupStates:t,timestamp:Date.now()}}applyConfiguration(e){e.parameters&&Object.entries(e.parameters).forEach(([t,s])=>{const i=document.getElementById(t);if(i)if(i.type==="range"){i.value=s;const a=i.nextElementSibling;a&&a.classList.contains("value")&&(a.textContent=s),i.dispatchEvent(new Event("input"))}else i.type==="checkbox"?(i.checked=s,i.dispatchEvent(new Event("change"))):i.tagName==="SELECT"&&(i.value=s,i.dispatchEvent(new Event("change")))}),e.groupStates&&Object.entries(e.groupStates).forEach(([t,s])=>{const i=document.getElementById(t+"Enable");i&&(i.checked=s,i.dispatchEvent(new Event("change")))}),e.parameters&&e.parameters.masterBPM&&this.updateMasterTempo(e.parameters.masterBPM),this.isPlaying&&(this.stop(),setTimeout(()=>this.start(),100))}savePreset(){const e=document.getElementById("presetName"),t=e.value.trim();if(!t){alert("Please enter a preset name");return}if(this.presets[t]&&!confirm(`Preset "${t}" already exists. Overwrite?`))return;const s=this.getCurrentConfiguration();this.presets[t]={category:"saved",...s},this.savePresetsToStorage(),this.updatePresetUI(),e.value="";const i=document.getElementById("presetSelect");i.value=t,console.log(`Preset "${t}" saved successfully`)}loadPreset(){const t=document.getElementById("presetSelect").value;if(!t||!this.presets[t]){alert("Please select a preset to load");return}this.applyConfiguration(this.presets[t]),this.currentPreset=t,console.log(`Preset "${t}" loaded successfully`)}deletePreset(){const e=document.getElementById("presetSelect"),t=e.value;if(!t||!this.presets[t]){alert("Please select a preset to delete");return}if(this.presets[t].category==="default"){alert("Cannot delete default presets");return}confirm(`Delete preset "${t}"?`)&&(delete this.presets[t],this.savePresetsToStorage(),this.updatePresetUI(),e.value="",console.log(`Preset "${t}" deleted successfully`))}exportPresets(){const e={presets:this.presets,version:"1.0",timestamp:Date.now()},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download="audiogen_presets.json",i.click(),URL.revokeObjectURL(s),console.log("Presets exported successfully")}importPresets(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=t=>{const s=t.target.files[0];if(!s)return;const i=new FileReader;i.onload=a=>{try{const n=JSON.parse(a.target.result);n.presets?(this.presets={...this.presets,...n.presets},this.savePresetsToStorage(),this.updatePresetUI(),console.log("Presets imported successfully")):alert("Invalid preset file format")}catch(n){console.error("Error importing presets:",n),alert("Error importing presets: Invalid JSON format")}},i.readAsText(s)},e.click()}resetPresets(){confirm("Reset all presets to defaults? This will delete all saved presets.")&&(this.presets={},this.createDefaultPresets(),this.updatePresetUI(),console.log("Presets reset to defaults"))}loadSampleFiles(){const e=document.getElementById("sampleFileInput");e&&e.click()}clearSamples(){this.generators.sample&&(this.generators.sample.clearSamples(),console.log("All samples cleared"))}updatePresetUI(){const e=document.getElementById("presetSelect");if(!e)return;e.innerHTML='<option value="">Select preset...</option>';const t={};Object.entries(this.presets).forEach(([s,i])=>{const a=i.category||"saved";t[a]||(t[a]=[]),t[a].push(s)}),Object.entries(t).forEach(([s,i])=>{if(i.length>0){const a=document.createElement("optgroup");a.label=s.toUpperCase(),i.sort().forEach(n=>{const o=document.createElement("option");o.value=n,o.textContent=n,a.appendChild(o)}),e.appendChild(a)}})}startGenerators(){var e,t,s,i,a,n,o,r,c,h;if(this.groupEnabled.drone){const l={frequency:parseFloat(document.getElementById("droneFreq").value),detune:parseFloat(document.getElementById("droneDetune").value),voices:parseInt(document.getElementById("droneVoices").value),filterFreq:parseFloat(document.getElementById("droneFilter").value)};this.generators.drone.start(l);const d=this.generators.drone.getOutputNode();d&&this.connectToMaster(d)}if(this.groupEnabled.drums){const l={pattern:document.getElementById("drumPattern").value,tempo:this.masterBPM,density:parseFloat(document.getElementById("drumDensity").value)/100,variation:parseFloat(document.getElementById("drumVariation").value)/100,swing:parseFloat(document.getElementById("drumSwing").value)/100,snareRush:parseFloat(document.getElementById("snareRush").value)/100,ghostNotes:parseFloat(document.getElementById("ghostNotes").value)/100,hihatSpeed:parseInt(document.getElementById("hihatSpeed").value),patternMode:((e=document.getElementById("drumPatternMode"))==null?void 0:e.value)||"traditional",euclideanSteps:parseInt(((t=document.getElementById("euclideanSteps"))==null?void 0:t.value)||16),kickPulses:parseInt(((s=document.getElementById("kickPulses"))==null?void 0:s.value)||4),snarePulses:parseInt(((i=document.getElementById("snarePulses"))==null?void 0:i.value)||2),hihatPulses:parseInt(((a=document.getElementById("hihatPulses"))==null?void 0:a.value)||8),probability:(n=document.getElementById("drumProbability"))==null?void 0:n.checked,humanize:parseFloat(((o=document.getElementById("drumHumanize"))==null?void 0:o.value)||20)/100,useSamples:((r=document.getElementById("useSampleKit"))==null?void 0:r.checked)||!1,samplePitch:parseFloat(((c=document.getElementById("drumSamplePitch"))==null?void 0:c.value)||1),pitchVariation:parseFloat(((h=document.getElementById("drumPitchVariation"))==null?void 0:h.value)||0)};this.generators.drums.start(l,this.masterBus.getConnectionNodes())}if(this.groupEnabled.glitch){const l={intensity:parseFloat(document.getElementById("glitchIntensity").value)/100,rate:parseFloat(document.getElementById("glitchRate").value),bitCrush:parseInt(document.getElementById("bitCrush").value)};this.generators.glitch.start(l);const d=this.generators.glitch.getOutputNode();d&&this.connectToMaster(d)}if(this.groupEnabled.bleeps){const l={density:parseFloat(document.getElementById("bleepDensity").value)/100,range:parseFloat(document.getElementById("bleepRange").value),duration:parseFloat(document.getElementById("bleepDuration").value)};this.generators.bleeps.start(l,d=>this.connectToMaster(d),this.getEnvelopeForGroup("bleeps"))}if(this.groupEnabled.burst){const l={activity:parseFloat(document.getElementById("burstActivity").value)/100,complexity:parseInt(document.getElementById("burstComplexity").value),speed:parseFloat(document.getElementById("burstSpeed").value)};this.generators.burst.start(l,d=>this.connectToMaster(d))}if(this.groupEnabled.fm){const l={carrierFreq:parseFloat(document.getElementById("fmCarrier").value),modIndex:parseFloat(document.getElementById("fmIndex").value)/100,ratio:parseFloat(document.getElementById("fmRatio").value),lfoSpeed:parseFloat(document.getElementById("fmLFO").value)};this.generators.fm.start(l);const d=this.generators.fm.getOutputNode();d&&this.connectToMaster(d)}if(this.groupEnabled.noise){const l={type:document.getElementById("noiseType").value,level:parseFloat(document.getElementById("noiseLevel").value)/100,filterFreq:parseFloat(document.getElementById("noiseFilter").value)};this.generators.noise.start(l);const d=this.generators.noise.getOutputNode();d&&this.connectToMaster(d)}if(this.groupEnabled.acid){const l={level:parseFloat(document.getElementById("acidLevel").value)/100,baseFreq:parseFloat(document.getElementById("acidFreq").value),resonance:parseFloat(document.getElementById("acidResonance").value)/100,decay:parseFloat(document.getElementById("acidDecay").value),speed:parseFloat(document.getElementById("acidSpeed").value),tempo:parseInt(document.getElementById("drumTempo").value)};this.generators.acid.start(l,d=>this.connectToMaster(d))}if(this.groupEnabled.granular){const l={density:parseFloat(document.getElementById("grainDensity").value)/100,grainSize:parseFloat(document.getElementById("grainSize").value),pitchSpread:parseFloat(document.getElementById("grainPitch").value)/100,panSpread:parseFloat(document.getElementById("grainPan").value)/100};this.generators.granular.start(l,this.masterBus.getConnectionNodes())}if(this.groupEnabled.spaceMelody){const l={density:parseFloat(document.getElementById("spaceMelodyDensity").value)/100,range:parseInt(document.getElementById("spaceMelodyRange").value),speed:parseFloat(document.getElementById("spaceMelodySpeed").value),echo:parseFloat(document.getElementById("spaceMelodyEcho").value)/100,portamento:parseFloat(document.getElementById("spaceMelodyPortamento").value)};this.generators.spaceMelody.start(l,this.masterBus.getConnectionNodes())}if(this.groupEnabled.ambientPad){const l={density:parseFloat(document.getElementById("padDensity").value)/100,attack:parseFloat(document.getElementById("padAttack").value),release:parseFloat(document.getElementById("padRelease").value),filterSweep:parseFloat(document.getElementById("padFilterSweep").value)/100,shimmer:parseFloat(document.getElementById("padShimmer").value)/100};this.generators.ambientPad.start(l,this.masterBus.getConnectionNodes())}if(this.groupEnabled.arpeggiator){const l={enable:parseFloat(document.getElementById("arpEnable").value)/100,pattern:document.getElementById("arpPattern").value,speed:parseInt(document.getElementById("arpSpeed").value),octaves:parseInt(document.getElementById("arpOctaves").value),gate:parseFloat(document.getElementById("arpGate").value)/100,tempo:this.masterBPM};this.generators.arpeggiator.start(l,this.masterBus.getConnectionNodes())}if(this.groupEnabled.chord){const l={density:parseFloat(document.getElementById("chordDensity").value)/100,progression:document.getElementById("chordProgression").value,voicing:document.getElementById("chordVoicing").value,brightness:parseFloat(document.getElementById("chordBrightness").value),spread:parseFloat(document.getElementById("chordSpread").value)};this.generators.chord.start(l,d=>this.connectToMaster(d))}if(this.groupEnabled.vocal){const l={density:parseFloat(document.getElementById("vocalDensity").value)/100,vowel:document.getElementById("vocalVowel").value,pitch:parseFloat(document.getElementById("vocalPitch").value),vibrato:parseFloat(document.getElementById("vocalVibrato").value)/100,whisper:parseFloat(document.getElementById("vocalWhisper").value)/100};this.generators.vocal.start(l,d=>this.connectToMaster(d))}if(this.groupEnabled.karplus){const l={density:parseFloat(document.getElementById("karplusDensity").value)/100,pitch:parseFloat(document.getElementById("karplusPitch").value),damping:parseFloat(document.getElementById("karplusDamping").value),brightness:parseFloat(document.getElementById("karplusBrightness").value),pluckHardness:parseFloat(document.getElementById("karplusPluck").value)/100};this.generators.karplus.start(l,d=>this.connectToMaster(d))}if(this.groupEnabled.additive){const l={density:parseFloat(document.getElementById("additiveDensity").value)/100,fundamental:parseFloat(document.getElementById("additiveFundamental").value),harmonics:parseInt(document.getElementById("additiveHarmonics").value),harmonicDecay:parseFloat(document.getElementById("additiveDecay").value),inharmonicity:parseFloat(document.getElementById("additiveInharmonicity").value),brightness:parseFloat(document.getElementById("additiveBrightness").value)};this.generators.additive.start(l,d=>this.connectToMaster(d))}if(this.groupEnabled.biological){const l={density:parseFloat(document.getElementById("bioDensity").value)/100,type:document.getElementById("bioType").value,evolution:parseFloat(document.getElementById("bioEvolution").value),harmony:parseFloat(document.getElementById("bioHarmony").value)/100,variation:parseFloat(document.getElementById("bioVariation").value)/100,complexity:parseFloat(document.getElementById("bioComplexity").value)/100,adaptive:document.getElementById("bioAdaptive").checked};this.generators.biological.start(l,d=>this.connectToMaster(d))}if(this.groupEnabled.chaos){const l={density:parseFloat(document.getElementById("chaosDensity").value)/100,type:document.getElementById("chaosType").value,intensity:parseFloat(document.getElementById("chaosIntensity").value)/100,scale:document.getElementById("chaosScale").value,resonance:parseFloat(document.getElementById("chaosResonance").value)/100,speed:parseFloat(document.getElementById("chaosSpeed").value),filter:document.getElementById("chaosFilter").checked};this.generators.chaos.start(l,d=>this.connectToMaster(d))}if(this.groupEnabled.sample){const l={density:parseFloat(document.getElementById("sampleDensity").value)/100,pitch:parseFloat(document.getElementById("samplePitch").value),reverse:parseFloat(document.getElementById("sampleReverse").value)/100,chop:parseFloat(document.getElementById("sampleChop").value)/100,scatter:parseFloat(document.getElementById("sampleScatter").value)/100,granular:parseFloat(document.getElementById("sampleGranular").value)/100,filterFreq:parseFloat(document.getElementById("sampleFilterFreq").value),filterRes:parseFloat(document.getElementById("sampleFilterRes").value)};this.generators.sample.start(l,this.masterBus.getConnectionNodes())}this.updateMasterTempo(this.masterBPM)}connectToMaster(e){if(e&&this.masterBus){const t=this.masterBus.getConnectionNodes();e.connect(t.dryGain),e.connect(t.convolver),e.connect(t.delay)}}updateGroupState(e,t){var s,i,a,n,o,r,c,h,l,d;if(this.groupEnabled[e]=t,!!this.isPlaying&&(this.generators[e]&&this.generators[e].stop&&this.generators[e].stop(),t))switch(e){case"drone":const p={frequency:parseFloat(document.getElementById("droneFreq").value),detune:parseFloat(document.getElementById("droneDetune").value),voices:parseInt(document.getElementById("droneVoices").value),filterFreq:parseFloat(document.getElementById("droneFilter").value)};this.generators.drone.start(p);const u=this.generators.drone.getOutputNode();u&&this.connectToMaster(u);break;case"drums":const g=((s=document.getElementById("drumPatternMode"))==null?void 0:s.value)||"traditional",m=g!=="traditional",f=this.generators.drums instanceof D;m!==f&&(this.generators.drums=m?new D(this.audioContext,this.poolManager):new L(this.audioContext,this.poolManager),this.generators.drums.setupFileInput&&this.generators.drums.setupFileInput());const x={pattern:document.getElementById("drumPattern").value,tempo:parseInt(document.getElementById("drumTempo").value),density:parseFloat(document.getElementById("drumDensity").value)/100,variation:parseFloat(document.getElementById("drumVariation").value)/100,swing:parseFloat(document.getElementById("drumSwing").value)/100,snareRush:parseFloat(document.getElementById("snareRush").value)/100,ghostNotes:parseFloat(document.getElementById("ghostNotes").value)/100,hihatSpeed:parseInt(document.getElementById("hihatSpeed").value),patternMode:g,euclideanSteps:parseInt(((i=document.getElementById("euclideanSteps"))==null?void 0:i.value)||16),kickPulses:parseInt(((a=document.getElementById("kickPulses"))==null?void 0:a.value)||4),snarePulses:parseInt(((n=document.getElementById("snarePulses"))==null?void 0:n.value)||2),hihatPulses:parseInt(((o=document.getElementById("hihatPulses"))==null?void 0:o.value)||8),probability:(r=document.getElementById("drumProbability"))==null?void 0:r.checked,humanize:parseFloat(((c=document.getElementById("drumHumanize"))==null?void 0:c.value)||20)/100,useSamples:((h=document.getElementById("useSampleKit"))==null?void 0:h.checked)||!1,samplePitch:parseFloat(((l=document.getElementById("drumSamplePitch"))==null?void 0:l.value)||1),pitchVariation:parseFloat(((d=document.getElementById("drumPitchVariation"))==null?void 0:d.value)||0)};this.generators.drums.start(x,this.masterBus.getConnectionNodes());break;case"glitch":const M={intensity:parseFloat(document.getElementById("glitchIntensity").value)/100,rate:parseFloat(document.getElementById("glitchRate").value),bitCrush:parseInt(document.getElementById("bitCrush").value)};this.generators.glitch.start(M);const k=this.generators.glitch.getOutputNode();k&&this.connectToMaster(k);break;case"bleeps":const T={density:parseFloat(document.getElementById("bleepDensity").value)/100,range:parseFloat(document.getElementById("bleepRange").value),duration:parseFloat(document.getElementById("bleepDuration").value)};this.generators.bleeps.start(T,S=>this.connectToMaster(S),this.getEnvelopeForGroup("bleeps"));break;case"burst":const b={activity:parseFloat(document.getElementById("burstActivity").value)/100,complexity:parseInt(document.getElementById("burstComplexity").value),speed:parseFloat(document.getElementById("burstSpeed").value)};this.generators.burst.start(b,S=>this.connectToMaster(S));break;case"fm":const C={carrierFreq:parseFloat(document.getElementById("fmCarrier").value),modIndex:parseFloat(document.getElementById("fmIndex").value)/100,ratio:parseFloat(document.getElementById("fmRatio").value),lfoSpeed:parseFloat(document.getElementById("fmLFO").value)};this.generators.fm.start(C);const F=this.generators.fm.getOutputNode();F&&this.connectToMaster(F);break;case"noise":const E={type:document.getElementById("noiseType").value,level:parseFloat(document.getElementById("noiseLevel").value)/100,filterFreq:parseFloat(document.getElementById("noiseFilter").value)};this.generators.noise.start(E);const P=this.generators.noise.getOutputNode();P&&this.connectToMaster(P);break;case"acid":const v={level:parseFloat(document.getElementById("acidLevel").value)/100,baseFreq:parseFloat(document.getElementById("acidFreq").value),resonance:parseFloat(document.getElementById("acidResonance").value)/100,decay:parseFloat(document.getElementById("acidDecay").value),speed:parseFloat(document.getElementById("acidSpeed").value),tempo:parseInt(document.getElementById("drumTempo").value)};this.generators.acid.start(v,S=>this.connectToMaster(S));break;case"granular":const B={density:parseFloat(document.getElementById("grainDensity").value)/100,grainSize:parseFloat(document.getElementById("grainSize").value),pitchSpread:parseFloat(document.getElementById("grainPitch").value)/100,panSpread:parseFloat(document.getElementById("grainPan").value)/100};this.generators.granular.start(B,this.masterBus.getConnectionNodes());break;case"spaceMelody":const I={density:parseFloat(document.getElementById("spaceMelodyDensity").value)/100,range:parseInt(document.getElementById("spaceMelodyRange").value),speed:parseFloat(document.getElementById("spaceMelodySpeed").value),echo:parseFloat(document.getElementById("spaceMelodyEcho").value)/100,portamento:parseFloat(document.getElementById("spaceMelodyPortamento").value)};this.generators.spaceMelody.start(I,this.masterBus.getConnectionNodes());break;case"ambientPad":const w={density:parseFloat(document.getElementById("padDensity").value)/100,attack:parseFloat(document.getElementById("padAttack").value),release:parseFloat(document.getElementById("padRelease").value),filterSweep:parseFloat(document.getElementById("padFilterSweep").value)/100,shimmer:parseFloat(document.getElementById("padShimmer").value)/100};this.generators.ambientPad.start(w,this.masterBus.getConnectionNodes());break;case"arpeggiator":const Te={enable:parseFloat(document.getElementById("arpEnable").value)/100,pattern:document.getElementById("arpPattern").value,speed:parseInt(document.getElementById("arpSpeed").value),octaves:parseInt(document.getElementById("arpOctaves").value),gate:parseFloat(document.getElementById("arpGate").value)/100,tempo:parseInt(document.getElementById("drumTempo").value)};this.generators.arpeggiator.start(Te,this.masterBus.getConnectionNodes());break;case"chord":const Ee={density:parseFloat(document.getElementById("chordDensity").value)/100,progression:document.getElementById("chordProgression").value,voicing:document.getElementById("chordVoicing").value,brightness:parseFloat(document.getElementById("chordBrightness").value),spread:parseFloat(document.getElementById("chordSpread").value)};this.generators.chord.start(Ee,S=>this.connectToMaster(S));break;case"vocal":const Se={density:parseFloat(document.getElementById("vocalDensity").value)/100,vowel:document.getElementById("vocalVowel").value,pitch:parseFloat(document.getElementById("vocalPitch").value),vibrato:parseFloat(document.getElementById("vocalVibrato").value)/100,whisper:parseFloat(document.getElementById("vocalWhisper").value)/100};this.generators.vocal.start(Se,S=>this.connectToMaster(S));break;case"karplus":const Pe={density:parseFloat(document.getElementById("karplusDensity").value)/100,pitch:parseFloat(document.getElementById("karplusPitch").value),damping:parseFloat(document.getElementById("karplusDamping").value),brightness:parseFloat(document.getElementById("karplusBrightness").value),pluckHardness:parseFloat(document.getElementById("karplusPluck").value)/100};this.generators.karplus.start(Pe,S=>this.connectToMaster(S));break;case"additive":const ke={density:parseFloat(document.getElementById("additiveDensity").value)/100,fundamental:parseFloat(document.getElementById("additiveFundamental").value),harmonics:parseInt(document.getElementById("additiveHarmonics").value),harmonicDecay:parseFloat(document.getElementById("additiveDecay").value),inharmonicity:parseFloat(document.getElementById("additiveInharmonicity").value),brightness:parseFloat(document.getElementById("additiveBrightness").value)};this.generators.additive.start(ke,S=>this.connectToMaster(S));break}}updateParameter(e,t){if(e.startsWith("drone")){if(this.generators.drone&&this.generators.drone.updateParameter){const s=e.replace("drone","").toLowerCase();this.generators.drone.updateParameter(s,t)}}else if(e==="bitCrush")this.generators.glitch&&this.generators.glitch.updateParameter&&this.generators.glitch.updateParameter("bitcrush",t);else if(e==="glitchIntensity")this.generators.glitch&&this.generators.glitch.updateParameter&&this.generators.glitch.updateParameter("intensity",t);else if(e.startsWith("fm")){if(this.generators.fm&&this.generators.fm.updateParameter){const s=e.replace("fm","").toLowerCase();this.generators.fm.updateParameter(s,t)}}else if(e.startsWith("noise")){if(this.generators.noise&&this.generators.noise.updateParameter){const s=e.replace("noise","").toLowerCase();this.generators.noise.updateParameter(s,t)}}else e==="spaceMelodyEcho"&&this.generators.spaceMelody&&this.generators.spaceMelody.updateParameter&&this.generators.spaceMelody.updateParameter("echo",t/100)}disconnectAll(){this.masterBus&&this.masterBus.disconnect()}startAnimations(){this.animatedParams.forEach((e,t)=>{this.animateParameter(t,e)})}setParameterAnimation(e,t){if(t==="none"){const s=this.animatedParams.get(e);s&&s.interval&&clearInterval(s.interval),this.animatedParams.delete(e)}else this.animatedParams.set(e,{mode:t,phase:0}),this.isPlaying&&this.animateParameter(e,this.animatedParams.get(e))}animateParameter(e,t){const s=document.getElementById(e);if(!s)return;const i=parseFloat(s.min),n=parseFloat(s.max)-i;t.interval&&clearInterval(t.interval),t.interval=setInterval(()=>{let o;switch(t.mode){case"lfo":t.phase+=.02,o=i+(Math.sin(t.phase)*.5+.5)*n;break;case"random":if(Math.random()<.1)o=i+Math.random()*n;else return;break;case"drift":const r=i+Math.random()*n,c=parseFloat(s.value);o=c+(r-c)*.05;break}o!==void 0&&(s.value=o,s.dispatchEvent(new Event("input")))},50)}getGroupForParameter(e){return e.startsWith("drone")?"drone":e.startsWith("glitch")||e==="bitCrush"?"glitch":e.startsWith("drum")||e.includes("snare")||e.includes("ghost")||e.includes("hihat")?"drums":e.startsWith("bleep")?"bleeps":e.startsWith("burst")?"burst":e.startsWith("fm")?"fm":e.startsWith("noise")?"noise":e.startsWith("acid")?"acid":e.startsWith("grain")?"granular":e.startsWith("spaceMelody")?"spaceMelody":e.startsWith("pad")?"ambientPad":e.startsWith("arp")&&e!=="arpEnable"?"arpeggiator":e.startsWith("chord")?"chord":e.startsWith("vocal")?"vocal":e.startsWith("karplus")?"karplus":e.startsWith("additive")?"additive":e.startsWith("bio")?"biological":e.startsWith("chaos")?"chaos":e.startsWith("sample")?"sample":null}randomize(){var E,P;[{id:"masterBPM",min:80,max:160},{id:"reverb",min:0,max:100},{id:"delay",min:0,max:100},{id:"delayTime",min:.1,max:1},{id:"droneFreq",min:50,max:500},{id:"droneDetune",min:0,max:50},{id:"droneVoices",min:1,max:8},{id:"droneFilter",min:100,max:5e3},{id:"droneLFO",min:0,max:10},{id:"glitchIntensity",min:0,max:30},{id:"glitchRate",min:.1,max:10},{id:"bitCrush",min:4,max:16},{id:"drumTempo",min:80,max:140},{id:"drumDensity",min:20,max:80},{id:"drumVariation",min:0,max:50},{id:"drumSwing",min:0,max:50},{id:"snareRush",min:0,max:30},{id:"ghostNotes",min:0,max:30},{id:"hihatSpeed",min:1,max:4},{id:"bleepDensity",min:0,max:20},{id:"bleepRange",min:500,max:5e3},{id:"bleepDuration",min:.01,max:.2},{id:"burstActivity",min:0,max:30},{id:"burstComplexity",min:1,max:5},{id:"burstSpeed",min:.5,max:5},{id:"fmCarrier",min:100,max:500},{id:"fmIndex",min:0,max:30},{id:"fmRatio",min:.5,max:5},{id:"fmLFO",min:0,max:10},{id:"noiseLevel",min:0,max:20},{id:"noiseFilter",min:500,max:5e3},{id:"acidLevel",min:0,max:50},{id:"acidFreq",min:80,max:300},{id:"acidResonance",min:20,max:80},{id:"acidDecay",min:.2,max:1},{id:"acidSpeed",min:.5,max:2},{id:"grainDensity",min:0,max:30},{id:"grainSize",min:20,max:200},{id:"grainPitch",min:0,max:50},{id:"grainPan",min:0,max:50},{id:"spaceMelodyDensity",min:0,max:30},{id:"spaceMelodyRange",min:1,max:3},{id:"spaceMelodySpeed",min:.5,max:2},{id:"spaceMelodyEcho",min:0,max:50},{id:"spaceMelodyPortamento",min:0,max:200},{id:"padDensity",min:0,max:30},{id:"padAttack",min:1,max:5},{id:"padRelease",min:1,max:5},{id:"padFilterSweep",min:0,max:50},{id:"padShimmer",min:0,max:50},{id:"arpEnable",min:0,max:30},{id:"arpSpeed",min:2,max:12},{id:"arpOctaves",min:1,max:3},{id:"arpGate",min:30,max:70},{id:"chordDensity",min:0,max:30},{id:"chordRoot",min:140,max:280},{id:"chordTempo",min:40,max:100},{id:"chordBrightness",min:500,max:3e3},{id:"chordSpread",min:0,max:30},{id:"vocalDensity",min:0,max:20},{id:"vocalPitch",min:150,max:300},{id:"vocalVibrato",min:0,max:50},{id:"vocalWhisper",min:0,max:50},{id:"karplusDensity",min:0,max:25},{id:"karplusPitch",min:150,max:500},{id:"karplusDamping",min:.9,max:.99},{id:"karplusBrightness",min:2e3,max:8e3},{id:"karplusPluck",min:20,max:80},{id:"euclideanSteps",min:8,max:32},{id:"kickPulses",min:1,max:12},{id:"snarePulses",min:1,max:8},{id:"hihatPulses",min:1,max:16},{id:"drumHumanize",min:0,max:50},{id:"additiveDensity",min:0,max:25},{id:"additiveFundamental",min:100,max:400},{id:"additiveHarmonics",min:3,max:12},{id:"additiveDecay",min:1,max:2},{id:"additiveInharmonicity",min:0,max:5},{id:"additiveBrightness",min:1e3,max:5e3},{id:"bioDensity",min:0,max:30},{id:"bioEvolution",min:50,max:200},{id:"bioHarmony",min:30,max:90},{id:"bioVariation",min:20,max:80},{id:"bioComplexity",min:30,max:90},{id:"chaosDensity",min:0,max:30},{id:"chaosIntensity",min:20,max:80},{id:"chaosResonance",min:30,max:90},{id:"chaosSpeed",min:50,max:150},{id:"sampleDensity",min:0,max:30},{id:"samplePitch",min:.5,max:2},{id:"sampleReverse",min:0,max:50},{id:"sampleChop",min:0,max:50},{id:"sampleScatter",min:0,max:50},{id:"sampleGranular",min:0,max:50},{id:"sampleFilterFreq",min:1e3,max:8e3},{id:"sampleFilterRes",min:.5,max:5},{id:"compressorMix",min:50,max:100},{id:"compThreshold",min:20,max:60},{id:"compRatio",min:30,max:80},{id:"eqLow",min:-6,max:6},{id:"eqMid",min:-6,max:6},{id:"eqHigh",min:-6,max:6},{id:"distortionMix",min:0,max:30},{id:"distDrive",min:10,max:70},{id:"chorusMix",min:0,max:40},{id:"chorusRate",min:10,max:50},{id:"sidechainAmount",min:20,max:80}].forEach(v=>{const B=document.getElementById(v.id);if(B){const I=this.getGroupForParameter(v.id);let w;I&&!this.groupEnabled[I]?v.id.includes("Density")||v.id.includes("Level")||v.id.includes("Activity")||v.id==="arpEnable"?w=v.min+(v.max-v.min)*.3:w=Math.random()*(v.max-v.min)+v.min:v.id==="drumDensity"?w=v.min+Math.pow(Math.random(),.7)*(v.max-v.min):v.id.includes("Density")||v.id.includes("Intensity")||v.id.includes("Level")||v.id.includes("Enable")||v.id.includes("Activity")||v.id.includes("Rush")||v.id.includes("Ghost")?w=v.min+(1-Math.pow(Math.random(),3))*(v.max-v.min):w=Math.random()*(v.max-v.min)+v.min,B.value=w,B.dispatchEvent(new Event("input"))}});const t=["techno","breakbeat","jungle","idm","gabber","trap"],s=document.getElementById("drumPattern");s&&(s.value=t[Math.floor(Math.random()*t.length)],s.dispatchEvent(new Event("change")));const i=["traditional","euclidean","markov","polyrhythm"],a=document.getElementById("drumPatternMode");a&&(a.value=i[Math.floor(Math.random()*i.length)],a.dispatchEvent(new Event("change")));const n=document.getElementById("drumProbability");n&&(n.checked=Math.random()>.3,n.dispatchEvent(new Event("change")));const o=document.getElementById("useSampleKit"),r=document.getElementById("drumKitStatus");o&&r&&!r.textContent.includes("No samples")&&(o.checked=Math.random()>.5,o.dispatchEvent(new Event("change")));const c=["white","pink","brown","crackle"],h=document.getElementById("noiseType");h&&(h.value=c[Math.floor(Math.random()*c.length)],h.dispatchEvent(new Event("change")));const l=["up","down","updown","random"],d=document.getElementById("arpPattern");d&&(d.value=l[Math.floor(Math.random()*l.length)],d.dispatchEvent(new Event("change")));const p=["major","minor","jazz","suspended"],u=document.getElementById("chordProgression");u&&(u.value=p[Math.floor(Math.random()*p.length)],u.dispatchEvent(new Event("change")));const g=["close","open","drop2","spread"],m=document.getElementById("chordVoicing");m&&(m.value=g[Math.floor(Math.random()*g.length)],m.dispatchEvent(new Event("change")));const f=["a","e","i","o","u","ah","oo"],x=document.getElementById("vocalVowel");x&&(x.value=f[Math.floor(Math.random()*f.length)],x.dispatchEvent(new Event("change")));const M=document.getElementById("sampleSelect");if(M&&M.options.length>0){const v=Math.floor(Math.random()*M.options.length);M.selectedIndex=v,M.dispatchEvent(new Event("change"))}document.querySelectorAll(".lfo-button").forEach(v=>{(Math.random()<.2&&!v.classList.contains("active")||Math.random()<.8&&v.classList.contains("active"))&&v.click()});const k=parseInt(((E=document.getElementById("minGroups"))==null?void 0:E.value)||3),T=parseInt(((P=document.getElementById("maxGroups"))==null?void 0:P.value)||8),b=k+Math.floor(Math.random()*(T-k+1));[...Array.from(document.querySelectorAll(".group-enable")).filter(v=>v.id!=="arpEnable"&&v.id!=="sidechainEnable")].sort(()=>Math.random()-.5).forEach((v,B)=>{const I=B<b;v.checked!==I&&(v.checked=I,v.dispatchEvent(new Event("change")))})}startMorph(){if(this.morphing){this.morphing=!1;return}this.morphStartValues=new Map,[...document.querySelectorAll('input[type="range"]')].filter(t=>t.id!=="masterVolume").forEach(t=>{this.morphStartValues.set(t.id,parseFloat(t.value))}),this.generateMorphTargets(),this.morphDuration=parseFloat(document.getElementById("morphTime").value)*1e3,this.morphing=!0,this.morphStartTime=Date.now(),document.getElementById("morphButton").textContent="STOP MORPH",this.animateMorph()}generateMorphTargets(){var r,c;if(this.morphTargets=new Map,[{id:"reverb",min:0,max:100,group:"master"},{id:"delay",min:0,max:100,group:"master"},{id:"delayTime",min:.1,max:1,group:"master"},{id:"droneFreq",min:50,max:500,group:"drone"},{id:"droneDetune",min:0,max:50,group:"drone"},{id:"droneVoices",min:1,max:4,group:"drone"},{id:"droneFilter",min:100,max:5e3,group:"drone"},{id:"droneLFO",min:0,max:10,group:"drone"},{id:"glitchIntensity",min:0,max:30,group:"glitch"},{id:"glitchRate",min:.1,max:10,group:"glitch"},{id:"bitCrush",min:4,max:16,group:"glitch"},{id:"drumTempo",min:80,max:140,group:"drums"},{id:"drumDensity",min:20,max:80,group:"drums"},{id:"drumVariation",min:0,max:50,group:"drums"},{id:"drumSwing",min:0,max:50,group:"drums"},{id:"snareRush",min:0,max:30,group:"drums"},{id:"ghostNotes",min:0,max:30,group:"drums"},{id:"hihatSpeed",min:1,max:4,group:"drums"},{id:"bleepDensity",min:0,max:20,group:"bleeps"},{id:"bleepRange",min:500,max:5e3,group:"bleeps"},{id:"bleepDuration",min:.01,max:.2,group:"bleeps"},{id:"burstActivity",min:0,max:30,group:"burst"},{id:"burstComplexity",min:1,max:5,group:"burst"},{id:"burstSpeed",min:.5,max:5,group:"burst"},{id:"fmCarrier",min:100,max:500,group:"fm"},{id:"fmIndex",min:0,max:30,group:"fm"},{id:"fmRatio",min:.5,max:5,group:"fm"},{id:"fmLFO",min:0,max:10,group:"fm"},{id:"noiseLevel",min:0,max:20,group:"noise"},{id:"noiseFilter",min:500,max:5e3,group:"noise"},{id:"acidLevel",min:0,max:50,group:"acid"},{id:"acidFreq",min:80,max:300,group:"acid"},{id:"acidResonance",min:20,max:80,group:"acid"},{id:"acidDecay",min:.2,max:1,group:"acid"},{id:"acidSpeed",min:.5,max:2,group:"acid"},{id:"grainDensity",min:0,max:30,group:"granular"},{id:"grainSize",min:20,max:200,group:"granular"},{id:"grainPitch",min:0,max:50,group:"granular"},{id:"grainPan",min:0,max:50,group:"granular"},{id:"spaceMelodyDensity",min:0,max:30,group:"spaceMelody"},{id:"spaceMelodyRange",min:1,max:3,group:"spaceMelody"},{id:"spaceMelodySpeed",min:.5,max:2,group:"spaceMelody"},{id:"spaceMelodyEcho",min:0,max:50,group:"spaceMelody"},{id:"spaceMelodyPortamento",min:0,max:200,group:"spaceMelody"},{id:"padDensity",min:0,max:30,group:"ambientPad"},{id:"padAttack",min:1,max:5,group:"ambientPad"},{id:"padRelease",min:1,max:5,group:"ambientPad"},{id:"padFilterSweep",min:0,max:50,group:"ambientPad"},{id:"padShimmer",min:0,max:50,group:"ambientPad"},{id:"arpEnable",min:0,max:30,group:"arpeggiator"},{id:"arpSpeed",min:2,max:12,group:"arpeggiator"},{id:"arpOctaves",min:1,max:3,group:"arpeggiator"},{id:"arpGate",min:30,max:70,group:"arpeggiator"},{id:"chordDensity",min:0,max:30,group:"chord"},{id:"chordRoot",min:140,max:280,group:"chord"},{id:"chordTempo",min:40,max:100,group:"chord"},{id:"chordBrightness",min:500,max:3e3,group:"chord"},{id:"chordSpread",min:0,max:30,group:"chord"},{id:"vocalDensity",min:0,max:20,group:"vocal"},{id:"vocalPitch",min:150,max:300,group:"vocal"},{id:"vocalVibrato",min:0,max:50,group:"vocal"},{id:"vocalWhisper",min:0,max:50,group:"vocal"},{id:"karplusDensity",min:0,max:25,group:"karplus"},{id:"karplusPitch",min:150,max:500,group:"karplus"},{id:"karplusDamping",min:.9,max:.99,group:"karplus"},{id:"karplusBrightness",min:2e3,max:8e3,group:"karplus"},{id:"karplusPluck",min:20,max:80,group:"karplus"},{id:"additiveDensity",min:0,max:25,group:"additive"},{id:"additiveFundamental",min:100,max:400,group:"additive"},{id:"additiveHarmonics",min:3,max:12,group:"additive"},{id:"additiveDecay",min:1,max:2,group:"additive"},{id:"additiveInharmonicity",min:0,max:5,group:"additive"},{id:"additiveBrightness",min:1e3,max:5e3,group:"additive"},{id:"sampleDensity",min:0,max:30,group:"sample"},{id:"samplePitch",min:.5,max:2,group:"sample"},{id:"sampleReverse",min:0,max:50,group:"sample"},{id:"sampleChop",min:0,max:50,group:"sample"},{id:"sampleScatter",min:0,max:50,group:"sample"}].forEach(h=>{if(h.group!=="master"&&!this.groupEnabled[h.group])return;let l;h.id==="drumDensity"?l=h.min+Math.pow(Math.random(),.7)*(h.max-h.min):h.id.includes("Density")||h.id.includes("Intensity")||h.id.includes("Level")||h.id.includes("Enable")||h.id.includes("Activity")||h.id.includes("Rush")||h.id.includes("Ghost")?l=h.min+(1-Math.pow(Math.random(),3))*(h.max-h.min):l=Math.random()*(h.max-h.min)+h.min,this.morphTargets.set(h.id,l)}),this.groupEnabled.drums){const h=["techno","breakbeat","jungle","idm","gabber","trap"];this.morphTargets.set("drumPattern",h[Math.floor(Math.random()*h.length)])}if(this.groupEnabled.noise){const h=["white","pink","brown","crackle"];this.morphTargets.set("noiseType",h[Math.floor(Math.random()*h.length)])}if(this.groupEnabled.arpeggiator){const h=["up","down","updown","random"];this.morphTargets.set("arpPattern",h[Math.floor(Math.random()*h.length)])}if(this.groupEnabled.chord){const h=["major","minor","jazz","suspended"];this.morphTargets.set("chordProgression",h[Math.floor(Math.random()*h.length)]);const l=["close","open","drop2","spread"];this.morphTargets.set("chordVoicing",l[Math.floor(Math.random()*l.length)])}if(this.groupEnabled.vocal){const h=["a","e","i","o","u","ah","oo"];this.morphTargets.set("vocalVowel",h[Math.floor(Math.random()*h.length)])}if(this.groupEnabled.drums){const h=["traditional","euclidean","markov","polyrhythm"];this.morphTargets.set("drumPatternMode",h[Math.floor(Math.random()*h.length)]),this.morphTargets.set("drumProbability",Math.random()>.3)}const t=parseInt(((r=document.getElementById("minGroups"))==null?void 0:r.value)||3),s=parseInt(((c=document.getElementById("maxGroups"))==null?void 0:c.value)||8),i=t+Math.floor(Math.random()*(s-t+1));[...Object.keys(this.groupEnabled)].sort(()=>Math.random()-.5).forEach((h,l)=>{const d=l<i;this.morphTargets.set(h+"Enable",d)}),["reverb","delay","droneFreq","droneFilter","droneDetune","glitchIntensity","glitchRate","bitCrush","drumTempo","drumDensity","drumSwing","bleepRange","bleepDuration","burstActivity","burstSpeed","fmCarrier","fmIndex","fmRatio","noiseFilter","noiseLevel","acidFreq","acidResonance","grainDensity","grainSize","grainPitch","spaceMelodyDensity","spaceMelodySpeed","spaceMelodyPortamento","spaceMelodyEcho","padFilterSweep","padShimmer","arpSpeed","arpGate","chordDensity","chordRoot","chordTempo","chordBrightness","chordSpread","vocalDensity","vocalPitch","vocalVibrato","vocalWhisper","karplusDensity","karplusPitch","karplusDamping","karplusBrightness","karplusPluck"].forEach(h=>{if(Math.random()<.2){const l=["lfo","random","other"],d=l[Math.floor(Math.random()*l.length)];this.morphTargets.set(h+"Mod",d)}else this.morphTargets.set(h+"Mod","fixed")})}animateMorph(){if(!this.morphing){document.getElementById("morphButton").textContent="MORPH";return}const e=Date.now()-this.morphStartTime,t=Math.min(e/this.morphDuration,1),s=.5-Math.cos(t*Math.PI)/2;if(this.morphStartValues.forEach((i,a)=>{const n=this.morphTargets.get(a);if(n!==void 0&&typeof n=="number"){const o=document.getElementById(a);if(o){const r=i+(n-i)*s;o.value=r,o.dispatchEvent(new Event("input"))}}}),t>=1){const i=document.getElementById("drumPattern");i&&this.morphTargets.has("drumPattern")&&(i.value=this.morphTargets.get("drumPattern"),i.dispatchEvent(new Event("change")));const a=document.getElementById("noiseType");a&&this.morphTargets.has("noiseType")&&(a.value=this.morphTargets.get("noiseType"),a.dispatchEvent(new Event("change")));const n=document.getElementById("arpPattern");n&&this.morphTargets.has("arpPattern")&&(n.value=this.morphTargets.get("arpPattern"),n.dispatchEvent(new Event("change")));const o=document.getElementById("chordProgression");o&&this.morphTargets.has("chordProgression")&&(o.value=this.morphTargets.get("chordProgression"),o.dispatchEvent(new Event("change")));const r=document.getElementById("chordVoicing");r&&this.morphTargets.has("chordVoicing")&&(r.value=this.morphTargets.get("chordVoicing"),r.dispatchEvent(new Event("change")));const c=document.getElementById("vocalVowel");c&&this.morphTargets.has("vocalVowel")&&(c.value=this.morphTargets.get("vocalVowel"),c.dispatchEvent(new Event("change")));const h=document.getElementById("sampleSelect");h&&this.morphTargets.has("sampleSelect")&&(h.value=this.morphTargets.get("sampleSelect"),h.dispatchEvent(new Event("change")));const l=document.getElementById("drumPatternMode");l&&this.morphTargets.has("drumPatternMode")&&(l.value=this.morphTargets.get("drumPatternMode"),l.dispatchEvent(new Event("change")));const d=document.getElementById("drumProbability");d&&this.morphTargets.has("drumProbability")&&(d.checked=this.morphTargets.get("drumProbability"),d.dispatchEvent(new Event("change"))),Object.keys(this.groupEnabled).forEach(u=>{const g=u+"Enable";if(this.morphTargets.has(g)){const m=document.getElementById(g);if(m){const f=this.morphTargets.get(g);m.checked!==f&&(m.checked=f,m.dispatchEvent(new Event("change")))}}}),["reverb","delay","droneFreq","droneFilter","droneDetune","glitchIntensity","glitchRate","bitCrush","drumTempo","drumDensity","drumSwing","bleepRange","bleepDuration","burstActivity","burstSpeed","fmCarrier","fmIndex","fmRatio","noiseFilter","noiseLevel","acidFreq","acidResonance","grainDensity","grainSize","grainPitch","spaceMelodyDensity","spaceMelodySpeed","spaceMelodyPortamento","spaceMelodyEcho","padFilterSweep","padShimmer","arpSpeed","arpGate"].forEach(u=>{const g=u+"Mod";if(this.morphTargets.has(g)){const m=this.morphTargets.get(g),f=document.querySelector(`.lfo-button[data-param="${u}"]`);if(f){const x=this.modulationModes.get(u)||"fixed";if(x!==m){const M=["fixed","lfo","random","other"],k=M.indexOf(x);let b=(M.indexOf(m)-k+4)%4;for(let C=0;C<b;C++)f.click()}}}}),this.morphing=!1,document.getElementById("morphButton").textContent="MORPH"}else requestAnimationFrame(()=>this.animateMorph())}toggleLFO(e,t){let s=this.modulationModes.get(e)||"fixed";this.cleanupModulation(e);const i=["fixed","lfo","random","other"],a=i.indexOf(s),n=i[(a+1)%i.length];switch(this.modulationModes.set(e,n),n){case"fixed":t.textContent="MOD",t.classList.remove("active","random","other");break;case"lfo":t.textContent="LFO",t.classList.add("active"),t.classList.remove("random","other"),this.startLFO(e);break;case"random":t.textContent="RND",t.classList.add("active","random"),t.classList.remove("other"),this.startRandomJumps(e);break;case"other":t.textContent="OTH",t.classList.add("active","other"),t.classList.remove("random"),this.startOtherModulation(e);break}}cleanupModulation(e){if(this.animatedParams.has(e)){const s=this.animatedParams.get(e);s.frameId&&cancelAnimationFrame(s.frameId),this.animatedParams.delete(e)}this.randomIntervals.has(e)&&(clearInterval(this.randomIntervals.get(e)),this.randomIntervals.delete(e));const t=document.getElementById(e);t&&t.classList.remove("animated","random-jump","other-mod")}startLFO(e){var s;const t=document.getElementById(e);if(t){t.classList.add("animated");const i=parseFloat((s=document.getElementById("droneLFO"))==null?void 0:s.value)||.5,a={min:parseFloat(t.min),max:parseFloat(t.max),speed:i,phase:0};this.animatedParams.set(e,a),this.animateLFOParameter(e,a)}}startRandomJumps(e){const t=document.getElementById(e);if(t){t.classList.add("random-jump");const s=setInterval(()=>{const i=parseFloat(t.min),a=parseFloat(t.max),n=Math.random()*(a-i)+i;t.value=n,t.dispatchEvent(new Event("input"))},500+Math.random()*1500);this.randomIntervals.set(e,s)}}startOtherModulation(e){const t=document.getElementById(e);if(t){t.classList.add("other-mod");const s=8;let i=0;const a=setInterval(()=>{const n=parseFloat(t.min),r=(parseFloat(t.max)-n)/s,c=n+i*r;t.value=c,t.dispatchEvent(new Event("input")),i=(i+1)%s},400);this.randomIntervals.set(e,a)}}animateLFOParameter(e,t){if(!this.animatedParams.has(e))return;const s=document.getElementById(e);if(!s)return;t.phase+=t.speed*.01;const i=t.min+(Math.sin(t.phase)+1)/2*(t.max-t.min);s.value=i,s.dispatchEvent(new Event("input")),t.frameId=requestAnimationFrame(()=>this.animateLFOParameter(e,t))}captureCurrentState(){const e={};return document.querySelectorAll('input[type="range"], select').forEach(t=>{t.id&&(e[t.id]=parseFloat(t.value)||0)}),e}async toggleRecording(){const e=document.getElementById("recordButton");if(this.isRecording)this.mediaRecorder.stop(),this.isRecording=!1,e.classList.remove("recording"),e.textContent="RECORD";else{const t=this.audioContext.createMediaStreamDestination();this.masterBus&&this.masterBus.nodes.output.connect(t);const s=["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/mp4"];let i="audio/webm";for(const a of s)if(MediaRecorder.isTypeSupported(a)){i=a;break}this.mediaRecorder=new MediaRecorder(t.stream,{mimeType:i}),this.recordedChunks=[],this.recordingMimeType=i,this.mediaRecorder.ondataavailable=a=>{a.data.size>0&&this.recordedChunks.push(a.data)},this.mediaRecorder.onstop=()=>{this.showExportDialog()},this.mediaRecorder.start(),this.isRecording=!0,e.classList.add("recording"),e.textContent="STOP REC"}}showExportDialog(){const e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(0, 0, 0, 0.8)",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="1000";const t=document.createElement("div");t.style.backgroundColor="#000",t.style.border="1px solid #fff",t.style.padding="2rem",t.style.textAlign="center";const s=document.createElement("h3");s.textContent="Export Recording",s.style.color="#fff",s.style.marginBottom="1.5rem",s.style.textTransform="uppercase",s.style.letterSpacing="0.1em";const i=document.createElement("div");i.style.display="flex",i.style.gap="1rem",i.style.justifyContent="center",i.style.flexWrap="wrap",[{label:"WAV",format:"wav",type:"audio/wav"},{label:"WebM",format:"webm",type:this.recordingMimeType},{label:"MP3*",format:"mp3",type:"audio/mpeg",note:"Requires conversion"}].forEach(({label:o,format:r,type:c,note:h})=>{const l=document.createElement("button");l.className="control-button secondary",l.textContent=o,l.style.minWidth="100px",l.addEventListener("click",()=>{r==="wav"?this.exportAsWAV():this.exportAsFormat(r,c),e.remove()}),h&&(l.title=h),i.appendChild(l)});const n=document.createElement("button");n.className="control-button secondary",n.textContent="CANCEL",n.style.marginTop="1rem",n.addEventListener("click",()=>{e.remove()}),t.appendChild(s),t.appendChild(i),t.appendChild(n),e.appendChild(t),document.body.appendChild(e)}exportAsFormat(e,t){const s=new Blob(this.recordedChunks,{type:t}),i=URL.createObjectURL(s),a=document.createElement("a");a.href=i,a.download=`audiogen_${new Date().toISOString().replace(/[:.]/g,"-")}.${e}`,a.click(),URL.revokeObjectURL(i)}async exportAsWAV(){const e=new Blob(this.recordedChunks,{type:this.recordingMimeType});try{const t=await e.arrayBuffer(),s=await this.audioContext.decodeAudioData(t),i=this.audioBufferToWav(s),a=URL.createObjectURL(i),n=document.createElement("a");n.href=a,n.download=`audiogen_${new Date().toISOString().replace(/[:.]/g,"-")}.wav`,n.click(),URL.revokeObjectURL(a)}catch(t){console.error("Error converting to WAV:",t),this.exportAsFormat("webm",this.recordingMimeType)}}audioBufferToWav(e){const t=e.numberOfChannels,s=e.sampleRate,i=1,a=16,n=a/8,o=t*n,r=[];for(let u=0;u<e.numberOfChannels;u++)r.push(e.getChannelData(u));const c=r[0].length,h=new ArrayBuffer(44+c*o),l=new DataView(h),d=(u,g)=>{for(let m=0;m<g.length;m++)l.setUint8(u+m,g.charCodeAt(m))};d(0,"RIFF"),l.setUint32(4,36+c*o,!0),d(8,"WAVE"),d(12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,i,!0),l.setUint16(22,t,!0),l.setUint32(24,s,!0),l.setUint32(28,s*o,!0),l.setUint16(32,o,!0),l.setUint16(34,a,!0),d(36,"data"),l.setUint32(40,c*o,!0);let p=44;for(let u=0;u<c;u++)for(let g=0;g<t;g++){const m=Math.max(-1,Math.min(1,r[g][u])),f=m<0?m*32768:m*32767;l.setInt16(p,f,!0),p+=2}return new Blob([h],{type:"audio/wav"})}startPerformanceMonitoring(){this.performanceMonitor=setInterval(()=>{const e=this.activeVoices/this.maxVoices;if(e>.8?this.performanceThrottle=.5:e>.6?this.performanceThrottle=.7:this.performanceThrottle=1,this.generators.drums&&this.generators.drums.setPerformanceThrottle(this.performanceThrottle),this.generators.granular&&this.generators.granular.setPerformanceThrottle(this.performanceThrottle),this.masterBus&&this.masterBus.updatePerformance(this.performanceThrottle),this.poolManager&&window.location.hostname==="localhost"){const t=this.poolManager.getAllStats();console.log("Voice Pool Performance:",{oscillator:`${t.oscillator.active} active, ${t.oscillator.available} pooled (${t.oscillator.poolEfficiency} reuse)`,gain:`${t.gain.active} active, ${t.gain.available} pooled (${t.gain.poolEfficiency} reuse)`,buffer:`${t.bufferSource.active} active, ${t.bufferSource.available} pooled (${t.bufferSource.poolEfficiency} reuse)`})}},1e3),this.activityMonitor=setInterval(()=>{this.updateActivityIndicators()},100)}updateActivityIndicators(){Object.keys(this.groupEnabled).forEach(e=>{const t=document.getElementById(e+"Activity"),s=t==null?void 0:t.closest(".section");if(t){const i=this.groupEnabled[e],a=this.generators[e];let n=!1;if(i&&a&&a.isPlaying){const o=document.getElementById(e+"Density")||document.getElementById(e+"Level")||document.getElementById(e+"Activity")||(e==="arpeggiator"?document.getElementById("arpEnable"):null);o?n=parseFloat(o.value)>0:e==="drone"&&(n=!0)}n?(t.classList.add("active"),s==null||s.classList.add("active")):(t.classList.remove("active"),s==null||s.classList.remove("active"))}})}toggleAutoMode(){var e;if(this.autoModeInterval){clearInterval(this.autoModeInterval),this.autoModeInterval=null;const t=document.getElementById("autoButton");t&&(t.classList.remove("active"),t.textContent="AUTO")}else{const t=document.getElementById("autoButton");t&&(t.classList.add("active"),t.textContent="AUTO ON");const s=parseFloat(((e=document.getElementById("autoChangeTime"))==null?void 0:e.value)||30)*1e3;this.randomize(),this.autoModeInterval=setInterval(()=>{this.randomize()},s)}}updateAutoModeInterval(){var e;if(this.autoModeInterval){clearInterval(this.autoModeInterval);const t=parseFloat(((e=document.getElementById("autoChangeTime"))==null?void 0:e.value)||30)*1e3;this.autoModeInterval=setInterval(()=>{this.randomize()},t)}}toggleLiteMode(){var e,t,s,i,a;if(this.liteMode){this.liteMode=!1;const n=document.getElementById("liteButton");if(n&&(n.classList.remove("active"),n.textContent="LITE MODE"),this.masterBus){const o=parseFloat(((e=document.getElementById("compressorMix"))==null?void 0:e.value)||100),r=parseFloat(((t=document.getElementById("distortionMix"))==null?void 0:t.value)||0),c=parseFloat(((s=document.getElementById("chorusMix"))==null?void 0:s.value)||0),h=parseFloat(((i=document.getElementById("reverb"))==null?void 0:i.value)||20)/100,l=parseFloat(((a=document.getElementById("delay"))==null?void 0:a.value)||0)/100;this.masterBus.compressor.setMix(o),this.masterBus.setDistortionMix(r),this.masterBus.setChorusMix(c),this.masterBus.setReverbMix(h),this.masterBus.setDelayMix(l)}this.poolManager&&(this.poolManager.setMaxPoolSize("oscillator",200),this.poolManager.setMaxPoolSize("gain",200),this.poolManager.setMaxPoolSize("bufferSource",100)),this.maxVoices=100}else{this.liteMode=!0;const n=document.getElementById("liteButton");n&&(n.classList.add("active"),n.textContent="LITE ON"),this.masterBus&&(this.masterBus.setDistortionMix(0),this.masterBus.setChorusMix(0),this.masterBus.setReverbMix(0),this.masterBus.setDelayMix(0)),this.poolManager&&(this.poolManager.setMaxPoolSize("oscillator",50),this.poolManager.setMaxPoolSize("gain",50),this.poolManager.setMaxPoolSize("bufferSource",25)),this.maxVoices=50}}showKeyboardHelp(){const e=`
Keyboard Shortcuts:
    
Space    - Play/Stop
R        - Randomize
M        - Morph
A        - Toggle Auto Mode
L        - Toggle Lite Mode
Esc      - Stop
? or H   - Show this help
        
Press any key to close this help.`,t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(0, 0, 0, 0.8)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="1000";const s=document.createElement("pre");s.style.color="#fff",s.style.backgroundColor="#000",s.style.border="1px solid #fff",s.style.padding="2rem",s.style.fontFamily="Monaco, Courier New, monospace",s.style.fontSize="14px",s.textContent=e,t.appendChild(s),document.body.appendChild(t);const i=a=>{a.preventDefault(),t.remove(),document.removeEventListener("keydown",i)};setTimeout(()=>{document.addEventListener("keydown",i)},100)}shareSettings(){const e={groups:{},params:{},selects:{}};Object.keys(this.groupEnabled).forEach(a=>{e.groups[a]=this.groupEnabled[a]}),document.querySelectorAll('input[type="range"]').forEach(a=>{a.id&&(e.params[a.id]=parseFloat(a.value))}),document.querySelectorAll("select").forEach(a=>{a.id&&(e.selects[a.id]=a.value)}),e.checkboxes={},document.querySelectorAll('input[type="checkbox"]').forEach(a=>{a.id&&!a.classList.contains("group-enable")&&(e.checkboxes[a.id]=a.checked)});const t=JSON.stringify(e),s=btoa(t),i=new URL(window.location.href);i.searchParams.set("preset",s),navigator.clipboard.writeText(i.toString()).then(()=>{const a=document.getElementById("shareButton");if(a){const n=a.textContent;a.textContent="COPIED!",setTimeout(()=>{a.textContent=n},2e3)}}).catch(a=>{console.error("Failed to copy URL:",a),prompt("Copy this URL to share your settings:",i.toString())})}loadSettingsFromURL(){const t=new URLSearchParams(window.location.search).get("preset");if(t)try{const s=atob(t),i=JSON.parse(s);i.groups&&Object.entries(i.groups).forEach(([a,n])=>{if(this.groupEnabled.hasOwnProperty(a)){this.groupEnabled[a]=n;const o=document.getElementById(a+"Enable");o&&(o.checked=n)}}),i.params&&Object.entries(i.params).forEach(([a,n])=>{const o=document.getElementById(a);o&&(o.value=n,o.dispatchEvent(new Event("input")))}),i.selects&&Object.entries(i.selects).forEach(([a,n])=>{const o=document.getElementById(a);o&&(o.value=n,o.dispatchEvent(new Event("change")))}),i.checkboxes&&Object.entries(i.checkboxes).forEach(([a,n])=>{const o=document.getElementById(a);o&&(o.checked=n,o.dispatchEvent(new Event("change")))}),console.log("Settings loaded from URL")}catch(s){console.error("Failed to load settings from URL:",s)}}getEnvelopeForGroup(e){if(this.adsrMode==="disabled")return null;if(this.adsrMode==="perGroup"){if(!this.groupEnvelopes.has(e)){const t=new R(this.audioContext);this.globalEnvelope&&t.setParameters(this.globalEnvelope.getParameters()),this.groupEnvelopes.set(e,t)}return this.groupEnvelopes.get(e)}return this.globalEnvelope}toggleVisualization(){console.log("toggleVisualization called"),this.dataMatrix||(this.dataMatrix=new Ce(document.body)),this.dataMatrix.toggle()}}return document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{console.log("Creating soundscape with toggleVisualization method"),window.soundscape=new z}):(console.log("Creating soundscape immediately with toggleVisualization method"),window.soundscape=new z),q.GenerativeSoundscape=z,Object.defineProperty(q,Symbol.toStringTag,{value:"Module"}),q}({});
